'use strict';(function(a){var b=!1,c=/\b_super\b/,d=function(){};d.extend=function(a){function d(){!b&&this.init&&this.init.apply(this,arguments)}var g=this.prototype;b=!0;var i=new this;b=!1;for(var h in a){var j=Object.getOwnPropertyDescriptor(a,h);j.get||j.set?Object.defineProperty(i,h,j):i[h]="function"==typeof a[h]&&"function"==typeof g[h]&&c.test(a[h])?function(a,b){return function(){var c=this._super;this._super=g[a];var d=b.apply(this,arguments);this._super=c;return d}}(h,a[h]):a[h]}d.prototype=
i;d.prototype.constructor=i.init;d.extend=this.extend;return d};a.Class=d;a.Class=d})("undefined"!==typeof window?window:global);var mighty=window.mighty={};
mighty.Error={init:function(){this.errorBox=document.getElementById("mightyError");this.errorLog=this.errorBox.getElementsByTagName("ul")[0];var a=this;window.onerror=function(b,c,d){a.showErrorSilent(c+": "+d,b)}},submit:function(a,b){this.showError(a,b)},error:this.submit,warning:function(a,b){var c="",c=a&&a.length?b&&b.length?"["+a+"] - (Warning) "+b:a:b;console.error(c)},showError:function(a,b){var c="",c=a&&a.length?b&&b.length?"["+a+"] - "+b:a:b;if(this.isShowErrorBox&&this.errorLog){var d=
document.createElement("li");d.innerText=c;this.errorLog.appendChild(d);this.errorBox.style.display="block"}console.error(c)},showErrorSilent:function(a,b){var c="",c=a&&a.length?b&&b.length?"["+a+"] - "+b:a:b;if(this.isShowErrorBox&&this.errorLog){var d=document.createElement("li");d.innerText=c;this.errorLog.appendChild(d);this.errorBox.style.display="block"}},errorBox:null,errorLog:null,isShowErrorBox:!0};mighty.Error.init();window.Channel={};
window.Channel.Base=function(a){this.updatePriority=function(){this.subscribers.sort(this._func_priority)};this.subscribe=function(a,c,d){"object"!==typeof a?mighty.Error.submit("Channel.subscribe","Error: 'owner' is not an object."):(void 0===d&&(d=0),a=new Channel.Subscriber(a,c,d),this.subscribers.push(a),this.numSubscribers++,this.updatePriority())};this.unsubscribe=function(a){for(var c=0;c<this.numSubscribers;++c)this.subscribers[c].owner===a&&(this.subscribers[c]=this.subscribers[this.numSubscribers-
1],this.subscribers.pop(),this.numSubscribers--);this.updatePriority()};this.signal=function(a,c){for(var d=0;d<this.numSubscribers;++d)this.subscribers[d].func(a,c)};this.signalBreakable=function(a,c){for(var d=0;d<this.numSubscribers&&!this.subscribers[d].func(a,c);++d);};this.ask=function(a,c){this.mutex=!0;for(var d=0;d<this.numSubscribers;++d){var e=this.subscribers[d].func(a,c);if(void 0!==e)return this.mutex=!1,e}this.mutex=!1;this.numTempSubscribers&&this._updateTempBuffer();return null};
this._func_priority=function(a,c){return c.priority-a.priority};this._updateTempBuffer=function(){};this.name=a;this.subscribers=[];this.numSubscribers=0;this.mutex=!1;this.tempSubscribers=null;this.numTempSubscribers=0};window.Channel.Subscriber=function(a,b,c){this.owner=a;this.func=b;this.priority=c};window.Channel.Event=function(a,b){this.type=a;this.obj=b};window.Channels={};
window.CreateChannel=function(a){if(a){var b=Channels[a];if(void 0!==b)return b;b=new Channel.Base(a);return Channels[a]=b}};window.RemoveChannel=function(a){a&&(Channels[a.name]=null)};
window.SubscribeChannel=function(a,b,c,d){if("object"!==typeof a)mighty.Error.submit("SubscribeChannel","Error: 'owner' is not an object.");else{var e=null;if("string"===typeof b)e=Channels[b],void 0===e&&(e=CreateChannel(b));else{if(!b||void 0===b.signal){mighty.Error.submit("SubscribeChannel","Error: Invalid 'channel' object.");return}e=b}e.subscribe(a,c,d);return e}};window.UnsubscribeChannel=function(a,b){var c=Channels[b];if(void 0===c)return null;c.unsubscribe(a)};
window.GetChannel=function(a){a=Channels[a];return void 0===a?null:a};window.SendSignal=function(a,b,c){a=Channels[a];if(void 0===a)return null;a.signal(b,c)};window.Ask=function(a,b,c){a=Channels[a];return void 0===a?null:a.ask(b,c)};mighty.TemplateCSS=function(a,b,c){this.init=function(){this.path=gParams.path||Resource.Cfg.path;for(var d in a)this.setBackground(d,a[d]);this.src=b;c&&!b&&(this.fullText+="\r\n"+c);this.appendStyles()};this.init()};
mighty.TemplateCSS.prototype={setStyle:function(a,b){this.fullText+=a+" { "+b+"}"},getTexture:function(a){return mighty.Macro.GetTextureByName(a)},setBackground:function(a,b){var c=this.getTexture(b);c?this.setStyle(a,"background-image:url('"+this.path+"/default/img/"+c.id+"."+c.ext+"');"):console.error("Cannot find resource!!",b)},removeStyles:function(){this.style.parentNode&&this.style.parentNode.removeChild(this.style);this.isVisible=1},appendStyles:function(){if(!this.style||this.isVisible)this.isVisible=
1,this.src?(this.style=document.createElement("link"),this.style.rel="stylesheet",this.style.type="text/css",this.style.setAttribute("href",this.src)):(this.style=document.createElement("style"),this.style.type="text/css",this.style.styleSheet?this.style.styleSheet.cssText=this.fullText:this.style.appendChild(document.createTextNode(this.fullText)));document.getElementsByTagName("head")[0].appendChild(this.style)},style:null,src:null,fullText:"",isVisible:0};mighty.Templates={};
mighty.TemplateJS={};
mighty.Template={init:function(){var a=this;SubscribeChannel(this,"i18n.OUT",function(b){return b===i18n.Event.LANG_CHANGED?(a.updateLang(),!0):!1})},create:function(a,b){void 0===b&&(b=!0);var c=document.createElement("div");c.setAttribute("id","view-"+a);c=new mighty.TemplateItem(a,c);c.rootPath=this.rootPath;b&&c._loadCSS();c._getJS();return mighty.Templates[a]=c},remove:function(a){mighty.Templates[a]&&(mighty.Templates[key].hide(),delete mighty.Templates[key]);mighty.TemplateJS[a]&&delete mighty.TemplateJS[key]},
removeAll:function(){for(var a in mighty.Templates)mighty.Templates[a].hide(),delete mighty.Templates[a],delete mighty.TemplateJS[a]},updateLang:function(){var a=mighty.Templates,b;for(b in a)a[b].updateFromCache()},rootPath:"src/templates"};
mighty.TemplateItem=function(a,b){this.__defineSetter__("html",function(a){this.isAppended&&this.holder.parentNode&&this.holder.parentNode.removeChild(this.holder);this.cache=[];this.innerHTML=i18n.plugin.processWithCacheHTML(a,this.cache);this._parseVar();this.isAppended&&(this.holder.innerHTML="",this.holder.appendChild(this.innerHTML),this.appendElement?mighty.engine.appendElement.appendChild(this.holder):mighty.engine.domElement.appendChild(this.holder))});this.__defineGetter__("html",function(){return this.innerHTML});
this.name=a;this.innerHTML=null;this.holder=b;this.cache=this.js=null;this.data={};this.properties={};this.appendElement=null;this.isAppended=this.isShow=this.inProgress=this.isLoaded=!1;this.rootPath="";this._script=this._css=null};
mighty.TemplateItem.prototype={show:function(a){void 0!==a&&(this.appendElement=a);this.isShow||(this.isShow=!0,this.isLoaded&&this._append())},hide:function(){this.isShow&&(this.isShow=!1,this.isLoaded&&this._remove())},setVisible:function(a){a?this.show():this.hide()},update:function(){this.html=this.html},addCSS:function(a){a=mighty.Template.rootPath+"/"+this.name+"/css/"+a+".css";$("head").append("<link rel='stylesheet' href="+a+" type='text/css' />")},_loadCSS:function(){var a=this.rootPath+
"/"+this.name+"/css/"+this.name+".css";this._css=Resource.Templates[this.name]&&Resource.Templates[this.name].css&&gParams.rel?new mighty.TemplateCSS(null,null,Resource.Templates[this.name].css):new mighty.TemplateCSS(null,a)},_getJS:function(){var a=this,b=function(){a.js=new mighty.TemplateJS[a.name](a);a.js.ui=a;a._getHTML(d)};if(Resource.Templates[this.name]&&gParams.release){try{eval(Resource.Templates[a.name].js)}catch(c){console.error(c)}b()}else{var d=mighty.Template.rootPath;$.ajax({type:"GET",
url:mighty.Template.rootPath+"/"+this.name+"/"+this.name+".js",context:this,success:function(){b()},error:function(){a.html=""},dataType:"script"})}},_getHTML:function(a){var b=this,c=function(a){b.txt=a;b.html=a;b.isLoaded=!0;b.inProgress=!1;void 0!==b.js.init&&b.js.init();b.isShow&&b._append()};Resource.Templates[this.name]&&gParams.rel?c(Resource.Templates[this.name].html):$.ajax({type:"GET",url:a+"/"+this.name+"/"+this.name+".html",context:this,success:function(a){c(a)},error:function(){b.html=
""},dataType:"html"})},_parseVar:function(){for(var a={},b=null,c="",d=this.html.querySelectorAll("[data-var]"),e=d.length,f=0;f<e;f++)b=d[f],c=b.getAttribute("data-var"),a[c]=b,this.data[c]&&(a[c].innerText=i18n.plugin.processText(this.data[c])),this._defineAttribute(a,c,b);for(var g in a)this.properties[g]=a[g]},_defineAttribute:function(a,b,c){var d=void 0,e=Object.getOwnPropertyDescriptor(this.data,b);e&&void 0===e.set&&(d=this.data[b]);Object.defineProperty(this.data,b,{get:function(){return a[b].innerText},
set:function(c){a[b].innerText=i18n.plugin.processText(c)}});void 0!==d&&(this.data[b]=d,c.prevValue=d,this.cache.push(c),console.log("cache",this.data[b]))},getTemplate:function(){this.inProgress||(this.inProgress=!0,this._getHTML())},_append:function(){this.holder.innerHTML="";this.holder.appendChild(this.innerHTML);this.appendElement?mighty.engine.appendElement.appendChild(this.holder):mighty.engine.domElement.appendChild(this.holder);this._css&&!this._css.isVisible&&this._css.removeStyles();if(void 0!==
this.js.onShow)this.js.onShow();this.isAppended=!0},_remove:function(){if(void 0!==this.js.onShow)this.js.onShow();this.holder.parentNode&&this.holder.parentNode.removeChild(this.holder);this._script&&this._script.parentNode&&this._script.parentNode.removeChild(this._script);this.isAppended=!1},setParameter:function(a,b){var c=this.properties[a];void 0!==c&&c.innerText?c.innerText=i18n.plugin.processText(b):this.properties[a]=i18n.plugin.processText(b)},updateFromCache:function(){for(var a=i18n.plugin,
b=null,c=this.cache.length,d=0;d<c;d++)b=this.cache[d],b.nodeValue?b.nodeValue=a.processText(b.prevValue):b.innerText=a.processText(b.prevValue)}};mighty.UI=mighty.Templates;
mighty.Browser={load:function(){var a={Chrome:[/Chrome\/(\S+)/],Firefox:[/Firefox\/(\S+)/],MSIE:[/MSIE (\S+);/],Opera:[/Opera\/.*?Version\/(\S+)/,/Opera\/(\S+)/],Safari:[/Version\/(\S+).*?Safari\//]},b=navigator.userAgent,c,d,e=2;for(c in a)for(;d=a[c].shift();)if(d=b.match(d)){this.version=d[1].match(RegExp("[^.]+(?:.[^.]+){0,"+--e+"}"))[0];this.name=c.toLowerCase();console.log(c+" "+this.version);this.versionBuffer=this.version.split(".");d=this.versionBuffer.length;for(var f=0;f<d;f++)this.versionBuffer[f]=
parseInt(this.versionBuffer[f]);break}null===this.versionBuffer||"unknown"===this.name?console.log("(Warning) Could not detect browser."):this._loadSupport()},_loadSupport:function(){this._checkCanvas();this._checkWebAudio()},_checkCanvas:function(){var a=document.createElement("canvas");a.getContext&&a.getContext("2d")&&(this.support.canvas=!0)},_checkWebAudio:function(){"chrome"===this.name&&10<=this.versionBuffer[0]&&(this.support.webAudioAPI=!0);"safari"===this.name&&6<=this.versionBuffer[0]&&
(this.support.webAudioAPI=!0)},isSupport:function(a){return void 0!==this.support[a]?!0:!1},name:"Unknown",version:"0",versionBuffer:null,support:{}};mighty.Browser.load();
mighty.Loader={init:function(){this.elements=[];var a=this;SubscribeChannel(this,"Loader",function(b,c){a.handleSignal_Loader(b,c)})},load:function(a){this.isLoading=!0;this.cbFunc=a;this.loadNext()},loadNext:function(){if(0==this.includes.length)$("script").remove(),this.cbFunc();else{var a=this,b=this.includes.shift();window.getScript(b,function(){a.loadNext()})}},include:function(a){this.includes.push(this.rootPath+this.path+a)},handleSignal_Loader:function(a,b){var c=mighty.Event;switch(a){case c.UPDATE_ELEMENT:this.updateElement(b);
break;case c.ADD_ELEMENT:this.addElement(b);break;case c.GET_ELEMENT:this.getElement(b)}},updateElement:function(a){var b=a.numItems-a._itemsFixed,c=a.numItemsLoaded-a._itemsLoadedFixed;a.update();this.numItems+=b;this.numItemsLoaded+=c;this.percents+=c*a.percentsPerItem*this.powerModifier;this.setPercents(this.percents);100<=this.percents&&(this.percents=100,this.isLoading=!1)},addElement:function(a){this.elements.push(a);this.totalPower+=a.amount;this.powerModifier=1;this.updateElement(a)},getElement:function(a){for(var b,
c=this.elements.length,d=0;d<c;d++)if(b=this.elements[d],b.name===a)return b;return null},_updateLoading:function(){},setPercents:function(a){a=Math.round(a);this.isLoading&&(this.loadingPercent&&this.loadingPercent.text(a),this.loadingBar&&(this.loadingBar.style.width=a+"%"))},setLabel:function(){this.isLoadingInit&&this.loadingLabel&&this.loadingLabel.text("LOADING")},set isLoading(a){this._isLoading=a;if(this._template)if(a)this._template.show(),this.setPercents(this.percents);else if(this._template.hide(),
this._template.js.onHide)this._template.js.onHide()},get isLoading(){return this._isLoading},set template(a){this._template=a;this.isLoading=this.isLoading},get template(){return this._template},includes:[],path:"",rootPath:"",cbFunc:null,elements:null,fixedItems:0,loaderItem:null,numItems:0,numItemsLoaded:0,totalPower:0,powerModifier:0,percents:0,_isLoading:!1,_template:null,loadingPercent:null,loadingBar:null,loadingLabel:null};
mighty.Loader.Element=function(a,b,c){this.update=function(){this._itemsFixed=this.numItems;this._itemsLoadedFixed=this.numItemsLoaded;0!==this.numItems&&(this.percentsPerItem=this.amount/this.numItems)};this.name=a;this.numItems=b;this._itemsLoadedFixed=this._itemsFixed=this.numItemsLoaded=0;void 0===c&&(c=100);this.amount=c;this.percentsPerItem=0};mighty.Loader.init();window.gParams=window.gParams||{};
(function(){for(var a=window.location.href.split("?").pop().split("&"),b=0;b<a.length;b++){var c=a[b].split("=");1<c.length&&(window.gParams[c[0]]=c[1])}})();var tempObj={},key;for(key in Engine)tempObj[key]=Engine[key];
mighty.engine={init:function(a){if(!mighty.Browser.isSupport("canvas"))return mighty.Error.submit("Your browser does not support canvas element. Please consider to update your web browser."),!1;this.initUI(a);console.log(this.name+": "+this.version);this.chn_Engine=CreateChannel("Engine");this._loadExtensions();this.initCfg();this.updateWindowSize();this.context1.save();mighty.context=this.context1;mighty.canvas=this.canvas1;this.initStyles();this.initEvents();return!0},_loadExtensions:function(){this.extensions=
["webkit","moz","ms","opera"]},initCfg:function(){Engine.Cfg.tUpdateDeltaF=Engine.Cfg.tUpdateDelta/1E3},initStyles:function(){this.parentElement.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)";this.parentElement.style["user-select"]="none"},clear:function(){this.context1.clearRect(0,0,this.width*mighty.camera.zoom,this.height*mighty.camera.zoom)},pushRenderTarget:function(a){this.prevRenderTarget=mighty.context;mighty.context=a},popRenderTarget:function(){mighty.context=this.prevRenderTarget},
updateWindowSize:function(){this.width=this.parentElement.offsetWidth;this.height=this.parentElement.offsetHeight;0==this.height&&(this.height=window.innerHeight);0==this.width&&(this.width=window.innerWidth);this.canvas1.width=this.width;this.canvas1.height=this.height},handleInput:function(a,b){if(!this.blockInput&&this.subscriber)switch(a){case "mouseMove":case "mouseDown":case "mouseUp":case "mouseClick":case "mouseDbClick":var c=$(this.parentElement).offset();this.subscriber.handleInput(a,b,
b.button,b.pageX-c.left,b.pageY-c.top);break;case "touchStart":case "touchEnd":case "touchMove":case "touchCancel":b.preventDefault();this.subscriber.handleInput(a,b);break;case "keyDown":case "keyUp":this.subscriber.handleInput(a,b,b.keyCode,0,0)}},onResize:function(){this.updateWindowSize();null!==this.subscriber&&this.subscriber.handleResize(this.width,this.height);this.chn_Engine.signal(Engine.Event.RESIZE,this)},setCamera:function(a){mighty.camera=a;this.chn_Engine.signal(Engine.Event.CAMERA,
a)},setZoom:function(a){this.context1.restore();this.context1.save();this.context1.scale(a,a);this.chn_Engine.signal(Engine.Event.ZOOM,this.zoom)},onVisibilityChange:function(){switch(document.webkitVisibilityState){case "visible":window.top===window?this.setFocus(!0):this.setFocus(!1);this.setVisible(!0);break;case "hidden":this.setFocus(!1),this.setVisible(!1)}},subscribe:function(a){this.subscriber=a},CanvasLayer:function(a,b){this.canvas=mighty.engine.createLayer("canvas",a,b);this.context=this.canvas.getContext("2d")},
createLayer:function(a,b,c){a=document.createElement(a);b&&(a.style.cssText=b);c&&c.appendChild(a);return a},initUI:function(a){"string"===typeof a&&(a=document.getElementById(a));this.parentElement=a?a:this.createLayer("div","width: 100%; height: 100%; position: absolute; left: 0; top: 0;",document.body);this.canvasElement=this.createLayer("div","width: 100%; height: 100%; position: absolute; left: 0; top: 0;");this.canvasElement.setAttribute("id",this.canvasElementID);this.domElement=this.createLayer("div",
"width: 100%; height: 100%; position: absolute; left: 0; top: 0;");this.domElement.setAttribute("id",this.uiElementID);a=new this.CanvasLayer("width: 100%; height: 100%; position: absolute; left: 0; top: 0;",this.canvasElement);this.canvas1=a.canvas;this.context1=a.context;this.parentElement.appendChild(this.canvasElement);this.parentElement.appendChild(this.domElement)},initEvents:function(a){var b=this;this.canvasInput=a?window:this.parentElement;this.canvasInput=this.domElement;this.loadIgnoreKeys();
this.canvasInput.onmousemove=function(a){b.handleInput("mouseMove",a)};this.canvasInput.onmousedown=function(a){b.handleInput("mouseDown",a)};this.canvasInput.onmouseup=function(a){b.handleInput("mouseUp",a)};this.canvasInput.onclick=function(a){b.handleInput("mouseClick",a)};this.canvasInput.ondblclick=function(a){b.handleInput("mouseDbClick",a)};this.canvasInput.ontouchstart=function(a){b.handleInput("touchStart",a)};this.canvasInput.ontouchend=function(a){b.handleInput("touchEnd",a)};this.canvasInput.ontouchmove=
function(a){b.handleInput("touchMove",a)};this.canvasInput.ontouchcancel=function(a){b.handleInput("touchCancel",a)};window.onfocus=function(){b.setFocus(!0)};window.onblur=function(){b.setFocus(!1)};window.onresize=function(){b.onResize()};window.onorientationchange=function(){b.onResize()};$(document).bind("keydown",function(a){b.handleInput("keyDown",a);window.top&&b.iFrameKeys[a.keyCode]&&a.preventDefault();void 0!==b.cmdKeys[a.keyCode]&&b.numCmdKeys++;void 0===b.ignoreKeys[a.keyCode]&&0>=b.numCmdKeys&&
Input.Cfg.preventDefault&&a.preventDefault()});$(document).bind("keyup",function(a){b.handleInput("keyUp",a);window.top&&b.iFrameKeys[a.keyCode]&&a.preventDefault();void 0!==b.cmdKeys[a.keyCode]&&this.numCmdKeys--;void 0===b.ignoreKeys[a.keyCode]&&0>=b.numCmdKeys&&Input.Cfg.preventDefault&&a.preventDefault()});-1<navigator.userAgent.toLowerCase().indexOf("chrome")?(this.onVisibilityChange(),document.addEventListener("webkitvisibilitychange",function(){b.onVisibilityChange()},!1)):(window.onfocus=
function(){b.setFocus(!0);b.setVisible(!0)},window.onblur=function(){b.setFocus(!1);b.setVisible(!1)})},setFocus:function(a){this.isFocus!==a&&(this.isFocus=a,this.chn_Engine.signal(Engine.Event.FOCUS,a))},setVisible:function(a){this.isVisible=a},loadIgnoreKeys:function(){this.ignoreKeys=[];this.ignoreKeys[8]=1;this.ignoreKeys[9]=1;this.ignoreKeys[13]=1;this.ignoreKeys[17]=1;this.ignoreKeys[91]=1;this.ignoreKeys[38]=1;this.ignoreKeys[39]=1;this.ignoreKeys[40]=1;this.ignoreKeys[37]=1;this.ignoreKeys[112]=
1;this.ignoreKeys[113]=1;this.ignoreKeys[114]=1;this.ignoreKeys[115]=1;this.ignoreKeys[116]=1;this.ignoreKeys[117]=1;this.ignoreKeys[118]=1;this.ignoreKeys[119]=1;this.ignoreKeys[120]=1;this.ignoreKeys[121]=1;this.ignoreKeys[122]=1;this.ignoreKeys[123]=1;this.ignoreKeys[124]=1;this.ignoreKeys[125]=1;this.ignoreKeys[126]=1;this.cmdKeys=[];this.cmdKeys[91]=1;this.cmdKeys[17]=1;this.iFrameKeys=[];this.iFrameKeys[37]=1;this.iFrameKeys[38]=1;this.iFrameKeys[39]=1;this.iFrameKeys[40]=1},name:"MightyEngine",
version:"1.0v",cfg:null,params:null,canvas1:null,context1:null,currLayer:null,layer1:null,layer2:null,canvasInput:null,prevRenderTarget:null,parentElement:null,canvasElement:null,domElement:null,width:800,height:600,zoom:1,subscriber:null,blockInput:!1,ignoreKeys:null,cmdKeys:null,iFrameKeys:null,numCmdKeys:0,filter:null,isVisible:!0,isFocus:!1,canvasElementID:"canvas-view",uiElementID:"ui-view",extensions:null,chn_Engine:null};mighty.canvas=null;mighty.context=null;mighty.camera=null;
for(key in tempObj)Engine[key]=tempObj[key];tempObj=void 0;mighty.EmptyFunc=function(){};window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}());window.LoadJSON=function(a,b){$.ajax({type:"GET",url:a,dataType:"json",success:b})};window.CloneJSON=function(a,b){for(var c in a)b[c]=a[c]};
window.IsDefined=function(a){return"undefined"!==typeof a&&null!==a};window.IsEqual=function(a,b){return 1E-12>Math.abs(a-b)?!0:!1};function NullResize(a,b){a.length=b;for(var c=a.length;c<b;c++)a[c]=null}function IsObjectEmpty(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}
window.Palette=Class.extend({init:function(a){this.name=a;this.items=[]},add:function(a){null===a||"undefined"===typeof a?console.log("(warning) Palette: Adding undefined item."):(this.cachedItem=a,this.items.push(a),this.numItems++)},getByID:function(a){if(0===this.numItems)return null;if(this.cachedItem.id===a)return this.cachedItem;for(var b=0;b<this.numItems;++b){var c=this.items[b];if(c.id===a)return this.cachedItem=c}return null},getByName:function(a){if(0===this.numItems)return null;if(this.cachedItem.name===
a)return this.cachedItem;for(var b=0;b<this.numItems;++b){var c=this.items[b];if(c.name===a)return this.cachedItem=c}return null},getByType:function(a){for(var b=[],c=0;c<this.numItems;c++){var d=this.items[c];d.type===a&&b.push(d)}return b},name:"",items:null,numItems:0,cachedItem:null});window.Palettes={};function ToRadians(a){return a*Math.PI/180}function ToDegree(a){return 180*a/Math.PI}function RadiansToPoint(a,b,c,d){return Math.atan((c-a)/(d-b))}
function Length2(a,b){return Math.sqrt(a*a+b*b)}function lookAt(a,b,c,d){return-Math.atan2(c-a,b-d)}function lookAtEntity(a,b){return lookAt(a.x,a.y,b.x,b.y)}function AABB(a,b,c,d){this.minX=a;this.minY=b;this.maxX=c;this.maxY=d}
AABB.prototype={translate:function(a,b){this.minX+=a;this.minY+=b;this.maxX+=a;this.maxY+=b},move:function(a,b){var c=this.maxX-this.minX,d=this.maxY-this.minY;this.minX=a;this.minY=b;this.maxX=a+c;this.maxY=b+d},resize:function(a,b){this.maxX=this.minX+a;this.maxY=this.minY+b},copy:function(a){this.minX=a.minX;this.minY=a.minY;this.maxX=a.maxX;this.maxY=a.maxY},vsAABB:function(a){return this.minX>a.maxX||this.maxX<a.minX||this.minY>a.maxY||this.maxY<a.minY?!1:!0},vsBorderAABB:function(a){return this.minX>=
a.maxX||this.maxX<=a.minX||this.minY>=a.maxY||this.maxY<=a.minY?!1:!0},vsPoint:function(a,b){return this.minX>a||this.maxX<a||this.minY>b||this.maxY<b?!1:!0},vsBorderPoint:function(a,b){return this.minX>=a||this.maxX<=a||this.minY>=b||this.maxY<=b?!1:!0},getSqDistance:function(a,b){var c,d=0;a<this.minX&&(c=this.minX-a,d+=c*c);a>this.maxX&&(c=a-this.maxX,d+=c*c);b<this.minY&&(c=this.minY-b,d+=c*c);b>this.maxY&&(c=b-this.maxY,d+=c*c);return d},isUndefined:function(){return void 0===this.maxY},draw:function(a){var b=
Math.floor(this.minX),c=Math.floor(this.minY),d=Math.floor(this.maxX),e=Math.floor(this.maxY);a.beginPath();a.moveTo(b-0.5,c-0.5);a.lineTo(d+0.5,c-0.5);a.lineTo(d+0.5,e+0.5);a.lineTo(b-0.5,e+0.5);a.lineTo(b-0.5,c-0.5);a.stroke()},drawTranslated:function(a){var b=mighty.camera;this.translate(b.x,b.y);this.draw(a);this.translate(-b.x,-b.y)},print:function(a){a?console.log(a+" x: "+this.minX+" y: "+this.minY+" z: "+this.maxX+" w: "+this.maxY):console.log("x: "+this.minX+" y: "+this.minY+" z: "+this.maxX+
" w: "+this.maxY)}};function Vector2(a,b){this.x=a;this.y=b}
Vector2.prototype={reset:function(){this.y=this.x=0},set:function(a,b){this.x=a;this.y=b},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var a=Math.sqrt(this.x*this.x+this.y*this.y);this.x/=a;this.y/=a},truncate:function(a){Math.sqrt(this.x*this.x+this.y*this.y)>a&&(this.normalize(),this.x*=a,this.y*=a)},print:function(a){a?console.log('[vec "'+a+'"] x: '+this.x+" y: "+this.y):console.log("[vec] x: "+this.x+" y: "+this.y)}};
function Vector4(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d}function Matrix3(){this.m=new Float32Array(9)}Matrix3.prototype={};
function Sphere(a,b,c){this.move=function(a,b){this.x=a+this.radius;this.y=b+this.radius};this.translate=function(a,b){this.x+=a;this.y+=b};this.vsSphere=function(a){var b=this.x-a.x,c=this.y-a.y,a=this.radius+a.radius;return b*b+c*c<a*a};this.vsPoint=function(a,b){var c=Math.abs(this.x-a),g=Math.abs(this.y-b);return c<this.radius&&g<this.radius};this.vsBorderPoint=function(a,b){var c=Math.abs(this.x-a),g=Math.abs(this.y-b);return c<=this.radius&&g<=this.radius};this.vsAABB=function(a){return a.getSqDistance(this.x,
this.y)<this.radius*this.radius};this.vsBorderAABB=function(a){return a.getSqDistance(this.x,this.y)<=this.radius*this.radius};this.draw=function(a){a.beginPath();a.arc(this.x,this.y,this.radius,0,2*Math.PI,!1);a.stroke()};this.drawTranslated=function(a){var b=mighty.camera;this.translate(b.x,b.y);this.draw(a);this.translate(-b.x,-b.y)};this.x=a;this.y=b;this.radius=c}
mighty.Random=function(){this.init=function(){this.setSeed(3456789012,!0)};this.generate=function(){var a=this.a*(this.seed%this.q)-this.r*Math.floor(this.seed/this.q);this.seed=0<a?a:a+this.m;return this.seed*this.oneOverM};this.getNumber=function(a,b){var c=this.generate();return Math.round((b-a)*c+a)};this.getNumberF=function(a,b){var c=this.generate();return(b-a)*c+a};this.setSeed=function(a,b){"undefined"!==typeof b&&(b=!0);if(!0===b){var c=new Date;this.seed=a+16777215*c.getSeconds()+65535*
c.getMinutes()}else this.seed=a;this.a=48271;this.m=2147483647;this.q=Math.floor(this.m/this.a);this.r=this.m%this.a;this.oneOverM=1/this.m};this.oneOverM=this.r=this.q=this.m=this.a=this.seed=0;this.init()};window.Random=new mighty.Random;function DrawAABB(a,b,c,d){this.minX=a;this.minY=b;this.maxX=c;this.maxY=d;this.sizeX=c-a;this.sizeY=d-b;this.x=this.minX+this.sizeX/2;this.y=this.minY+this.sizeY/2}
DrawAABB.prototype={translate:function(a,b){this.minX+=a;this.minY+=b;this.maxX+=a;this.maxY+=b},move:function(a,b){this.minX=a;this.minY=b;this.maxX=a+this.sizeX;this.maxY=b+this.sizeY},resize:function(a,b){this.sizeX=a;this.sizeY=b;this.maxX=this.minX+this.sizeX;this.maxY=this.minY+this.sizeY},addDiff:function(a,b){this.minX-=a;this.minY-=b;this.sizeX+=a+a;this.sizeY+=b+b;this.maxX=this.minX+this.sizeX;this.maxY=this.minY+this.sizeY},copy:function(a){this.minX=a.minX;this.minY=a.minY;this.maxX=
a.maxX;this.maxY=a.maxY},copyAll:function(a){this.minX=a.minX;this.minY=a.minY;this.maxX=a.maxX;this.maxY=a.maxY;this.sizeX=a.sizeX;this.sizeY=a.sizeY},vsAABB:function(a){return this.minX>a.maxX||this.maxX<a.minX||this.minY>a.maxY||this.maxY<a.minY?!1:!0},vsBorderAABB:function(a){return this.minX>=a.maxX||this.maxX<=a.minX||this.minY>=a.maxY||this.maxY<=a.minY?!1:!0},vsPoint:function(a,b){return this.minX>a||this.maxX<a||this.minY>b||this.maxY<b?!1:!0},vsBorderPoint:function(a,b){return this.minX>=
a||this.maxX<=a||this.minY>=b||this.maxY<=b?!1:!0},getSqDistance:function(a,b){var c,d=0;a<this.minX&&(c=this.minX-a,d+=c*c);a>this.maxX&&(c=a-this.maxX,d+=c*c);b<this.minY&&(c=this.minY-b,d+=c*c);b>this.maxY&&(c=b-this.maxY,d+=c*c);return d},isUndefined:function(){return void 0===this.maxY},draw:function(a){var b=Math.floor(this.minX),c=Math.floor(this.minY),d=Math.floor(this.maxX),e=Math.floor(this.maxY);a.beginPath();a.moveTo(b-0.5,c-0.5);a.lineTo(d+0.5,c-0.5);a.lineTo(d+0.5,e+0.5);a.lineTo(b-
0.5,e+0.5);a.lineTo(b-0.5,c-0.5);a.stroke()},drawTranslated:function(a){var b=mighty.camera;this.translate(b.x,b.y);this.draw(a);this.translate(-b.x,-b.y)},print:function(a){a?console.log(a+" x: "+this.minX+" y: "+this.minY+" z: "+this.maxX+" w: "+this.maxY):console.log("x: "+this.minX+" y: "+this.minY+" z: "+this.maxX+" w: "+this.maxY)}};function BinaryHeap(a){this.content=[];this.length=0;this.scoreFunction=a}
BinaryHeap.prototype={push:function(a){this.content.push(a);this.length++;this.sinkDown(this.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();this.length--;0<this.length&&(this.content[0]=b,this.bubbleUp(0));return a},remove:function(a){var b=this.content.indexOf(a),c=this.content.pop();this.length--;b!==this.numConents-1&&(this.content[b]=c,this.scoreFunction(c)<this.scoreFunction(a)?this.sinkDown(b):this.bubbleUp(b))},rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},
sinkDown:function(a){for(var b=this.content[a];0<a;){var c=(a+1>>1)-1,d=this.content[c];if(this.scoreFunction(b)<this.scoreFunction(d))this.content[c]=b,this.content[a]=d,a=c;else break}},bubbleUp:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=a+1<<1,f=e-1,g=null;if(f<b){var i=this.scoreFunction(this.content[f]);i<d&&(g=f)}if(e<b&&this.scoreFunction(this.content[e])<(null===g?d:i))g=e;if(null!==g)this.content[a]=this.content[g],this.content[g]=c,a=g;else break}}};
var ByteBuffer=Class.extend({init:function(a){this.data=Array(a);this.length=a;for(a=0;a<this.length;++a)this.data[a]=0},writeByte:function(a){this.data[this.offset]=a&255;this.offset++},writeShort:function(a){this.data[this.offset+1]=a&255;this.data[this.offset]=a>>8&255;this.offset+=2},writeInt:function(a){this.data[this.offset+3]=a&255;a>>=8;this.data[this.offset+2]=a&255;a>>=8;this.data[this.offset+1]=a&255;this.data[this.offset]=a>>8&255;this.offset+=4},readByte:function(){var a=this.data[this.offset];
this.offset++;return a},readShort:function(){var a=(this.data[this.offset]<<8)+this.data[this.offset+1];this.offset+=2;return a},readInt:function(){var a=(this.data[this.offset]<<24)+(this.data[this.offset+1]<<16)+(this.data[this.offset+2]<<8)+this.data[this.offset+3];this.offset+=4;return a},eof:function(){return this.offset===this.length?!0:!1},reset:function(){this.offset=0},resize:function(a){this.length=this.data.length=a;this.offset>a&&(this.offset=a)},setBuffer:function(a){this.data=a;this.length=
a.length;this.offset=0},setData:function(a){this.length=a.length;this.offset=0;this.data.length=this.length;for(var b=0;b<this.length;++b)this.data[b]=a.charCodeAt(b)},getData:function(){for(var a="",b=0;b<this.offset;++b)a+=String.fromCharCode(this.data[b]);return a},data:"",offset:0});
function DepthList(){this.length=0;this.firstNode=new DepthListNode(null);this.lastNode=new DepthListNode(null);this.firstNode.depth=-2147483648;this.firstNode.next=this.lastNode;this.lastNode.depth=2147483648;this.lastNode.prev=this.firstNode}
DepthList.prototype={push:function(a){var b=null,c=this.firstNode;do{if(a.depth<c.depth){a.prev=b;a.next=c;c.prev=a;b.next=a;this.length++;return}b=c;c=c.next}while(c);console.log("Error: DEPTH LIST - OUT OF BONDS")},remove:function(a){null!==a.next&&(a.next&&(a.next.prev=a.prev),a.prev&&(a.prev.next=a.next),a.next=null,a.prev=null,this.length--)},update:function(a){var b=a.prev;if(b!==this.firstNode&&b.depth>a.depth){a.next.prev=a.prev;a.prev.next=a.next;do{if(b.depth<a.depth){a.prev=b;a.next=b.next;
a.next.prev=a;b.next=a;return}b=b.prev}while(b)}b=a.next;if(b!==this.lastNode&&b.depth<a.depth){a.next.prev=a.prev;a.prev.next=a.next;do{if(b.depth>a.depth){a.next=b;a.prev=b.prev;a.prev.next=a;b.prev=a;break}b=b.next}while(b)}},print:function(){if(0===this.length)console.log("Empty");else{var a=this.firstNode.next;a&&console.log("FirstNode: "+a.depth);do console.log(a.depth),a=a.next;while(a!==this.lastNode);this.lastNode.prev&&console.log("LastNode: "+this.lastNode.prev.depth)}}};
function DepthListNode(a){this.entity=a;this.depth=0;this.next=this.prev=null}
function PriorityList(a){this.push=function(a){a=new PriorityListNode(a,this.itemFunc(a));this.length++;if(null===this.firstNode)this.firstNode=a;else{for(var c=a.value,d=null,e=this.firstNode;e;){if(c<e.value){a.prev=d;a.next=e;e.prev=a;d&&(d.next=a);e===this.firstNode&&(this.firstNode=a);return}d=e;e=e.next}a.prev=d;d.next=a}this.lastNode=a};this.remove=function(a){if(this.firstNode&&this.firstNode.item===a)this.firstNode=this.firstNode.next,this.firstNode.prev=null;else if(this.lastNode&&this.lastNode.value===
a)this.lastNode=this.lastNode.prev,this.lastNode.next=null;else{var c=this.firstNode,d=c.next;do{if(d.item===a){c.next=d.next;d.next.prev=c;break}c=d;d=d.next}while(d)}};this.popFront=function(){if(null===this.firstNode)return null;var a=this.firstNode.next;a&&(a.prev=null,this.firstNode=a);this.length--;return this.firstNode.item};this.popBack=function(){if(null===this.lastNode)return null;var a=this.lastNode.prev;a.next=null;this.lastNode=a;this.length--;return this.lastNode.item};this.pushBtw=
function(a,c){a.prev=c.prev;a.next=c;c.prev.next=a;c.prev=a};this.print=function(){var a=this.firstNode;do console.log(a.value),a=a.next;while(a)};this.itemFunc=a;this.length=0;this.lastNode=this.firstNode=null}function PriorityListNode(a,b){this.item=a;this.value=b;this.next=this.prev=null}mighty.Profiler={start:function(a){this.msg=a;this.tStart=Date.now()},stop:function(){var a=Date.now()-this.tStart;console.log(this.msg+": "+a+"ms")},msg:"",tStart:0};var PluginPalette=Plugin.palette;
Plugin=Class.extend({init:function(){},initCfg:function(){},install:function(){},unload:function(){},_init:function(){this.timers=[];this.timersToRemove=[]},_initCfg:function(){"undefined"!==typeof this.scope.Cfg&&(this.cfg=this.scope.Cfg)},_install:function(){if(!this.name)return console.log("(Warning) Plugin: Could not add plugin without name!"),!1;this._initCfg();this.initCfg();this.installModules();this.loadPalette();this.scene.addPlugin(this);return!0},installModules:function(){this.module={};
this.modules=[];var a=this.scope.Module;if(a)for(var b in a)(a=this.scope.Module[b])||console.log("(Warning) (Plugin:"+this.name+"): Could not find module with name: "+b),a=new a,a._init(this,b),void 0!==a.setup&&a.setup(),this.module[b]=a,this.modules.push(a)},_unload:function(){this.timers.length=0;this.numTimersToRemove=this.numTimers=this.timersToRemove.length=0},load:function(){this.loadModules()},loadModules:function(){for(var a,b=this.modules.length,c=0;c<b;c++)a=this.modules[c],void 0!==a.load&&
a.load()},loadPalette:function(){this.palette=new Palette(this.name);Palettes[this.name]=this.palette;if(this.scope.palette){var a=!0;void 0!==this.cfg&&void 0!==this.cfg.isTemplate&&(a=this.cfg.isTemplate);a?this.loadPaletteAsTemplate():this.loadPaletteAsObj()}},loadPaletteAsTemplate:function(){var a=Template.Entity,b=this.scope.palette,c=b.length,d,e;if("Map"===this.name)for(d=0;d<c;d++){e=b[d];e.type=0;var f=new a(e.id,e.name,e.type);f.setBrush(e.texture);f.loadHead(e);f.loadBody(e.body);f.loadFooter(e.footer);
this.palette.add(f)}else if("Component"!==this.name)for(d=0;d<c;d++)e=b[d],f=new a(e.id,e.name,e.type),void 0!==f.obj&&(f.setBrush(e.texture),f.loadHead(e),f.loadBody(e.body),f.loadFooter(e.footer),this.palette.add(f));else for(d=0;d<c;d++)e=b[d],this.palette.add(e)},loadPaletteAsObj:function(){var a,b,c,d=this.scope.Obj,e=this.scope.palette,f=e.length;for(a=0;a<f;a++)c=e[a],b=d[c.type],void 0===this.scope[b]?mighty.Error.submit("Plugin::"+this.name,"Could not find object with a name - "+b):(b=new this.scope[b],
b.setup(c.id,c.name,Resource.plugin.module.Texture.getByID(c.texture)),this.palette.add(b));for(a=0;a<f;a++)c=e[a],b=this.palette.items[a],c.head&&b.loadVar(c.head),c.body&&b.loadVar(c.body),c.footer&&b.load(c.footer),b.update()},updateTimer:function(a){var b,c;for(b=0;b<this.numTimers;b++)if(c=this.timers[b],!c.isPaused)for(c.tAccumulator+=a;c.tAccumulator>=c.tDelta;)if(c.tAccumulator-=c.tDelta,c.func(c),c.tStart+=c.tDelta,-1!==c.numTimes&&(c.numTimes--,0>=c.numTimes)){this.timersToRemove.push(c);
this.numTimersToRemove++;break}if(0<this.numTimersToRemove){for(b=0;b<this.numTimersToRemove;b++)this.removeTimer(this.timersToRemove[b]);this.timersToRemove=[];this.numTimersToRemove=0}},addTimer:function(a,b,c){a=new Timer(this,a,b,c);this.timers.push(a);this.numTimers++;1===this.numTimers&&this.scene.addPluginTimer(this);return a},removeTimer:function(a){for(var b=0;b<this.numTimers;b++){var c=this.timers[b];if(c.id===a.id){c.removeFunc&&c.removeFunc();this.timers[b]=this.timers[this.numTimers-
1];this.timers.pop();this.numTimers--;break}}0===this.numTimers&&this.scene.removePluginTimer(this)},removeAllTimers:function(){this.numTimers=this.timers.length=0;this.scene.removePluginTimer(this)},id:0,priority:500,scope:null,cfg:null,palette:null,module:null,modules:null,name:"",scene:null,subscriber:null,timers:null,timersToRemove:null,numTimers:0,numTimersToRemove:0,isLoaded:!1});
mighty.Module=Class.extend({_init:function(a,b){this.mgr=a;this.name=b},setup:function(){},load:function(){},mgr:null,userMgr:null,name:""});mighty.CreateModule=function(a,b,c){a=window[a];void 0===a.Module&&(a.Module={});a.Module[b]=mighty.Module.extend(c)};mighty.CreateModuleEx=function(a,b,c,d){a=window[a];void 0===a.Module&&(a.Module={});void 0===a[c]?mighty.Error.submit("CreateModuleEx","Could not find class - "+c):a.Module[b]=a[c].extend(d)};
mighty.GetModule=function(a,b){var c=window[a];if(void 0===c||void 0===c.plugin)return mighty.Error.submit("GetModule","No such plugin loaded '"+a+"'"),null;c=c.plugin.module[b];return void 0==c?(mighty.Error.submit("GetModule","No such module '"+b+"' in the scope '"+a+"'"),null):c};var gTimerIndex=0;
function Timer(a,b,c,d){this.remove=function(){this.numTimes=0};this.pause=function(){this.isPaused=!0};this.resume=function(){this.isPaused=!1;this.tStart=Date.now()};this.id=gTimerIndex++;this.plugin=a;this.func=b;this.removeFunc=null;this.tDelta=c;this.numTimes=d;void 0===this.numTimes&&(this.numTimes=-1);this.tAccumulator=0;this.isPaused=!1}Component.Manager=Plugin.extend({});Component.Basic=function(){this.name="Basic"};
Entity.Manager=Plugin.extend({init:function(){this.priority=Priority.VERY_HIGH+101;this.initBuffers()},initBuffers:function(){this.updateEntities=[];this.redrawEntities=[];this.visibleEntities=new DepthList;this.animEntities=new DepthList;this.visibleFirst=this.visibleEntities.firstNode;this.visibleLast=this.visibleEntities.lastNode;this.animFirst=this.animEntities.firstNode;this.animLast=this.animEntities.lastNode;this.entitiesMap={};this.entitiesToRemove=[];this.grid=this.instanceEntities=this.instance=
this.level=null;this.numRedrawEntities=this.numUpdateEntities=0},install:function(){this.chn_Entity=CreateChannel("Entity.OUT");this.chn_EntityInteract=CreateChannel("EntityInteract");var a=this;SubscribeChannel(this,"Entity.IN",function(b,c){return a.handleSignal_EntityInt(b,c)});SubscribeChannel(this,"Engine",function(b,c){a.handleSignal_Engine(b,c)});SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,c)});this.patchMgr=this.scene.patchMgr;this.terrainMgr=this.scene.terrainMgr;this.visiblePatchs=
this.patchMgr.visiblePatchs;this.renderVisibleEntities=this.renderVisibleEntities_Default;gParams.editor&&(this.cfg.picking.pickableFlag=!1)},load:function(){this.level=this.scene.level;this.instance=[];this.instanceEntities={};this.terrainCfg=Terrain.Cfg;this.gridCfg=this.terrainCfg.grid;switch(Terrain.Cfg.type){case Terrain.Type.TOP_DOWN:Entity.Geometry.prototype.calcDrawOffset=Entity.Geometry.prototype._calcDrawOffset_TopDown;Entity.Geometry.prototype.updateDepth=this.cfg.depthSorting===Entity.DepthSorting.WEIGHTED?
Entity.Geometry.prototype._updateDepth_TopDown:Entity.Geometry.prototype._updateDepth_Manual;this.updateGridPos=this._updateGridPos_TopDown;this.drawInstanceGrid=this._drawInstanceGrid_TopDown;break;case Terrain.Type.ISOMETRIC:Entity.Geometry.prototype.calcDrawOffset=Entity.Geometry.prototype._calcDrawOffset_Isometric,Entity.Geometry.prototype.updateDepth=this.cfg.depthSorting===Entity.DepthSorting.WEIGHTED?Entity.Geometry.prototype._updateDepth_Isometric:Entity.Geometry.prototype._updateDepth_Manual,
this.updateGridPos=this._updateGridPos_Isometric,this.drawInstanceGrid=this._drawInstanceGrid_Isometric}this._super();this.loadLevel();this.terrainCfg.type===Terrain.Type.ISOMETRIC&&(this._offsetX=-(this.level.numTilesX*this.terrainCfg.halfTileWidth),this._offsetY=this.level.numTilesY*this.terrainCfg.halfTileHeight-this.terrainCfg.tileHeight);if(this.emptyEntityInst=this.addFromInfo(new Entity.Info(Palettes.Entity.getByName("null"),0,0)))this.emptyEntityInst.texture=null,this.emptyEntityInst.isSaved=
!1,this.emptyEntityInst.setVisible(!1)},unload:function(){this._super();this.initBuffers();mighty.context.clearRect(0,0,this.camera.width,this.camera.height)},forceUpdate:function(){this.patchMgr.updateView();gSceneState.dischargeAccumulator()},update:function(a){var b,c;for(b=0;b<this.numUpdateEntities;b++)c=this.updateEntities[b],c.update(a),c.updateComponents(a);this.camera.update(a);this.numEntitiesToRemove&&this.handleRemove()},render:function(a,b){this.renderVisibleEntities(a,b);this.grid&&
this.terrainMgr.cfg.grid.showDebug&&this.grid.draw(mighty.context)},renderVisibleEntities:null,renderAnimEntities:null,renderVisibleEntities_Default:function(a,b){this.isDrawed=!1;for(var c,d=this.visibleFirst.next;d!==this.visibleLast;)c=d.entity,c.wasCleared=!1,c.isNeedStage&&c.updateStage(),c.isAnimated&&c.updateAnim(b),c.isNeedDraw&&c.isVisible&&(this.isNeedRender=!0),d=d.next;this.isNeedRender&&this.drawScreen()},drawScreen:function(){var a=mighty.context;a.clearRect(0,0,this.camera.width,this.camera.height);
this.terrainCfg.visible&&this.drawInstanceGrid(a);for(var b=null,c=this.visibleFirst.next;c!==this.visibleLast;)b=c.entity,b.isVisible&&b.draw(a),c=c.next;this.isDrawed=!0;this.isNeedRender=!1},drawInstanceGrid:null,_drawInstanceGrid_TopDown:function(a){var b,c=this.terrainMgr.cfg.tileWidth,d=this.terrainMgr.cfg.tileHeight,e=this.patchMgr.startGridX,f=this.patchMgr.endGridX,g=this.patchMgr.endGridY;b=0;for(var i=this.patchMgr.startGridY;i<g;i++)for(var h=e;h<f;h++)if(b=h+i*this.level.sizeX,b=this.instance[b])b.drawX=
h*c,b.drawY=i*d,b.draw(a)},_drawInstanceGrid_Isometric:function(a){var b,c=Math.floor(this.terrainCfg.halfTileWidth),d=Math.floor(this.terrainCfg.halfTileHeight),e=this.patchMgr.startGridX,f=this.patchMgr.startGridY,g=this.patchMgr.endGridX,i=this.patchMgr.endGridY;for(b=e+f*this.terrainCfg.numTilesX;f<i;f++)for(var h=e;h<g;h++)if(b=h+f*this.terrainCfg.numTilesX,b=this.instance[b])b.drawX=this._offsetX+h*c+f*c,b.drawY=this._offsetY+h*d-f*d,b.draw(a)},updateScreen:function(){},redrawRegion:function(a){for(var b=
this.visibleFirst.next;b!==this.visibleLast;){var c=b.entity;switch(c.volumeType){case 1:a.vsBorderAABB(c.volume)&&this.renderFromVolume(c,a);break;case 2:a.vsSphere(c.volume)&&this.renderFromVolume(c,a)}b=b.next}},redrawEntity:function(){},renderFromVolume:function(a,b){var c=a.volume,d=c.minX,e=c.minY,f=c.maxX,c=c.maxY;d<b.minX&&(d=b.minX);e<b.minY&&(e=b.minY);f>b.maxX&&(f=b.maxX);c>b.maxY&&(c=b.maxY);a.drawRect(d,e,f,c)},forceRedraw:function(){this.isNeedRender=!0},handleRemove:function(){if(0!==
this.numEntitiesToRemove){this.isNeedRender=!0;for(var a,b=0;b<this.numEntitiesToRemove;b++)a=this.entitiesToRemove[b],a._removeSelf(),this.visibleEntities.remove(a.node),a.isAnimating&&this.animEntities.remove(a.animNode);this.numEntitiesToRemove=this.entitiesToRemove.length=0}},updateView:function(){(this.camera.minSector.isChanged()||this.camera.maxSector.isChanged())&&this.forceUpdate();this.isNeedRender=this.isForceRedraw=this.patchMgr.isNeedRender=!0},add:function(a){a.id=this.createID();a.parent=
this;a.activate();a.forceMove(a.x,a.y);var b=this.entitiesMap[a.type];void 0===b&&(this.entitiesMap[a.type]=[],b=this.entitiesMap[a.type]);b.push(a);this.chn_Entity.signal(Entity.Event.ADDED,a);return a},addFromInfo:function(a){if(void 0===a)return null;if(void 0===a.template||null===a.template)return mighty.Error.warning("Entity.addFromInfo","No template specified."),null;var b=a.template.create();b.x=a.x+b.brush.width/2;b.y=a.y+b.brush.height/2;return this.add(b)},remove:function(a){a.isNeedDraw=
!1;a.isNeedRemove=!0;this.entitiesToRemove.push(a);this.numEntitiesToRemove++;this.chn_Entity.signal(Entity.Event.REMOVED,a)},removeFromMap:function(a){var b=this.entitiesMap[a.type];if(void 0===b)mighty.Error.submit("Entity.Manager::removeFromMap","No such type found - "+mighty.Macro.GetEventString("GameObject","",a.type));else for(var c,d=b.length,e=0;e<d;e++)if(c=b[e],c===a){b[e]=b[d-1];b.pop();break}},addAnimating:function(a){this.animEntities.push(a.animNode)},removeAnimating:function(a){this.animEntities.remove(a.animNode)},
addUpdating:function(a){a.updateNodeID=this.numUpdateEntities;this.updateEntities.push(a);this.numUpdateEntities++},removeUpdating:function(a){var b=this.updateEntities[this.numUpdateEntities-1];b.updateNodeID=a.updateNodeID;this.updateEntities[b.updateNodeID]=b;this.updateEntities.pop();this.numUpdateEntities--},addRedrawEntity:function(a){a.isNeedRedraw||(this.redrawEntities[this.numRedrawEntities++]=a,a.isNeedRedraw=!0)},createID:function(){return this.uniqueID++},loadGridBuffer:function(a){if(!a||
!a.buffer)mighty.Error.submit("Entity::loadGridBuffer","Invalid grid buffer.");else{var b=new Terrain.Selector(a.gridX,a.gridY,a.gridX+a.sizeX,a.gridY+a.sizeY);if(b.numTiles!==a.buffer.length)mighty.Error.submit("Entity::loadGridBuffer","Invalid size of the buffer.");else{var c=new Entity.Info;b.reverse();var a=a.buffer,d=a.length-1;do{var e=a[d--];e&&-1!==e&&(c.template=this.palette.getByID(e),c.x=b.x,c.y=b.y,this.addFromInfo(c))}while(b.prev())}}},loadGridInstance:function(a){var b,c,d,e=new Entity.Info;
e.x=0;e.y=0;var f=null,g=null;c=a.entityBuffer;d=c.length;for(b=0;b<d;b++)if((f=c[b])&&void 0===this.instanceEntities[f.id])e.template=f,g=this.addFromInfo(e),g.setVisible(!1),g.isSaved=!1,this.instanceEntities[f.id]=g;c=a.buffer;d=c.length;for(b=0;b<d;b++)a=c[b],c[b]=0<a?this.instanceEntities[a]:null;this.instance=c},removeGridInstance:function(){this.isNeedRender=!0},setGridInstance:function(a,b){var c=this.instanceEntities[b.template.id];c||(c=new Entity.Info,c.template=b.template,c.x=0,c.y=0,
c=this.addFromInfo(c),c.setVisible(!1),c.isSaved=!1,this.instanceEntities[b.template.id]=c);this.instance[a]=c;this.isNeedRender=!0},handleSignal_EntityInt:function(a,b){switch(a){case Entity.Event.ADD:return this.add(b);case Entity.Event.ADD_FROM_INFO:return this.addFromInfo(b);case Entity.Event.REMOVE:return this.remove(b),!0;case Entity.Event.GET_BY_TYPE:return this.getByType(b);case Entity.Event.GET_BY_NAME:return this.getByName(b);case Entity.Event.LOAD_GRID_BUFFER:return this.loadGridBuffer(b),
!0;case Entity.Event.LOAD_GRID_INSTANCE:return this.loadGridInstance(b),!0}return!1},handleSignal_Camera:function(a){switch(a){case Camera.Event.MOVED:this.isNeedRender=!0}},handleSignal_Engine:function(a,b){switch(a){case Engine.Event.CAMERA:this.setCamera(b);break;case Engine.Event.ZOOM:this.forceRedraw()}},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:this.handleInput_Moved(b);break;case Input.Event.INPUT_DOWN:this.handleInput_Pressed(b);break;case Input.Event.CLICKED:case Input.Event.DB_CLICKED:this.handleInput_Clicked(b)}},
handleInput_Pressed:function(a){null!==this.inputOverEntity&&(this.pressedEntity=this.inputOverEntity,this.inputOverEntity.onInputPressed(a),this.chn_EntityInteract.signal(Entity.Event.PRESSED,this.inputOverEntity))},handleInput_Clicked:function(a){this.isEntityMoved?(this.pressedEntity.onInputDragged(a),this.chn_EntityInteract.signal(Entity.Event.DRAGGED,this.pressedEntity)):null!==this.inputOverEntity&&(this.inputOverEntity.onInputClicked(a),this.chn_EntityInteract.signal(Entity.Event.CLICKED,this.inputOverEntity));
this.pressedEntity=null;this.isEntityMoved=!1},handleInput_Moved:function(a){this._updateInputOver(a);this.pressedEntity&&(this.pressedEntity.onInputMoved(a),this.isEntityMoved=!0)},_updateInputOver:function(a){var b=this.cfg.picking,c=a.x-mighty.camera.x,d=a.y-mighty.camera.y;if(1===this.activeLayerID){for(var e=this.visibleLast.prev;e!==this.visibleFirst;e=e.prev)if(a=e.entity,!b.pickableFlag||a.isPickable)if(a.isVisible&&a.isInside(c,d)&&(!b.pixelPerfect||a.isInsidePerPx(c,d))){this.inputOverEntity&&
a!==this.inputOverEntity&&(a.isInputOver=!1,this.chn_EntityInteract.signal(Entity.Event.OVER_EXIT,this.inputOverEntity));a.onInputOver(c,d);this.inputOverEntity===a?(a.isInputOver=!0,this.chn_EntityInteract.signal(Entity.Event.OVER,a)):(this.inputOverEntity=a,this.chn_EntityInteract.signal(Entity.Event.OVER_ENTER,a));return}this.inputOverEntity&&(this.chn_EntityInteract.signal(Entity.Event.OVER_EXIT,this.inputOverEntity),this.inputOverEntity.isInputOver=!1,this.inputOverEntity=null)}else if(b=Math.floor(c/
this.terrainCfg.tileWidth),c=Math.floor(d/this.terrainCfg.tileHeight),d=b+c*this.terrainCfg.numTilesX,0>b||0>c||b>=this.terrainCfg.numTilesX||c>=this.terrainCfg.numTilesY)this.inputOverEntity=null,this.inputOverID=-1,this.chn_EntityInteract.signal(Entity.Event.OVER_EXIT,this.inputOverEntity);else return a=this.instance[d],this.inputOverID===d?(a.isInputOver=!0,this.chn_EntityInteract.signal(Entity.Event.OVER,a)):(a.moveSilently(b*this.terrainCfg.tileWidth,c*this.terrainCfg.tileHeight),this.inputOverEntity=
a,this.inputOverID=d,this.chn_EntityInteract.signal(Entity.Event.OVER_ENTER,a)),a},setCamera:function(a){if(this.camera=a){var b=this;this.camera.subscribe(this,function(a,d){b.handleSignal_Camera(a,d)});this.isNeedRender=!0}},getFromAABB:function(a){for(var b,c=[],d=this.visibleLast.prev;d!==this.visibleFirst;)b=d.entity,b.isLoaded&&b.collide(a,Entity.VolumeType.AABB)&&c.push(b),d=d.prev;return c},getFromPos:function(a,b){for(var c,d=this.visibleLast.prev;d!==this.visibleFirst;){c=d.entity;if(c.isVisible&&
c.isLoaded&&c.isInside(a,b))return c;d=d.prev}return null},getFromPosEx:function(a,b,c){for(var d,e=this.visibleLast.prev;e!==this.visibleFirst;){d=e.entity;if(d.isVisible&&d!==c&&d.isLoaded&&d.isInside(a,b))return d;e=e.prev}return null},getFromPosPx:function(a,b){for(var c,d=this.visibleLast.prev;d!==this.visibleFirst;){c=d.entity;if(c.isVisible&&c.isLoaded&&c.isInside(a,b)&&c.isInsidePerPx(a,b))return c;d=d.prev}return null},getByType:function(a){a=this.entitiesMap[a];return void 0===a?null:0<
a.length?a[0]:null},getByName:function(a){var b=null,c=0,d=null,e=null,f=0;for(b in this.entitiesMap){e=this.entitiesMap[b];f=e.length;for(c=0;c<f;c++)if(d=e[c],d.name===a)return d}return null},getData:function(a){return a?Entity.Loader.convertToBinary(this):Entity.Loader.convertToJSON(this)},loadLevel:function(a){return a?Entity.Loader.loadFromBinary(this):Entity.Loader.loadFromJSON(this)},getEntityFromMap:function(a,b){if(void 0===a)return mighty.Error.submit("Entity.Manager.GetEntity","Warning: Undefined type"),
null;void 0===b&&(b=0);var c=this.entitiesMap[a];return void 0===c?(mighty.Error.submit("Entity.Manager.GetEntity","Warning: No entities found with type - GameObject."+mighty.Macro.GetEventString("GameObject","",a)+"("+a+")"),null):c.length<=b?(mighty.Error.submit("Entity.Manager.GetEntity","Warning: No such index in the map - "+b),null):c[b]},updateGridPos:null,_updateGridPos_TopDown:function(a){a.prevGridX=a.gridX;a.prevGridY=a.gridY;a.gridX=Math.floor(a.drawX/this.gridCfg.width);a.gridY=Math.floor(a.drawY/
this.gridCfg.height);this.grid&&(a.gridX!==a.prevGridX||a.gridY!==a.prevGridY)&&this.grid.updateCell(a)},_updateGridPos_Isometric:function(a){a.prevGridX=a.gridX;a.prevGridY=a.gridY;var b=this.gridCfg.width,c=this.gridCfg.height;a.gridX=Math.floor(a.y/c-a.x/b);a.gridY=Math.floor(a.x/b+a.y/c);1<a.gridSizeX&&(a.gridX-=a.gridSizeX-1);this.grid&&(a.gridX!==a.prevGridX||a.gridY!==a.prevGridY)&&this.grid.updateCell(a)},switchActiveLayer:function(a){this.activeLayerID=a},editor:null,camera:null,grid:null,
patchMgr:null,terrainMgr:null,patchCfg:null,terrainCfg:null,gridCfg:null,level:null,isUpdateAnim:!0,isDrawAnim:!0,instance:null,instanceEntities:null,entitiesMap:null,entitiesToRemove:null,numEntitiesToRemove:-1,uniqueID:1,numDrawChanges:0,activeLayerID:1,visiblePatchs:null,updateEntities:null,redrawEntities:null,numUpdateEntities:0,numRedrawEntities:0,visibleEntities:null,visibleFirst:null,visibleLast:null,animEntities:null,animFirst:null,animLast:null,inputOverEntity:null,inputOverID:0,pressedEntity:null,
isEntityMoved:!1,isDrawed:!1,isForceRedraw:!1,isNeedRender:!1,isNeedUpdate:!1,chn_Engine:null,chn_Entity:null,chn_EntityIn:null,chn_EntityInteract:null,_offsetX:0,_offsetY:0});Entity.Info=function(a,b,c){void 0===b&&(b=0);void 0===c&&(c=0);this.template=a;this.x=b;this.y=c};Entity.GridBuffer=function(a,b,c,d,e){this.buffer=a;this.gridX=b;this.gridY=c;this.sizeX=d;this.sizeY=e};Entity.InstanceGridBuffer=function(a,b){this.entityBuffer=a;this.buffer=b};
Entity.Basic=Class.extend({setup:function(){},activate:function(){},load:function(){},update:function(){},updateComponents:function(){},_updateComponents:function(a){for(var b=0;b<this.numUpdateComponents;b++)this.componentsToUpdate[b].update(a);this.isNeedUpdate=!0},_loadComponents:function(){var a,b;for(b in this.component)a=this.component[b],void 0!==a.load&&a.load();this.updateComponents=this._updateComponents},createUniqueChannel:function(){return this.chn_unique=CreateChannel(this.name+"_"+
this.id)},subscribe:function(a,b){this.chn_unique||this.createUniqueChannel();this.chn_unique.subscribe(a,b)},unsubscribe:function(a){this.chn_unique.unsubscribe(a)},addTimer:function(a,b,c){return this.parent.addTimer(a,b,c)},addComponent:function(a){var a=Palettes.Component.getByName(a),b=Component.Obj[a.type],c;a.isUnique?(c=new Component[b](a),c.parent=this):(c=a,c.parent=null);IsObjectEmpty(this.component)&&(this.component={});this.component[b]=c;this.isLoaded&&void 0!==c.load&&c.load();a.innerUpdate&&
c.update&&(0===this.numUpdateComponents&&(this.componentsToUpdate=[]),this.componentsToUpdate.push(c),this.numUpdateComponents++)},getComponent:function(a){var b=this.component[a];if(void 0===b)mighty.Error.submit("Entity::name - "+this.name,"There is no such component - "+a);else return b},onSave:function(){return null},onLoad:function(){},is:function(a){return this instanceof a},print:function(a){console.log("[Entity",this.name+":"+this.id+"]",a)},parent:null,id:0,name:"unknown",type:0,template:null,
component:{},componentsToUpdate:null,numUpdateComponents:0,chn_unique:null,isLoaded:!1,isTemplate:!1});Template.Manager=Plugin.extend({init:function(){this._super("Template")}});
Template.Entity=Class.extend({init:function(a,b,c){this.id=a;this.name=b;this.type=c;if(void 0===c)mighty.Error.submit("Template::Entity","Invalid type for - "+b);else if(a=Entity.Obj[c])if(this.obj=Entity[a]){var d=this;this.loaders={};this.register("component",function(a){d.loadComponents(a)});this.register("available",function(a){d.loadAvailables(a)});delete Entity.palette}else mighty.Error.submit("Template::Entity","There is no such entity object defined in the scope: ["+a+"]");else mighty.Error.submit("Template::Entity",
"There is no such entity object name defined with type: ["+c+"]")},loadHead:function(a){this.brush=Palettes.Brush.getByID(a.brush)},loadBody:function(a){var b=[],c;for(c in a)b.push(new Template.Element(c,a[c]));this.body=b},loadFooter:function(a){this.footer={};for(var b in a)this.loaders[b](a[b])},loadComponents:function(a){if(void 0!==a){var b={};this.footer.component=b;for(var c=a.length,d=Palettes.Component,e=0;e<c;e++){var f=d.getByID(a[e]);f.name&&(f.objType=Component.Obj[f.type],f.isUnique||
(f.obj=new Component[f.objType](f)),b[f.objType]=f)}}},loadAvailables:function(a){for(var b={},c=a.length,d=0;d<c;d++)b[a[d]]=1;this.footer.available=b},copyBody:function(a){for(var b=null,c=null,d=this.body.length,e=0;e<d;e++)if(b=this.body[e],c=a[b.key],void 0===c||c!==b.value)a[b.key]=b.value},create:function(){var a=new this.obj;a.name=this.name;a.type=this.type;a.template=this;a.setup(this.brush);for(var b in this.footer)if("component"===b){var c=this.footer.component;a.component={};for(var d in c){var e=
c[d];if(e.isUnique){var f=new Component[e.objType](e);f.parent=a;a.component[e.objType]=f;e.innerUpdate&&f.update&&(0===a.numUpdateComponents&&(a.componentsToUpdate=[]),a.componentsToUpdate.push(f),a.numUpdateComponents++)}else a.component[e.objType]=e.obj,a.parent=null}}else a[b]=this.footer[b];a.template=this;this.copyBody(a);return a},register:function(a,b){this.loaders[a]=b},setBrush:function(a){this.brush=Palettes.Brush.getByID(a)},id:0,name:"",type:0,brush:null,body:null,footer:null,obj:null,
loaders:null,isTemplate:!0});Template.Element=function(a,b){this.key=a;this.value=b};
Resource.Manager=Plugin.extend({init:function(){this.path=Resource.Cfg.path+"/";gParams.branch&&(this.path=this.path+"/"+gParams.branch+"/");this.chn_resource=CreateChannel("Resource")},load:function(){this.isLoading=!0;for(var a=this.modules.length,b=0;b<a;b++)this.modules[b].load()},unload:function(){this.isLoaded=!1},updateLoading:function(){0<this.numModulesLoading||(this.isLoading=!1,this.isLoaded=!0,this.chn_resource.signal(Resource.Event.LOADED,!0))},_loadModuleType:function(){this.moduleByType=
[];var a=this.scope.ModuleType,b=this.scope.Type,c;for(c in a)this.moduleByType[b[c]]=this.module[a[c]]},loadPalette:function(){this._loadModuleType();for(var a,b=this.scope.palette,c=b.length,d=0;d<c;d++)a=b[d],void 0===a.type?mighty.Error.submit("Resource.Manager::loadPalette","Undefined resource type - "+a.name):this.moduleByType[a.type].addItem(a)},moduleByType:null,path:"",chn_resource:null,numModulesLoading:0,isLoading:!1,isLoaded:!1});
Resource.Resource=Class.extend({init:function(){this.cache={}},load:function(){},loadAsCache:function(){},finishLoad:function(){this.isLoaded=!0;this.channel&&this.channel.signal(Resource.Event.LOADED,this)},createObj:function(){return new Resource[Resource.Obj[this.type]]},subscribe:function(a,b){this.channel||(this.channel=CreateChannel("resource_"+this.id));this.channel.subscribe(a,b,Priority.MEDIUM)},unsubscribe:function(a,b){this.channel&&(this.channel.unsubscribe(b),0>=this.channel.numSubscribers&&
RemoveChannel(this.channel))},addCacheSetup:function(a){null===this.cacheSetup&&(this.cacheSetup=[]);this.cacheSetup.push(a)},doCacheSetup:function(){if(null!==this.cacheSetup){for(var a=this.cacheSetup.length,b=0;b<a;b++)this.cacheSetup[b].loadAsCache();this.cacheSetup=null}},parent:null,module:null,id:0,name:"Unknown",path:"",type:0,cache:null,cacheSetup:null,channel:null,isLoaded:!1});
Resource.ResourceModule=mighty.Module.extend({init:function(){this.resources=[]},setup:function(){this.loader=mighty.Loader;this.loaderElement=new mighty.Loader.Element(this.name,0,100);this.loader.addElement(this.loaderElement)},load:function(){this.loader.addElement(this.loaderElement);this.isLoading=!0;this.isPreLoaded&&this.mgr.numModulesLoading++;this._updateLoading()},_updateLoading:function(){this.loaderElement.numItemsLoaded>=this.loaderElement.numItems&&(this.isLoading=!1,this.isPreLoaded&&
(this.mgr.numModulesLoading--,this.mgr.updateLoading()))},addItem:function(a){this.isEmptyItem||this.addEmptyItem(a);var b=this.mgr.scope,b=new b[b.Obj[a.type]];b.module=this;for(var c in a)b[c]=a[c];b.load(this.mgr.path+this.path);this.resources.push(b);this.loaderElement.numItems++},addEmptyItem:function(a){var b=this.mgr.scope,b=new b[b.Obj[a.type]];b.name="_error";b.type=a.type;b.module=this;b.load();this.resources.push(b);this.isEmptyItem=!0;this.loaderElement.numItems++;this.loaderElement.numItemsLoaded++;
this.loader.updateElement(this.loaderElement)},loadSuccess:function(){this.loaderElement.numItemsLoaded++;this._updateLoading();this.loader.updateElement(this.loaderElement)},loadFailed:function(){this.loaderElement.numItemsLoaded++;this.loader.updateElement(this.loaderElement)},getByID:function(a){if(!a)return null;for(var b,c=this.resources.length,d=0;d<c;d++)if(b=this.resources[d],b.id===a)return b;return null},getByName:function(a){for(var b,c=this.resources.length,d=0;d<c;d++)if(b=this.resources[d],
b.name===a)return b;b=this.getByName("_error");mighty.Error.submit("Resource.Module","Could not found Resource.Type."+Resource.Obj[b.type]+" with a name - '"+a+"'.");return b},name:"",path:"",resources:null,resourcesToLoad:0,loader:null,loaderElement:null,isEmptyItem:!1,isLoading:!1,isPreLoaded:!0});mighty.CreateModuleEx("Resource","Texture","ResourceModule",{init:function(){this.name="Texture";this.path="default/img/";this._super()},texturesToCombine:0});
Resource.Texture=Resource.Resource.extend({load:function(a){this.image=new Image;var b=this;a&&(this.image.onload=function(){b.create();b.finishLoad();b.module.loadSuccess(b)},this.image.onerror=function(){b.module.loadFailed(b)},this.image.onabort=function(){b.module.loadFailed(b)},this.calcResolution(),this.path=a+this.id+"."+this.ext+"?"+this.date,this.image.src=this.path)},loadAsCache:function(){this.parent&&(this.create(),this.isLoaded=!0)},create:function(){var a=this.generateImg();this.imageCtx=
a.getContext("2d");this.flipType!==Resource.Flip.NONE?(this.calcResolution(),this.createFlip()):this.imageCtx.drawImage(this.image,0,0);this.image=a;this.doCacheSetup()},calcResolution:function(){this.parent&&(this.width=this.parent.width,this.height=this.parent.height)},generateImg:function(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;return a},generate:function(a,b){this.width=a;this.height=b;this.image=document.createElement("canvas");this.image.width=this.width;
this.image.height=this.height;this.imageCtx=this.image.getContext("2d")},resize:function(a,b){this.width=a;this.height=b;this.image.width=a;this.image.height=b},copy:function(a){this.name=a.name;this.offsetX=a.offsetX;this.offsetY=a.offsetY;this.cbFuncs=a.cbFuncs},draw:function(a,b,c){!1!==this.isLoaded&&a.drawImage(this.image,b,c)},drawRect:function(a,b,c,d,e,f,g){!1!==this.isLoaded&&a.drawImage(this.image,d,e,f,g,b,c,f,g)},drawFilter:function(a,b,c,d){!1!==this.isLoaded&&(d.process(this),a.drawImage(d.img,
Math.floor(b),Math.floor(c)))},drawFilterRect:function(a,b,c,d,e,f,g,i){!1!==this.isLoaded&&(i.process(this),a.drawImage(i.img,d,e,f,g,b,c,f,g))},drawScaled:function(a,b,c,d,e){!1!==this.isLoaded&&a.drawImage(this.image,0,0,this.width,this.height,b,c,d,e)},drawBufferScaled:function(a,b,c,d,e,f){!1!==this.isLoaded&&a.drawImage(b,0,0,this.width,this.height,c,d,e,f)},generateAlphaMask:function(){for(var a=this.imageCtx.getImageData(0,0,this.width,this.height).data,b=a.length,c=0;c<b;c+=4)50<a[c+3]?(a[c]=
255,a[c+1]=255,a[c+2]=255,a[c+3]=255):(a[c]=0,a[c+1]=0,a[c+2]=0,a[c+3]=0);this.imageCtx.putImageData(a,0,0);return this.image},generateRGBAFromAlpha:function(a,b,c,d,e){var f=document.createElement("canvas");f.width=d;f.height=e;var g=f.getContext("2d");g.drawImage(this.image,b,c,d,e,0,0,d,e);b=g.getImageData(0,0,d,e);a=a.getContext("2d").getImageData(0,0,d,e);d=b.data.length;e=3;for(c=0;c<d;c+=4){var i=a.data[e];i<b.data[e]&&(b.data[e]=i);e+=4}g.putImageData(b,0,0);return f},flip:function(a){var b=
null;void 0===this.cache.flip&&(this.cache.flip={});void 0===this.cache.flip[a]?(b=this.createObj(),b.copy(this),b.parent=this,b.flipType=a,this.isLoaded?b.createFlip():this.addCacheSetup(b),b.calcResolution(),this.cache.flip[a]=b):b=this.cache.flip[a];return b},createFlip:function(){switch(this.flipType){case Resource.Flip.HORIZONTAL:this.imageCtx.translate(this.width,0);this.imageCtx.scale(-1,1);this.imageCtx.drawImage(this.parent.image,0,0);break;case Resource.Flip.VERTICAL:this.imageCtx.translate(0,
this.height);this.imageCtx.scale(1,-1);this.imageCtx.drawImage(this.parent.image,0,0);break;case Resource.Flip.HORIZONTAL_VERTICAL:this.imageCtx.translate(this.width,this.height),this.imageCtx.scale(-1,-1),this.imageCtx.drawImage(this.parent.image,0,0)}},createBuffer:function(){this.bufferImg=this.generateImg();this.bufferCtx=this.bufferImg.getContext("2d")},clone:function(a){var b=new Resource.Texture;b.generate(this.width,this.height);b.copy(this);b.name=a;b.imageCtx.drawImage(this.canvas,0,0);
return b},renderOver:function(a){this.imageCtx.drawImage(a,0,0)},getFrameImg:function(a,b){var c=document.createElement("canvas");c.width=this.width;c.height=this.height;var d=c.getContext("2d");void 0===b?d.putImageData(this.getImgData(),0,0):(b.process(this),d.putImageData(b.getImgData(),0,0));d=new Image;d.name=this.name;d.src=c.toDataURL();return d},getInfo:function(){return this.imageCtx.getImageData(0,0,this.width,this.height)},getData:function(){return this.imageCtx.getImageData(0,0,this.width,
this.height).data},getDataAt:function(a,b){return this.imageCtx.getImageData(a,b,1,1).data},getImgData:function(){return this.imageCtx.getImageData(0,0,this.width,this.height)},setOffset:function(a,b){this.offsetX=a;this.offsetY=b},image:null,imageCtx:null,bufferImg:null,bufferCtx:null,combine:null,mask:null,maskType:MaskType.DEFAULT,width:0,height:0,offsetX:0,offsetY:0,numFrames:1,fps:0,isAnimated:!1,flipType:0});
window.document&&!window.document.URL.indexOf("file://")&&(Resource.Texture.prototype.getDataAt=function(){return[255,255,255,255]});
Resource.AnimTexture=Resource.Texture.extend({init:function(a,b){this._super(a,b);this.type=Resource.Type.ANIM_TEXTURE;this.isAnimated=!0},calcResolution:function(){this.parent?(this.fullWidth=this.parent.fullWidth,this.fullHeight=this.parent.fullHeight):(this.fullWidth=this.width,this.fullHeight=this.height);this.width=this.fullWidth/this.numFrames;this.height=this.fullHeight;this.tAnimUpdate=Math.round(1E3/this.fps)},generateImg:function(){var a=document.createElement("canvas");a.width=this.fullWidth;
a.height=this.fullHeight;return a},createFlip:function(){switch(this.flipType){case Resource.Flip.HORIZONTAL:this.imageCtx.translate(this.fullWidth,0);this.imageCtx.scale(-1,1);this.imageCtx.drawImage(this.parent.image,0,0);break;case Resource.Flip.VERTICAL:this.imageCtx.translate(0,this.fullHeight);this.imageCtx.scale(1,-1);this.imageCtx.drawImage(this.parent.image,0,0);break;case Resource.Flip.HORIZONTAL_VERTICAL:this.imageCtx.translate(this.fullWidth,this.fullHeight),this.imageCtx.scale(-1,-1),
this.imageCtx.drawImage(this.parent.image,0,0)}},copy:function(a){this._super(a);this.numFrames=a.numFrames;this.fps=a.fps},draw:function(a,b,c,d){!1!==this.isLoaded&&(b=Math.floor(b),c=Math.floor(c),a.drawImage(this.image,this.width*d,0,this.width,this.height,b,c,this.width,this.height))},drawRect:function(a,b,c,d,e,f,g,i){!1!==this.isLoaded&&(b=Math.floor(b),c=Math.floor(c),a.drawImage(this.image,this.width*i+d,e,f,g,b,c,f,g))},drawFilter:function(a,b,c,d,e){!1!==this.isLoaded&&(e.process(this),
b=Math.floor(b),c=Math.floor(c),a.drawImage(e.img,this.width*d,0,this.width,this.height,b,c,this.width,this.height))},getDataAt:function(a,b,c){return this.imageCtx.getImageData(a+c*this.width,b,1,1).data},getImgData:function(a){return this.imageCtx.getImageData(a*this.width,0,this.width,this.height)},getFrameImg:function(a,b){var c=document.createElement("canvas");c.width=this.width;c.height=this.height;var d=c.getContext("2d");void 0===b?d.putImageData(this.getImgData(a),0,0):(b.process(this),d.putImageData(b.getImgData(),
0,0));d=new Image;d.name=this.name;d.src=c.toDataURL();return d},getRandFrame:function(){return Random.getNumber(0,this.numFrames-1)},setFPS:function(a){this.fps=a;this.tAnimUpdate=Math.round(1E3/this.fps)},fullWidth:1,fullHeight:1,numFrames:1,fps:9,tAnimUpdate:0,tPause:5});window.document&&!window.document.URL.indexOf("file://")&&(Resource.AnimTexture.prototype.getDataAt=function(){return[255,255,255,255]});
mighty.CreateModuleEx("Resource","Sound","ResourceModule",{init:function(){this.name="Sound";this.path="default/snd/";this.isPreLoaded=!1;this._super();var a=this;SubscribeChannel(this,"Sound",function(b,c){a.handleSingal_Sound(b,c)});this.checkCapabilities()},setup:function(){this.volume=this.mgr.cfg.sound.volume;this._super()},stopAll:function(){for(var a=this.resources.length,b=0;b<a;b++)this.resources[b].stop()},disable:function(){this.isDisabled=!0;this.stopAll()},enable:function(){this.isDisabled=
!1},checkCapabilities:function(){this.audio=document.createElement("audio");void 0===this.audio.canPlayType&&(this.isAudioSupported=!1);this._getContext();this._checkFormats();this.audio=null},_getContext:function(){if(void 0!==window.AudioContext)this.context=new window.AudioContext;else for(var a=mighty.engine.extensions.length,b=0;b<a;b++){var c=window[mighty.engine.extensions[b]+"AudioContext"];if(void 0!==c){this.context=new c;return}}this.context||(this.isAudioSupported=!1)},_checkFormats:function(){this.formats=
[];var a=document.createElement("audio");""!=a.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/i,"")&&this.formats.push("m4a");a.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")&&this.formats.push("ogg");a.canPlayType("audio/mpeg;").replace(/no/,"")&&this.formats.push("mp3");a.canPlayType('audio/wav; codecs="1"').replace(/no/,"")&&this.formats.push("wav");0===this.formats.length&&(this.isAudioSupported=!1)},setVolume:function(a){if(!isNaN(a)){this.volume=a;for(var a=null,b=this.resources.length,
c=0;c<b;c++)a=this.resources[c],a.setVolume(a.volume)}},handleSignal_Sound:function(a,b){switch(a){case Sound.Event.PLAY:var c=this.getByName(b);return!c?(mighty.Error.submit("Sound.Event.PLAY","Could not find audio file with name - "+b),this.getByName("_error")):c;case Sound.Event.DISABLE:return this.disable(),!0;case Sound.Event.ENABLE:return this.enable(),!0;case Sound.Event.STOP_ALL:return this.stopAll(),!0;case Sound.Event.SET_VOLUME:this.setVolume(b)}return!1},audio:null,context:null,formats:null,
isAudioSupported:!0,isDisabled:!1,volume:1});
Resource.Sound=Resource.Resource.extend({load:function(a){this.sounds=[];this.path=a+this.path+this.id+".";this.play=this._play;this.stop=this._stop;this.pause=this._pause;this.setVolume=this._setVolume;a&&this._loadNextExtension()},_loadNextExtension:function(){this.currExtIndex++;if(this.currExtIndex>this.module.formats.length-1)this.module.loadFailed();else{if(!this.sound){this.sound=this._getAudioInstance();var a=this;this.sound.audio.addEventListener("error",function(){a._loadNextExtension()})}this.sound.audio.src=
this.path+this.module.formats[this.currExtIndex];this.sound.audio.load()}},_loadNextExtension_audioAPI:function(){this.currExtIndex++;if(this.currExtIndex>this.module.formats.length-1)this.module.loadFailed();else{var a=this,b=new XMLHttpRequest;b.open("GET",this.path+this.module.formats[this.currExtIndex],!0);b.responseType="arraybuffer";b.onload=function(){404===b.status?a._loadNextExtension_audioAPI():(a.module.context.decodeAudioData(b.response,function(b){a.buffer=b}),a.module.loadSuccess(),
a.path+=a.module.formats[a.currExtIndex],a.isLoaded=!0)};b.send()}},play:null,stop:null,pause:null,setVolume:null,_play:function(a){if(void 0===a&&(a=this._getAudioInstance(),!a.canPlay||!a.metaLoaded)){a.isNeedPlay=!0;return}a.isPlaying=!0;this.numPlaying++;this.isPlaying=!0;a.audio.currentTime=this.startTime;a.audio.load();a.audio.play();a.audio.volume=this.module.volume*this.volume;var b=this,c=function(){a.audio.removeEventListener("ended",c,!1);a.isPlaying=!1;b.numPlaying--;b.isLoop?b.play():
0===b.numPlaying&&(b.isPlaying=!1)};a.audio.addEventListener("ended",c,!1);return a},_playAudioAPI:function(){if(this.module.isAudioSupported){var a=this.module.context.createBufferSource();a.buffer=this.buffer;a.connect(this.module.context.destination);a.noteOn(0)}},_stop:function(){for(var a,b=this.sounds.length,c=0;c<b;c++)a=this.sounds[c],a.audio.pause(),a.isPlaying=!1,a.isNeedPlay=!1;this.numPlaying=0;this.isPlaying=!1},_stopAudioAPI:function(){},_pause:function(){var a,b,c=this.sounds.length;
if(this.isPaused){for(b=0;b<c;b++)a=this.sounds[b],a.isPlaying&&a.audio.play();this.isPaused=!1}else{for(b=0;b<c;b++)a=this.sounds[b],a.isPlaying&&a.audio.pause();this.isPaused=!0}},_setVolume:function(a){0>a?a=0:1<a&&(a=1);this.volume=a;var b,c,d=this.sounds.length;for(c=0;c<d;c++)b=this.sounds[c],b.isPlaying&&(b.audio.volume=this.module.volume*a)},_getAudioInstance:function(){for(var a,b=this.sounds.length,c=0;c<b;c++)if(a=this.sounds[c],!a.isPlaying&&!a.isNeedPlay)return a;a=new Resource.AudioInstance;
var d=this;a.audio.addEventListener("canplaythrough",function(){a.canPlay=!0;d.sound?!a.isPlaying&&(a.isNeedPlay&&a.metaLoaded)&&d.play(a):(d.module.loadSuccess(),d.path+=d.module.formats[d.currExtIndex],d.isLoaded=!0)},!1);a.audio.addEventListener("loadedmetadata",function(){a.metaLoaded=!0;d.sound&&(!a.isPlaying&&a.isNeedPlay&&a.canPlay)&&d.play(a)},!1);this.sounds.push(a);this.sound&&(a.audio.src=this.sound.audio.src,a.audio.load());return a},sound:null,sounds:null,numPlaying:0,isPlaying:!1,isPaused:!1,
buffer:null,source:null,volume:1,currExtIndex:-1,startTime:0,isAutoPlay:!1,isLoop:!1});Resource.AudioInstance=function(){this.metaLoaded=this.canPlay=this.isNeedPlay=this.isPlaying=!1;this.timeout=null;this.audio=new window.Audio;this.audio.preload="auto"};Material.Manager=Plugin.extend({});
Material.Basic=Class.extend({init:function(a){this.name=a;this.img=document.createElement("canvas");this.ctx=this.img.getContext("2d")},clone:function(a){this.info=a.getInfo();this.data=this.info.data;this.length=this.data.length;this.width=a.width;this.height=a.height;this.img.width=this.width;this.img.height=this.height},create:function(){this.ctx.putImageData(this.info,0,0)},process:mighty.EmptyFunc,getInfo:function(){return this.ctx.getImageData(0,0,this.width,this.height)},getData:function(){return this.ctx.getImageData(0,
0,this.width,this.height).data},name:"",img:null,ctx:null,width:0,height:0,info:null,data:null,length:0});
Material.Color=Material.Basic.extend({process:function(a){this.clone(a);for(a=0;a<this.length;a+=4)this.data[a]=this.mulColor(this.data[a],this.r),this.data[a+1]=this.mulColor(this.data[a+1],this.g),this.data[a+2]=this.mulColor(this.data[a+2],this.b),this.data[a+3]=this.mulColor(this.data[a+3],this.a);this.create()},mulColor:function(a,b){return Math.ceil(255*a/255*(b/255))},setRGB:function(a,b,c){this.r=a;this.g=b;this.b=c;this.a=255},setRGBA:function(a,b,c,d){this.r=a;this.g=b;this.b=c;this.a=d},
r:255,g:255,b:255,a:255});Material.Grayscale=Material.Basic.extend({process:function(a){this.clone(a);for(a=0;a<this.length;a+=4){var b=this.getLuminance(this.data[a],this.data[a+1],this.data[a+2],this.data[a+3]);this.data[a]=b;this.data[a+1]=b;this.data[a+2]=b}this.create()},getLuminance:function(a,b,c){return Math.ceil(0.3*a+0.59*b+0.11*c)},power:1});
Input.Manager=Plugin.extend({init:function(){this._super();this.name="Input";this.numFingers=10;this.chn_input=CreateChannel("Input");var a=this;SubscribeChannel(this,"Input.IN",function(b,c){return a.handleSignal_Input(b,c)});this.cachedEvent=new Input.EventInfo(-1,-1,-1);this.keys=Array(256)},install:function(){void 0!==gParams.editor&&(this.cfg.stickyKeys=!1)},load:function(){var a=0;for(this.touches=Array(this.numFingers);a<this.numFingers;++a)this.touches[a]=new Input.TouchItem(a);this.numLinks=
this.numFingers;2===this.numLinks?this.numLinks=1:1===this.numLinks&&(this.numLinks=0);this.numLinks&&(this.links=Array(this.numLinks));for(a=0;a<this.numLinks;++a)this.links[a]=new Input.TouchLink(a)},handleMouseDown:function(a,b,c,d){this.cachedEvent.set(a,b,c,d);this.chn_input.signalBreakable(Input.Event.INPUT_DOWN,this.cachedEvent)},handleMouseUp:function(a,b,c,d){this.cachedEvent.set(a,b,c,d);this.chn_input.signalBreakable(Input.Event.INPUT_UP,this.cachedEvent)},handleMouseClick:function(a,b,
c,d){this.cachedEvent.set(a,b,c,d);this.chn_input.signalBreakable(Input.Event.CLICKED,this.cachedEvent)},handleMouseDbClick:function(a,b,c,d){this.cachedEvent.set(a,b,c,d);this.chn_input.signalBreakable(Input.Event.DB_CLICKED,this.cachedEvent)},handleMouseMove:function(a,b,c){this.cachedEvent.set(a,-1,b,c);this.chn_input.signal(Input.Event.MOVED,this.cachedEvent)},handleTouchStart:function(a){if(this.numActiveTouches!==this.numFingers)for(var a=a.changedTouches,b=a.length,c=0;c<b;c++){var d=a[c],
e=d.identifier,f=this.getFreeTouch();f.uid=e;this.numActiveTouches++;e=d.pageX;d=d.pageY;this.linkTouch(f);1===this.numActiveTouches?(this.cachedEvent.set(Input.Key.BUTTON_LEFT,e,d),this.chn_input.signal(Input.Event.PRESSED,this.cachedEvent),this.isTouchPressed=!0):this.isTouchPressed=!1}},handleTouchEnd:function(a){for(var a=a.changedTouches,b=a.length,c=0;c<b;c++){var d=a[c],e=this.getTouchByUid(a[c].identifier);if(null!==e){e.uid=-1;this.numActiveTouches--;var f=d.pageX,d=d.pageY;if(this.isTouchPressed){var g=
Date.now()-this.tTouchEnd;clearTimeout(this.touchEndAction);if(300>g)this.cachedEvent.set(Input.Key.BUTTON_LEFT,f,d),this.chn_input.signal(Input.Event.DB_CLICKED,this.cachedEvent);else{var i=this;new Input.EventInfo(Input.Key.BUTTON_LEFT,f,d);this.touchEndAction=setTimeout(function(a){i.chn_input.signal(Input.Event.CLICKED,a);clearTimeout(i.touchEndAction)},300)}this.isTouchPressed=!1;this.tTouchEnd=Date.now()}this.unlinkTouch(e)}}},handleTouchMove:function(a){for(var a=a.changedTouches,b=a.length,
c=0;c<b;c++){var d=a[c];if(null!==this.getTouchByUid(d.identifier)){var e=d.pageX,d=d.pageY;1===this.numActiveTouches?(this.cachedEvent.set(Input.Key.BUTTON_LEFT,e,d),this.chn_input.signal(Input.Event.MOVED,this.cachedEvent)):this.isTouchPressed=!1}}this.processActiveTouches()},handleTouchCancel:function(a){this.handleTouchEnd(a)},handleKeyDown:function(a,b){if(!this.cfg.stickyKeys||!this.keys[b])this.keys[b]=!0,this.cachedEvent.set(a,b,0,0),this.chn_input.signal(Input.Event.KEY_DOWN,this.cachedEvent)},
handleKeyUp:function(a,b){if(!this.cfg.stickyKeys||this.keys[b])this.keys[b]=!1,this.cachedEvent.set(a,b,0,0),this.chn_input.signal(Input.Event.KEY_UP,this.cachedEvent)},linkTouch:function(){},unlinkTouch:function(){},processActiveTouches:function(){for(var a=0;a<this.numLinks;++a){var b=this.links[a];b.isActive()&&1==this.numActiveLinks&&this.processPinch(b)}},processPinch:function(a){var b=a.item2.x-a.item1.x,a=a.item2.y-a.item1.y,b=Math.sqrt(b*b+a*a),a=this.prevPinchDistance-b;0<a?(this.cachedEvent.set(0,
a,0),this.chn_input.signal(Input.Event.PINCH_IN,this.cachedEvent)):(this.cachedEvent.set(0,a,0),this.chn_input.signal(Input.Event.PINCH_OUT,this.cachedEvent));this.prevPinchDistance=b},getTouchByUid:function(a){for(var b=0;b<this.numFingers;++b){var c=this.touches[b];if(c.uid===a)return c}return null},getFreeTouch:function(){for(var a=0;a<this.numFingers;++a){var b=this.touches[a];if(-1===b.uid)return b}return null},getFreeLink:function(){for(var a=0;a<this.numLinks;++a){var b=this.links[a];if(b.isFree())return b}return null},
handleSignal_Input:function(a,b){switch(a){case Input.Event.IS_KEY:if(void 0!==this.keys[b])return this.keys[b];break;case Input.Event.GET_KEYS:return this.keys}return!1},touches:null,numFingers:0,numActiveTouches:0,links:null,numLinks:0,numActiveLinks:0,isTouchPressed:!1,tTouchEnd:0,touchEndAction:null,prevPinchDistance:0,chn_input:null,chn_debug:null,cachedEvent:null,stickyKeys:null});
Input.EventInfo=function(a,b,c,d){this.set=function(a,b,c,d){this.alternativeEvent=a;this.keyCode=b;this.x=c;this.y=d};this.keyCode=b;this.x=c;this.y=d;this.alternativeEvent=null};Input.TouchItem=function(a){this.show=function(){this.prevX=this.x;this.prevY=this.y};this.move=function(a,c){this.prevX=this.x;this.prevY=this.y;this.x=a;this.y=c};this.id=a;this.uid=-1;this.prevY=this.prevX=this.y=this.x=0;this.link=this.debugItem=null};
Input.TouchLink=function(a){this.isFree=function(){return!this.item1||!this.item2};this.isActive=function(){return this.item1&&this.item2};this.id=a;this.debugItem=this.item2=this.item1=null};
Patch.Manager=Plugin.extend({init:function(){this.priority=Priority.VERY_HIGH+102;this.visiblePatchs=[]},install:function(){this.entityMgr=this.scene.entityMgr;var a=this;SubscribeChannel(this,"Patch.IN",function(b,c){return a.handleSignal_Patch(b,c)});SubscribeChannel(this,"Engine",function(b,c){return a.handleSignal_Engine(b,c)})},create:function(a){this.level=a;this.updateCfg();this.createPatches();this.updateView=Terrain.Cfg.type===Terrain.Type.TOP_DOWN?this._updateView_TopDown:this._updateView_Isometric},
createPatches:function(){var a=this.cfg,b=Terrain.Cfg;this.terrainCfg=b;this.patchs=Array(a.numPatchs);this.visiblePatchs.length=a.numPatchs;for(var c=Patch[Patch.Obj[Terrain.Cfg.type]],d=0,e=new Vector2(0,0),f=0;f<a.numY;f++)for(var e=this.getRowPos(e,f),g=0;g<a.numX;g++){var i=a.numTilesX,h=a.numTilesY,j=g*i,k=f*h;j+i>b.numTilesX&&(i-=j+i-b.numTilesX);k+h>b.numTilesY&&(h-=k+h-b.numTilesY);i=new c(d,g,f,e.x,e.y,a.width,a.height,j,k,i,h);i.parent=this;i.prepare();this.patchs[d]=i;d++;e=this.getNextPos(e)}this.boundsPatch=
new c;this.boundsPatch.parent=this;this.boundsPatch.isVisible=!0;this.useGrid(this.terrainCfg.grid.use);this.isLoaded=!0},unload:function(){this._super();this.grid&&(this.grid.clear(),this.grid=null);this.level=null;this.patchs=[];this.visiblePatchs=[];this.prevEndNodeY=this.prevEndNodeX=this.prevStartNodeY=this.prevStartNodeX=this.numVisiblePatchs=0;this.isNeedUpdateView=this.isNeedRender=!1;this.grid&&this.grid.clear();mighty.context.clearRect(0,0,this.camera.width,this.camera.height)},load:function(){this.level=
this.scene.level},update:function(){this.isNeedUpdateView&&this.updateView()},forcePreRender:function(){for(var a=0;a<this.cfg.numPatchs;++a)this.patchs[a].isNeedRender=!0;this.isNeedRender=!0},updateView:null,_updateView_TopDown:function(){if(this.level&&this.camera){Entity.plugin.isNeedRender=!0;this.isNeedUpdateView=!1;var a=this.camera.viewFrustum,b=Math.floor(a.minX/this.cfg.optimalSizeX),c=Math.floor(a.minY/this.cfg.optimalSizeY),d=Math.ceil(a.maxX/this.cfg.optimalSizeX),a=Math.ceil(a.maxY/
this.cfg.optimalSizeY),b=Math.max(0,b),c=Math.max(0,c),d=Math.max(0,d),a=Math.max(0,a);0>b&&(b=0);0>c&&(c=0);d>this.cfg.numX&&(d=this.cfg.numX);a>this.cfg.numY&&(a=this.cfg.numY);this._updateViewGrid_TopDown();if(!(b===this.prevStartNodeX&&c===this.prevStartNodeY&&d===this.prevEndNodeX&&a===this.prevEndNodeY)){var e=Math.min(this.prevStartNodeX,b),f=Math.min(this.prevStartNodeY,c),g=Math.max(this.prevEndNodeX,d),i=Math.max(this.prevEndNodeY,a),h;this.numVisiblePatchs=0;for(var j=f;j<i;j++)for(var f=
j*this.cfg.numX,k=e;k<g;k++)h=f+k,h=this.patchs[h],k>=b&&k<d&&j>=c&&j<a?(h.setVisible(!0),this.visiblePatchs[this.numVisiblePatchs]=h,this.numVisiblePatchs++):h.setVisible(!1);this.prevStartNodeX=b;this.prevStartNodeY=c;this.prevEndNodeX=d;this.prevEndNodeY=a}}},_updateView_Isometric:function(){if(this.level&&this.camera){Entity.plugin.isNeedRender=!0;this.isNeedUpdateView=!1;var a,b=0,c=this.cfg.numX,d=this.cfg.numY;a=Math.max(0,0);b=Math.max(0,b);c=Math.max(0,c);d=Math.max(0,d);0>a&&(a=0);0>b&&
(b=0);c>this.cfg.numX&&(c=this.cfg.numX);d>this.cfg.numY&&(d=this.cfg.numY);this._updateViewGrid_Isometric();if(!(a===this.prevStartNodeX&&b===this.prevStartNodeY&&c===this.prevEndNodeX&&d===this.prevEndNodeY)){var e=Math.min(this.prevStartNodeX,a),f=Math.min(this.prevStartNodeY,b),g=Math.max(this.prevEndNodeX,c),i=Math.max(this.prevEndNodeY,d),h;this.numVisiblePatchs=0;for(var j=f;j<i;j++)for(var f=j*this.cfg.numX,k=e;k<g;k++)h=f+k,h=this.patchs[h],k>=a&&k<c&&j>=b&&j<d?(h.setVisible(!0),this.visiblePatchs[this.numVisiblePatchs]=
h,this.numVisiblePatchs++):h.setVisible(!1);this.prevStartNodeX=a;this.prevStartNodeY=b;this.prevEndNodeX=c;this.prevEndNodeY=d}}},_updateViewGrid_TopDown:function(){var a=this.camera.viewFrustum;this.startGridX=Math.floor(a.minX/this.terrainCfg.tileWidth);this.startGridY=Math.floor(a.minY/this.terrainCfg.tileHeight);this.endGridX=Math.ceil(a.maxX/this.terrainCfg.tileWidth);this.endGridY=Math.ceil(a.maxY/this.terrainCfg.tileHeight);this.offsetX=a.minX%this.terrainCfg.tileWidth-this.startGridX*this.terrainCfg.tileWidth;
this.offsetY=a.minY%this.terrainCfg.tileHeight-this.startGridY*this.terrainCfg.tileHeight;0>this.startGridX&&(this.startGridX=0);0>this.startGridY&&(this.startGridY=0);this.endGridX>this.level.terrain.sizeX&&(this.endGridX=this.level.terrain.sizeX);this.endGridY>this.level.terrain.sizeY&&(this.endGridY=this.level.terrain.sizeY)},_updateViewGrid_Isometric:function(){this.startGridY=this.startGridX=0;this.endGridX=this.level.sizeX;this.endGridY=this.level.sizeY},updatePatchAt:function(a,b){this.patchs[a+
b*this.cfg.numX].isNeedRender=!0},handleSignal_Engine:function(a,b){switch(a){case Engine.Event.CAMERA:this.setCamera(b);break;case Engine.Event.ZOOM:this.updateView()}},handleSignal_Camera:function(a){switch(a){case Camera.Event.MOVED:this.updateView()}},handleSignal_Patch:function(a,b){switch(a){case Patch.Event.VISIBLE_PATCHES:return this.visiblePatchs;case Patch.Event.USE_GRID:return this.useGrid(b),!0;case Patch.Event.UPDATE_VIEW:return this.updateView(),!0}return!1},setCamera:function(a){this.camera&&
this.camera.unsubscribe(this);if(this.camera=a){var b=this;this.camera.subscribe(this,function(a,d){b.handleSignal_Camera(a,d)});this.isNeedUpdateView=!0}},setTerrainData:function(a){for(var b=0;b<this.cfg.numPatchs;b++){var c=this.patchs[b];c.data=a;c.prepareDraw()}this.isNeedRender=!0},getPatchAt:function(a,b){return 0>a||a>=this.cfg.numX||0>b||b>=this.cfg.numY?this.boundsPatch:this.patchs[a+b*this.cfg.numX]},getPatchFromGridPos:function(a,b){if(isNaN(a)||isNaN(b)||a>=this.level.sizeX)return this.boundsPatch;
var c=Math.floor(a/this.cfg.numGridX);if(0>c||b>=this.level.sizeY)return this.boundsPatch;var d=Math.floor(b/this.cfg.numGridY);if(0>d)return this.boundsPatch;c+=d*this.cfg.numX;return c>=this.cfg.numPatchs?this.boundsPatch:this.patchs[c]},getNextPos:function(a){var b=Terrain.Cfg;switch(b.type){case Terrain.Type.ISOMETRIC:return a.x+=this.cfg.numTilesX*b.halfTileWidth,a.y+=this.cfg.numTilesX*Math.floor(b.halfTileHeight),a;case Terrain.Type.TOP_DOWN:return a.x+=this.cfg.numTilesX*b.tileWidth,a}return null},
getRowPos:function(a,b){var c=Terrain.Cfg;switch(c.type){case Terrain.Type.ISOMETRIC:return a.x=-(this.cfg.numTilesY*c.halfTileWidth)*b,a.y=this.cfg.numTilesY*Math.floor(c.halfTileHeight)*b,a;case Terrain.Type.TOP_DOWN:return a.x=this.cfg.startPosX,a.y=this.cfg.startPosY+this.cfg.numTilesY*c.tileHeight*b,a}return null},setPatchFromGridPos:function(a,b,c){a.patch=null;a.entityPatch=null;for(var d=0;d<this.numVisiblePatchs;d++){var e=this.visiblePatchs[d];if(e.gridAABB.vsPoint(b,c)){a.patch=e;break}}},
updateCfg:function(){var a=Patch.Cfg,b=Terrain.Cfg;this._updateCfgPatches();a.numTilesX=a.optimalSizeX/b.tileWidth;a.numTilesY=a.optimalSizeY/b.tileHeight;a.numGridX=a.optimalSizeX/b.grid.width;a.numGridY=a.optimalSizeY/b.grid.height;b.grid.sizeX=Math.ceil(b.width/b.grid.width);b.grid.sizeY=Math.ceil(b.height/b.grid.height);switch(b.type){case Terrain.Type.ISOMETRIC:a.width=Math.ceil(a.numTilesX*b.halfTileWidth+a.numTilesY*b.halfTileWidth);a.height=Math.ceil(a.numTilesY*b.halfTileHeight+a.numTilesX*
b.halfTileHeight);break;case Terrain.Type.TOP_DOWN:a.width=a.numTilesX*b.tileWidth,a.height=a.numTilesY*b.tileHeight}a.halfWidth=a.width/2;a.halfHeight=a.height/2;a.startPosX=0;a.startPosY=0},_updateCfgPatches:function(){var a=Terrain.Cfg,b;switch(a.type){case Terrain.Type.TOP_DOWN:this.cfg.optimalSizeX<a.tileWidth?this.cfg.optimalSizeX=a.tileWidth:(b=this.cfg.optimalSizeX%a.tileWidth,this.cfg.optimalSizeX=b<=a.halfTileWidth?this.cfg.optimalSizeX-b:this.cfg.optimalSizeX+(a.tileHeight-b));this.cfg.optimalSizeY<
a.tileHeight?this.cfg.optimalSizeY=a.tileHeight:(b=this.cfg.optimalSizeY%a.tileHeight,this.cfg.optimalSizeY=b<=a.halfTileHeight?this.cfg.optimalSizeY-b:this.cfg.optimalSizeY+(a.tileHeight-b));break;case Terrain.Type.ISOMETRIC:this.cfg.optimalSizeX=this.cfg.optimalSizeX>a.tileWidth?this.cfg.optimalSizeX-this.cfg.optimalSizeX%a.tileWidth:a.tileWidth,this.cfg.optimalSizeY=this.cfg.optimalSizeY>a.tileHeight?this.cfg.optimalSizeY-this.cfg.optimalSizeY%a.tileHeight:a.tileHeight}this.cfg.numX=Math.ceil(a.width/
this.cfg.optimalSizeX);this.cfg.numY=Math.ceil(a.height/this.cfg.optimalSizeY);this.cfg.numPatchs=this.cfg.numX*this.cfg.numY},updatePatchDebug:function(){this.$debuger.html("[numPatchs]: "+this.numPatchs+" [numVisiblePatchs]: "+this.numVisiblePatchs)},useGrid:function(a){(this.terrainCfg.grid.use=a)?this.grid||(this.grid=new Patch.Grid(this.terrainCfg.grid.width,this.terrainCfg.grid.height,this.terrainCfg.grid.sizeX,this.terrainCfg.grid.sizeY)):this.grid&&(this.grid.clear(),this.grid=null)},cfg:null,
terrainCfg:null,camera:null,level:null,entityMgr:null,patchs:null,visiblePatchs:null,numVisiblePatchs:0,boundsPatch:null,grid:null,startGridX:0,startGridY:0,endGridX:0,endGridY:0,offsetX:0,offsetY:0,prevStartNodeX:0,prevStartNodeY:0,prevEndNodeX:0,prevEndNodeY:0,isNeedRender:!1,isNeedUpdateView:!1,$debuger:null});
Patch.Patch=Class.extend({init:function(a,b,c,d,e,f,g,i,h,j,k){this.entities=[];this.id=a;this.patchX=b;this.patchY=c;this.x=d;this.y=e;this.width=f;this.height=g+(Terrain.Cfg.tileDepth-1);this.gridX=i;this.gridY=h;this.gridWidth=j;this.gridHeight=k},initBoundingVolume:function(){var a=this.x,b=this.y;this.boundingAABB=new AABB(a,b,a+this.width,b+this.height);this.gridAABB=new AABB(this.gridX,this.gridY,this.gridX+this.gridWidth-1,this.gridY+this.gridHeight-1)},initRenderTarget:function(){this.texture=
new Resource.Texture;this.texture.generate(this.width,this.height);this.canvas=this.texture.image;this.renderTarget=this.texture.imageCtx},prepare:function(){this.gridMaxX=this.gridX+this.gridWidth;this.gridMaxY=this.gridY+this.gridHeight;this.initBoundingVolume()},prepareDraw:function(){this.numTiles=this.gridWidth*this.gridHeight;this.tiles=Array(this.numTiles);mighty.engine.pushRenderTarget(this.renderTarget);this.isRendered&&mighty.context.clearRect(0,0,this.width,this.height);for(var a=0,b=0,
c=0,d=new Vector2(this.startX,this.startY),e=this.gridY;e<this.gridMaxY;e++){a=this.gridX+e*Terrain.Cfg.numTilesX;this.getRowPos(d,b);b++;for(var f=this.gridX;f<this.gridMaxX;f++){var g=this.data[a];g.drawX=d.x;g.drawY=d.y;g.patch=this;this.tiles[c]=g;c++;this.getNextPos(d);a++}}},preRender:function(){mighty.engine.pushRenderTarget(this.renderTarget);var a=mighty.context;this.isRendered&&a.clearRect(0,0,this.width,this.height);for(var b=0;b<this.numLayers;++b)for(var c=0;c<this.numTiles;++c)this.tiles[c].draw(a,
b);if(b=mighty.engine.filter)b.process(this.texture),a.drawImage(b.img,0,0,this.width,this.height);mighty.engine.popRenderTarget();this.isRendered=!0;this.isNeedRender=!1},updateVisibility:function(){},clear:function(a,b,c,d){this.renderTarget.clearRect(a,b,c,d)},draw:function(a){var b=a.minX,c=a.minY,d=a.maxX,e=a.maxY;this.boundingAABB.minX>b&&(b=this.boundingAABB.minX);this.boundingAABB.maxX<d&&(d=this.boundingAABB.maxX);d-=b;if(!(0>=d)&&(this.boundingAABB.minY>c&&(c=this.boundingAABB.minY),this.boundingAABB.maxY<
e&&(e=this.boundingAABB.maxY),e-=c,!(0>=e))){var f=-a.minX+b,a=-a.minY+c,b=b-this.x,c=c-this.y;mighty.context.drawImage(this.canvas,b,c,d,e,f,a,d,e)}},redrawLayerRegion:function(a,b,c,d,e,f){var g=mighty.context;g.drawImage(this.canvas,a,b,e,f,c,d,e,f);(new AABB(c,d,c+e,d+f)).draw(g)},renderDebug:function(){this.boundingAABB.translate(mighty.camera.x,mighty.camera.y);mighty.context.strokeStyle="red";this.boundingAABB.draw(mighty.context);this.boundingAABB.translate(-mighty.camera.x,-mighty.camera.y);
mighty.context.strokeStyle="black"},add:function(a){this.entities.push(a);this.numEntities++;a.patch=this},remove:function(a){for(var b=0;b<this.numEntities;++b)if(this.entities[b]===a){this.entities[b]=this.entities[this.numEntities-1];this.entities.pop();this.numEntities--;break}},addToUpdate:function(a){a.isQueuedUpdate||(this.updateBuffer.push(a),this.numToUpdate++,this.parent.entityMgr.isNeedUpdate=!0)},resetUpdateBuffer:function(){this.updateBuffer=[];this.numToUpdate=0},orderPreRender:function(){this.isNeedRender=
!0;this.isVisible&&(this.parent.isNeedRender=!0)},setVisible:function(a){a!==this.isVisible&&(a?this.addToVisible():this.removeFromVisible(),a&&!this.isRendered&&(this.isNeedRender=!0),this.isVisible=a)},addToVisible:function(){for(var a=0;a<this.numEntities;a++)this.entities[a].setVisibleBuffer(!0)},removeFromVisible:function(){for(var a=0;a<this.numEntities;a++)this.entities[a].setVisibleBuffer(!1)},isPointInside:function(a,b){return this.gridX>a||this.gridY>b||this.gridMaxX<=a||this.gridMaxY<=
b?!1:!0},parent:null,data:null,entities:null,numEntities:0,id:0,patchX:0,patchY:0,x:0,y:0,width:0,height:0,type:0,startX:0,startY:0,gridX:0,gridY:0,gridMaxX:0,gridMaxY:0,gridWidth:0,gridHeight:0,boundingAABB:null,gridAABB:null,cropAABB:null,texture:null,canvas:null,renderTarget:null,numLayers:1,isVisible:!1,isRendered:!1,isNeedRender:!0});
Patch.Isometric=Patch.Patch.extend({prepare:function(){this._super();this.startX=Math.floor(Terrain.Cfg.halfTileWidth)*this.parent.cfg.numTilesY;this.startY=Math.floor(Terrain.Cfg.halfTileHeight)},getNextPos:function(a){a.x+=Math.floor(Terrain.Cfg.halfTileWidth);a.y+=Math.floor(Terrain.Cfg.halfTileHeight);return a},getRowPos:function(a,b){a.x=this.startX-b*Math.floor(Terrain.Cfg.halfTileWidth);a.y=this.startY+b*Math.floor(Terrain.Cfg.halfTileHeight);return a},offsetX:0,offsetY:0});
Patch.TopDown=Patch.Patch.extend({getNextPos:function(a){a.x+=Terrain.Cfg.tileWidth;return a},getRowPos:function(a,b){a.x=0;a.y=Terrain.Cfg.tileHeight*b;return a}});
Patch.Grid=function(a,b,c,d){this.init=function(){this.cells=Array(this.numCells);this.cellInfo=new Patch.CellInfo(0,0);var a=this;SubscribeChannel(this,"Grid",function(b,c){return a.handleSignal_Grid(b,c)})};this.clear=function(){this.cells=null;UnsubscribeChannel(this,"Grid")};this.draw=function(a){for(var b=Terrain.Cfg.grid,c=new AABB(0,0,0,0),d,h=0;h<this.numCells;h++)if((d=this.cells[h])&&d.length)c.minX=h%this.sizeX*b.width,c.minY=Math.floor(h/this.sizeX)*b.height,c.maxX=c.minX+b.width,c.maxY=
c.minY+b.height,c.drawTranslated(a)};this.handleSignal_Grid=function(a,b){switch(a){case Grid.Event.IS_CELL_FULL:return this.isCellFull(b);case Grid.Event.GET_CELL:return this.getCellAt(b.gridX,b.gridY);case Grid.Event.GET_RANDOM_CELL:return this.getRandomCell()}return!1};this.remove=function(a){for(var b=this.cells[a.gridX+a.gridY*this.sizeX],c=b.length,d,h=0;h<c;h++)if(d=b[h],d===a){b.splice(h,1);break}};this.updateCell=function(a){if(-1<a.prevGridX){var b=this.cells[a.prevGridX+a.prevGridY*this.sizeX];
if(void 0!==b)for(var c=b.length,d,h=0;h<c;h++)if(d=b[h],d===a){b.splice(h,1);break}}b=a.gridX+a.gridY*this.sizeX;void 0===this.cells[b]?this.cells[b]=Array(a):this.cells[b].push(a)};this.getCellAt=function(a,b){return this.cells[a+b*this.sizeX]};this.isCellFull=function(a){var b=this.getCellAt(a.gridX,a.gridY);if(void 0===b)return null;if(a.isOnCell){if(void 0!==b&&1===b.length)return null}else if(void 0===b||0===b.length)return null;this.cellInfo.gridX=a.gridX;this.cellInfo.gridY=a.gridY;this.cellInfo.cell=
b;return this.cellInfo};this.getRandomCell=function(){var a=Random.getNumber(0,this.sizeX-1),b=Random.getNumber(0,this.sizeY-1),c=a+b*this.sizeX;this.cellInfo.gridX=a;this.cellInfo.gridY=b;this.cellInfo.cell=this.cells[c];return this.cellInfo};this.cellInfo=this.cells=null;this.width=a;this.height=b;this.sizeX=c;this.sizeY=d;this.numCells=c*d;this.init()};Patch.CellInfo=function(a,b){this.cell=null;this.gridX=a;this.gridY=b;this.isOnCell=!1};
Scene.State=Class.extend({init:function(){this.tScene=(new Date).getTime()},update:function(){var a=(new Date).getTime();this.tDelta=a-this.tUpdate;this.tUpdate=a},updateRender:function(){var a=(new Date).getTime();this.tDrawDelta=a-this.tScene;this.tScene=a;this.tFPS+=this.tDelta;this.tmpFPS++;1E3<=this.tFPS&&(this.tFPS=0,this.prevFPS=this.currentFPS,this.currentFPS=this.tmpFPS,this.tmpFPS=0,console.log("fps: "+this.currentFPS))},dischargeAccumulator:function(){this.tDelta=(new Date).getTime()-this.tScene;
this.tAccumulator-=this.tDelta},tDelta:0,tUpdate:0,tAccumulator:0,tDrawDelta:0,tScene:0,tFPS:0,tmpFPS:0,currentFPS:0,prevFPS:0});var gSceneState=null;
Scene.Manager=Class.extend({init:function(){mighty.engine.subscribe(this);this.engineCfg=Engine.Cfg;var a=this;this.updateFunc=function(){a.update()};this.renderFunc=function(){a.render()};this.chn_scene=CreateChannel("Scene");Scene.plugin=this},update:function(){var a=Date.now(),b=a-gTime;gTime=a;if(this.resourceMgr.isLoaded&&this.currentScene.isLoaded){100<b&&(b=100);for(this.tAccumulator+=b;this.tAccumulator>=this.engineCfg.tUpdateDelta;)this.currentScene.update(this.engineCfg.tUpdateDeltaF),this.tAccumulator-=
this.engineCfg.tUpdateDelta;this.isRendering||(this.isRendering=!0,this.render())}a=Date.now();b=a-gTime;a=Math.max(0,this.engineCfg.tSleep-b);window.setTimeout(this.updateFunc,a)},render:function(){if(mighty.engine.isVisible){var a=Date.now(),b=a-gRenderTime;gRenderTime=a;this.tFPS+=b;this.tmpFPS++;1E3<=this.tFPS&&(this.tFPS-=1E3,this.prevFPS=this.currentFPS,this.currentFPS=this.tmpFPS,this.tmpFPS=0,this.chn_scene.signal(Scene.Event.FPS,this.currentFPS));this.currentScene.render(this.tAccumulator/
this.engineCfg.tUpdateDelta,b);this.tFrameInfo+=Date.now()-a;this.numFramesRec++;60<=this.numFramesRec&&(this.tFrame=this.tFrameInfo/this.numFramesRec,this.chn_scene.signal(Scene.Event.TIME_FRAME,this.tFrame),this.numFramesRec=this.tFrameInfo=0)}requestAnimationFrame(this.renderFunc)},handleInput:function(a,b,c,d,e){switch(a){case "mouseMove":this.currentScene.handleMouseMove(b,d,e);break;case "mouseDown":this.currentScene.handleMouseDown(b,c,d,e);break;case "mouseUp":this.currentScene.handleMouseUp(b,
c,d,e);break;case "mouseClick":this.currentScene.handleMouseClick(b,c,d,e);break;case "mouseDbClick":this.currentScene.handleMouseDbClick(b,c,d,e);break;case "touchStart":this.currentScene.handleTouchStart(b,c);break;case "touchEnd":this.currentScene.handleTouchEnd(b,c);break;case "touchMove":this.currentScene.handleTouchMove(b,c);break;case "touchCancel":this.currentScene.handleTouchCancel(b,c);break;case "keyDown":this.currentScene.handleKeyDown(b,c);break;case "keyUp":this.currentScene.handleKeyUp(b,
c)}},handleResize:function(a,b){this.currentScene.handleResize(a,b)},setCurrentScene:function(a){gSceneState=a.state;mighty.engine.blockInput=!0;mighty.Template.removeAll();this.currentScene=a;this.currentScene.setup();gSceneState.update();this.tAccumulator=this.engineCfg.tUpdateDelta;this.isRendering=!1;this.resourceMgr=Resource.plugin},engineCfg:null,currentScene:null,resourceMgr:null,tScene:0,tAccumulator:0,updateFunc:null,renderFunc:null,chn_scene:null,tFPS:0,tmpFPS:0,currentFPS:0,prevFPS:0,tFrame:0,
tFrameInfo:0,numFramesRec:0,isRendering:!1});var gTime=Date.now(),gRenderTime=Date.now();
Scene.Base=Class.extend({init:function(){this.plugins={};this.pluginsBuffer=[];this.updatePlugins=[];this.renderPlugins=[];this.timerPlugins=[];this.state=new Scene.State;this.delayedSignals=[];var a=this.preparePlugin("Resource"),b=this.preparePlugin("Brush"),c=this.preparePlugin("Component");this.terrainMgr=this.preparePlugin("Terrain");this.patchMgr=this.preparePlugin("Patch");this.entityMgr=this.preparePlugin("Entity");var d=this.preparePlugin("Editor");this.input=this.preparePlugin("Input");
var e=this.preparePlugin("Map"),f=this.preparePlugin("i18n");a._install();c._install();this.patchMgr._install();this.patchMgr.install();this.terrainMgr._install();this.terrainMgr.install();b._install();this.entityMgr._install();this.entityMgr.install();d._install();d.install();this.input._install();this.input.install();e._install();e.install();a=this.preparePlugin("Cursor");a._install();a.install();f._install();f.install();a=[];b=PluginPalette;c=b.length;d=d=null;for(f=0;f<c;f++)if(d=window[b[f]],
d=d.Cfg,!d.disabled&&(!gParams.editor||d.useInEditor))(d=this.preparePlugin(b[f]))&&a.push(d);c=a.length;for(f=0;f<c;f++)d=a[f],d._install(),d.install();this.chn_scene=CreateChannel("Scene");var g=this;SubscribeChannel(this,"Scene.IN",function(a,b){g.handleSignal_SceneCtrl(a,b)})},setup:function(){mighty.engine.blockInput=!0;null===this.level&&this.createEmptyLevel()},load:function(){if(!this.isLoading){this.isLoading=!0;this.isLoaded&&(this.unload(),this.isLoaded=!1);this.isInstalled||(this.pluginsBuffer.sort(function(a,
c){return c.priority-a.priority}),this.updatePlugins.sort(function(a,c){return c.priority-a.priority}),this.renderPlugins.sort(function(a,c){return c.priority-a.priority}));this.camera||(this.camera=new Entity.Camera(this.entityMgr.createID()),mighty.engine.setCamera(this.camera));for(var a=0;a<this.numPlugins;++a)this.pluginsBuffer[a].load();this.camera.load();this.isLoading=!1;this.isLoaded=!0;mighty.engine.blockInput=!1;this.queuedLevel?(a=this.queuedLevel,this.queuedLevel=null,this.loadLevel(a)):
this.chn_scene.signal(Scene.Event.LOADED,this)}},unload:function(){this.numTimerPlugins=this.timerPlugins.length=0;for(var a,b=0;b<this.numPlugins;++b)a=this.pluginsBuffer[b],a._unload(),a.unload()},createEmptyLevel:function(a){if(void 0===a||0===a.id){var a=Palettes.Entity.getByName("null"),b=0;a&&(b=a.id);gParams.editor?a=new Scene.LevelInfo(-1,"null",1,1,b):(mighty.Error.error("Scene.createEmptyLevel","No data supplied, creating default empty map!"),a=new Scene.LevelInfo(-1,"default",32,32,b))}else a=
Palettes.Map.getByID(a.id).level,a=new Scene.LevelInfo(a.id,a.name,a.gridX,a.gridY,a.bgEntity);this.createLevel(a)},createLevel:function(a){var b=new Scene.Level(a);b.numTilesX=a.sizeX;b.numTilesY=a.sizeY;b.defaultEntityID=a.defaultEntityID;this.level=b;this.load()},saveLevel:function(){if(this.isLoaded)if(this.level){this.chn_scene.signal(Scene.Event.PRE_SAVE,this);var a=this.terrainMgr.getData(this.saveInBinary),b=this.entityMgr.getData(this.saveInBinary);console.log("TERRAIN_DATA:",a);SendSignal("Server",
Server.Event.SAVE_LEVEL,{action:"save",name:this.level.id,isBinary:this.saveInBinary,terrain:a,entity:b,saveOffline:Terrain.Cfg.offlineMode});this.chn_scene.signal(Scene.Event.POST_SAVE,this)}else mighty.Error.submit("Scene.saveLevel","No level file defined.");else mighty.Error.submit("Scene.saveLevel","Scene is not loaded yet.")},loadLevel:function(a){a||(a={id:0});this.isLoading?this.queuedLevel=a:(this.isLoaded&&(this.unload(),this.isLoaded=!1),this.level=new Scene.Level(a),SendSignal("Server",
Server.Event.LOAD_LEVEL,a))},loadLevelData:function(a,b){b&&(a=Map["level_"+a.id]);this.level.terrain=a.terrain;this.level.entity=a.entity;this.load()},update:function(a){if(!this.isPaused){var b;for(b=0;b<this.numUpdatePlugins;b++)this.updatePlugins[b].update(a);a*=1E3;for(b=0;b<this.numTimerPlugins;b++)this.timerPlugins[b].updateTimer(a);if(this.numDelayedSignals){for(b=0;b<this.numDelayedSignals;b++)a=this.delayedSignals[b],this.handleSignal_Scene(a.type,a.obj);this.delayedSignals=[];this.numDelayedSignals=
0}}},render:function(a,b){if(this.isLoaded)for(var c=0;c<this.numRenderPlugins;c++)this.renderPlugins[c].render(a,b)},handleMouseMove:function(a,b,c){b/=this.camera.zoomValue;c/=this.camera.zoomValue;this.input.handleMouseMove(a,b,c)},handleMouseDown:function(a,b,c,d){c/=this.camera.zoomValue;d/=this.camera.zoomValue;this.input.handleMouseDown(a,b,c,d)},handleMouseUp:function(a,b,c,d){c/=this.camera.zoomValue;d/=this.camera.zoomValue;this.input.handleMouseUp(a,b,c,d)},handleMouseClick:function(a,
b,c,d){c/=this.camera.zoomValue;d/=this.camera.zoomValue;this.input.handleMouseClick(a,b,c,d)},handleMouseDbClick:function(a,b,c,d){c/=this.camera.zoomValue;d/=this.camera.zoomValue;this.input.handleMouseDbClick(a,b,c,d)},handleTouchStart:function(a){this.input.handleTouchStart(a)},handleTouchEnd:function(a){a.pageX/=this.camera.zoomValue;a.pageY/=this.camera.zoomValue;this.input.handleTouchEnd(a)},handleTouchMove:function(a){this.input.handleTouchMove(a)},handleTouchCancel:function(a){a.pageX/=this.camera.zoomValue;
a.pageY/=this.camera.zoomValue;this.input.handleTouchCancel(a)},handleKeyUp:function(a,b){this.input.handleKeyUp(a,b)},handleKeyDown:function(a,b){this.input.handleKeyDown(a,b)},handleResize:function(){this.patchMgr.updateView();this.entityMgr.isNeedRender=!0},preparePlugin:function(a){var b=window[a];if(void 0===b.Manager)return null;var c=new b.Manager(a);c.name=a;c.scope=b;c.scene=this;c._init();return b.plugin=c},addPlugin:function(a){this.plugins[a.name]=a;this.pluginsBuffer.push(a);this.numPlugins++;
void 0!==a.update&&(this.updatePlugins.push(a),this.numUpdatePlugins++);void 0!==a.render&&(this.renderPlugins.push(a),this.numRenderPlugins++)},addPluginTimer:function(a){this.timerPlugins.push(a);this.numTimerPlugins++;this.timerPlugins.sort(function(a,c){return c.priority-a.priority})},removePluginTimer:function(a){for(var b=0;b<this.numTimerPlugins;b++)this.timerPlugins[b]===a&&(this.timerPlugins[b]=this.timerPlugins[this.numTimerPlugins-1],this.timerPlugins.pop(),this.numTimerPlugins--);this.timerPlugins.sort(function(a,
b){return b.priority-a.priority})},prepareSignal_Scene:function(a,b){this.delayedSignals.push(new Channel.Event(a,b));this.numDelayedSignals++},handleSignal_SceneCtrl:function(a,b){switch(a){case Scene.Event.CREATE_LEVEL:return this.createLevel(b);case Scene.Event.GET_LEVEL:return this.level;case Scene.Event.LOAD_LEVEL:var c=Palettes.Map.getByName(b);console.log("LOOAD",c);if(null===c)break;this.loadLevel(c);break;case Scene.Event.LOAD_LEVEL_ID:c=Palettes.Map.getByID(b);if(null===c)break;this.loadLevel(c);
break;case Scene.Event.SET_PAUSE:this.isPaused=b;break;case Scene.Event.SAVE_LEVEL:this.saveLevel()}},getPluginByID:function(a){for(var b=0;b<this.numPlugins;++b){var c=this.pluginsBuffer[b];if(c.id===a)return c}return null},getPluginByName:function(a){a=this.plugins[a];return void 0===a?null:a},camera:null,chn_scene:null,plugins:null,pluginsBuffer:null,numPlugins:0,updatePlugins:null,renderPlugins:null,timerPlugins:null,numUpdatePlugins:0,numRenderPlugins:0,numTimerPlugins:0,input:null,entityMgr:null,
terrainMgr:null,patchMgr:null,isLoaded:!1,isLoading:!1,isInstalled:!1,isPaused:!1,state:null,delayedSignals:null,numDelayedSignals:0,level:null,queuedLevel:null,saveInBinary:!1,loadInBinary:!1});Scene.Level=function(a){this.clear=function(){delete this.terrain;delete this.entity};this.data=a;this.id=a.id;this.name=a.name;this.numTilesY=this.numTilesX=0;this.entity=this.terrain=this.defaultEntityID=null};
Scene.LevelInfo=function(a,b,c,d,e){this.id=a;this.name=b;this.sizeX=c;this.sizeY=d;this.defaultEntityID=e};Brush.Manager=Plugin.extend({});var BrushEvent=Class.extend({UNKNOWN:0,TYPE:"Brush",LOADED:1});
Brush.Basic=Class.extend({init:function(){this.stages={};this.available={};this.actions={};this.component={}},setup:function(a,b,c){this.id=a;this.name=b;this.texture=c;this.addStage(0,this.texture,null);this.texture&&(this.width=this.texture.width,this.height=this.texture.height);if(this.texture)if(!1===this.texture.isLoaded){var d=this;this.texture.subscribe(this,function(a,b){d.handleSignal_Resource(a,b)})}else this.handleSignal_Resource(Resource.Event.LOADED,this.texture)},loadVar:function(a){for(var b in a)this[b]=
a[b]},load:function(a){this.loadStages(a.stages);this.loadComponents(a.component);this.loadAvailable(a.available)},update:function(){this.texture&&this.updateOffset()},clone:function(){var a=new Brush.Basic;a.setup(this.id,this.name,this.texture);a.stages=this.stages;a.component=this.component;a.available=this.available;return a},updateOffset:function(){this.drawOffsetX=this.offsetX+this.texture.offsetX;this.drawOffsetY=this.offsetY+this.texture.offsetY},subscribe:function(a,b){this.channel||(this.channel=
CreateChannel("brush_"+this.id));this.channel.subscribe(a,b,Priority.MEDIUM)},unsubscribe:function(a,b){this.channel&&(this.channel.unsubscribe(b),0>=this.channel.numSubscribers&&RemoveChannel(this.channel))},handleSignal_Resource:function(a){switch(a){case Resource.Event.LOADED:this._finishLoad();break;case Resource.Event.REPLACE:this.texture=event.src}},_finishLoad:function(){this.width=this.texture.width;this.height=this.texture.height;this.isLoaded=!0;this.channel&&this.channel.signal(Brush.Event.LOADED,
this)},loadStages:function(a){if(void 0!==a)for(var b=a.length,c=0;c<b;c++){var d=a[c],e=Resource.plugin.module.Texture.getByID(d.texture);d.options.flip!==Resource.Flip.NONE&&(e=e.flip(d.options.flip));this.addStage(d.type,e,d.options)}},loadComponents:function(a){if(void 0!==a){var b=Component.Obj;if(b){this.component={};for(var c=a.length,d=0;d<c;d++){var e=a[d],f=b[e.component];if(void 0===f)console.log("(Warning) Brush: No such component with id - "+e.component);else{var g=new Component[f],i;
for(i in e)g[i]=e[i];this.component[f]=g}}}}},loadAvailable:function(a){if(void 0!==a)for(var b=a.length,c=0;c<b;c++)this.available[a[c]]=!0},addStage:function(a,b,c){c=new Brush.StageInfo(a,b,c);b&&(c.width=b.width,c.height=b.height);0===this.numStages?this.defaultStage=c:b&&this.defaultStage.texture&&(b.width!=this.defaultStage.texture.width&&(c.diffX=Math.ceil((b.width-this.defaultStage.texture.width)/2)),b.height!=this.defaultStage.texture.height&&(c.diffY=Math.ceil((b.height-this.defaultStage.texture.height)/
2)));this.stages[a]=c;this.numStages++},getStage:function(){return this.stages[0]},isAvailable:function(a){return this.id===a.id?!1:void 0!==this.available[a.type]||void 0!==a.available[this.type]?!0:!1},getPreviewTexture:function(){return this.preview?this.preview:this.texture},id:-1,name:"",type:0,texture:null,preview:null,depthIndex:0,width:0,height:0,offsetX:0,offsetY:0,drawOffsetX:0,drawOffsetY:0,channel:null,isLoaded:!1,stages:null,defaultStage:null,numStages:0,component:null,available:null,
actions:null,isUpdatePreview:!1,isModifier:0});Brush.StageInfo=function(a,b,c){this.id=a;this.texture=b;this.options=c;this.diffY=this.diffX=this.height=this.width=0};
Brush.Entity=Brush.Basic.extend({init:function(){this._super();this.depthIndex=1},create:function(){var a=Entity.Obj[this.entityType];if("undefined"===typeof a)return console.log('(error) EntityBrush: Tried to create "'+this.name+'" with entityType: '+this.entityType),null;a=new Entity[a];a.setup(this);return a},updateOffset:function(){var a=Terrain.Cfg;switch(a.type){case Terrain.Type.ISOMETRIC:this.drawOffsetX=-(this.gridSizeX*a.halfTileWidth),this.drawOffsetY=-this.texture.height+this.gridSizeY*
a.halfTileHeight}this._super()},getStage:function(){return this.exes[Brush.Stage.DEFAULT]},entityType:0,isSolid:!0,isRandFrame:!1});
Brush.Tile=Brush.Basic.extend({init:function(){this._super();this.interacts=[]},setup:function(a,b,c,d,e){"undefined"===typeof d&&(d=0);this._super(a,b,c);this.layerIndex=d;"undefined"===typeof e&&(e=0);this.depthIndex=e},updateOffset:function(){switch(Terrain.Cfg.type){case Terrain.Type.ISOMETRIC:this.drawOffsetX=-(this.gridSizeX*Terrain.Cfg.halfTileWidth),this.drawOffsetY=-(this.depthIndex*Terrain.Cfg.tileDepth)-Terrain.Cfg.halfTileHeight}},addInteract:function(a){this.interacts.push(a);this.numInteracts++},
removeInteract:function(a){for(var b=0;b<this.numInteracts;++b)if(this.interacts[b]===a){this.interacts[b]=this.interacts[this.numInteracts-1];this.interacts.pop();this.numInteracts--;break}},isInteractive:function(a){if(1<a.numLayers)return!1;for(var b=0;b<this.numInteracts;++b)if(0==a.getLayerByType(this.interacts[b]))return!0;return!1},isInteractiveLayer:function(a,b){if(a.numLayers>=this.layerIndex){var c=a.layers[this.layerIndex];if("undefined"!==typeof c)switch(c.layerType){case LayerType.TEMPORARY:case LayerType.WITH_TEMPORARY:if(b===
LayerType.TEMPORARY)return!1}}return this.isInteractive(a)},fillType:0,layerIndex:0,depthIndex:0,depthOffset:0,interacts:null,numInteracts:0,canUpdate:!1});
Entity.Loader=new function(){this.convertToBinary=function(a){for(var b=new ByteBuffer(1E3),c=Patch.Cfg.numPatchs,d=0;d<c;++d)for(var e=a.patchMgr.patchs[d],f=0;f<e.numEntities;++f){var g=e.entities[f];g.brush.type!==GameObject.DECAL&&(b.writeShort(g.gridX),b.writeShort(g.gridY),b.writeShort(g.brush.id))}return b.getData()};this.convertToJSON=function(a){var b={data:[]},c,d,e,f;e=null;for(var g=Patch.Cfg.numPatchs,i=0;i<g;++i){c=a.patchMgr.patchs[i];d=c.numEntities;for(var h=0;h<d;++h)if(e=c.entities[h],
e.isSaved){f={};f.x=e.getCenterX();f.y=e.getCenterY();f.templateID=e.template.id;if(e=e.onSave())f.data=e;b.data.push(f)}}c=a.patchMgr.boundsPatch;d=c.numEntities;for(h=0;h<d;++h)e=c.entities[h],e.isSaved&&(f={},f.x=e.getCenterX(),f.y=e.getCenterY(),f.templateID=e.template.id,b.data.push(f));return b};this.loadFromBinary=function(a){var b=a.level.buffer;if(null!==b){b.setData(a.level.entity);do{var c=b.readShort(),d=b.readShort(),e=b.readShort(),e=a.palette.getByID(e);null!==e&&(e=e.create(),e.setGridPos(c,
d),this.add(e))}while(!b.eof())}};this.loadFromJSON=function(a){this._loadStaticGrid(a);this._loadEntities(a)};this._loadStaticGrid=function(a){Terrain.plugin.level=a.level;Terrain.plugin.prepareTerrain(a.level.terrain)};this._loadEntities=function(a){Terrain.Cfg.grid.use&&(a.grid=a.patchMgr.grid);var b=a.level.entity;if(b)for(var b=b.data,c=b.length,d,e,f,g=null,i=0;i<c;++i)d=b[i],e=parseInt(d.x),f=parseInt(d.y),g=d.data,d=parseInt(d.templateID),d=a.palette.getByID(d),null!==d&&(d=d.create(),d.x=
e,d.y=f,d.onLoad(g),a.add(d))}};
Entity.Geometry=Entity.Basic.extend({setup:function(a){this.node=new DepthListNode(this);this.animNode=new DepthListNode(this);this.brush=a;this.brush||(this.brush=Palettes.Brush.getByName("error"));this.setupVolume();this.updateVolume();this.isNeedUpdate=!0},activate:function(){this.centerOffsetX=this.brush.width/2;this.centerOffsetY=this.brush.height/2;this.x-=this.centerOffsetX;this.y-=this.centerOffsetY;this.calcDrawOffset();this.updateVolume();this.isPaused&&this.setPause(!0);var a=this;this.brush.subscribe(this,
function(b,c){a.handleSignal_Brush(b,c)});this.brush.isLoaded&&this.handleSignal_Brush(Brush.Event.LOADED,this.brush)},remove:function(){this.isNeedRemove?mighty.Error.submit("GeometryEntity.removeSelf()","Invalid call. Possible that was already removed."):(this.isVisible=!1,this.isNeedRemove=!0,this.parent.remove(this))},_removeSelf:function(){this.patch&&(this.removeUpdating(),this.parent.removeFromMap(this),this.patch.remove(this),this.patch=null,this.parent.grid&&this.parent.grid.remove(this))},
draw:function(a){if(this.texture){var b=Math.floor(this.drawX+this.brush.drawOffsetX+mighty.camera.x),c=Math.floor(this.drawY+this.brush.drawOffsetY+mighty.camera.y);if(this.filters){var d,e=this.filters.length;if(this.texture.isAnimated)for(d=0;d<e;d++)this.texture.drawFilter(a,b,c,this.currFrame,this.filters[d]);else for(d=0;d<e;d++)this.texture.drawFilter(a,b,c,this.filters[d])}else this.texture.isAnimated?this.texture.draw(a,b,c,this.currFrame):this.texture.draw(a,b,c)}this.isDrawBounds&&(a.strokeStyle=
"red",this.volume.drawTranslated(a));this.isNeedDraw=!1},_drawTransformed:function(a){var b=this.drawX+this.centerOffsetX+mighty.camera.x,c=this.drawY+this.centerOffsetY+mighty.camera.y;a.save();a.translate(b,c);a.scale(this.scaleX,this.scaleY);a.rotate(-this.angle);a.translate(-b,-c);if(this.texture)if(b=Math.floor(this.drawX+this.brush.drawOffsetX+mighty.camera.x),c=Math.floor(this.drawY+this.brush.drawOffsetY+mighty.camera.y),this.filters){var d,e=this.filters.length;if(this.texture.isAnimated)for(d=
0;d<e;d++)this.texture.drawFilter(a,b,c,this.currFrame,this.filters[d]);else for(d=0;d<e;d++)this.texture.drawFilter(a,b,c,this.filters[d])}else this.texture.isAnimated?this.texture.draw(a,b,c,this.currFrame):this.texture.draw(a,b,c);this.isDrawBounds&&(a.strokeStyle="red",this.volume.drawTranslated(a));a.restore();this.isNeedDraw=!1},_drawMatrix:function(a){var b=this.drawX+this.centerOffsetX+mighty.camera.x,c=this.drawY+this.centerOffsetY+mighty.camera.y;a.save();a.translate(b,c);a.transform(this.matrix[0],
this.matrix[1],this.matrix[3],this.matrix[4],this.matrix[6],this.matrix[7]);a.translate(-b,-c);if(this.texture)if(b=Math.floor(this.drawX+this.brush.drawOffsetX+mighty.camera.x),c=Math.floor(this.drawY+this.brush.drawOffsetY+mighty.camera.y),this.filters){var d,e=this.filters.length;if(this.texture.isAnimated)for(d=0;d<e;d++)this.texture.drawFilter(a,b,c,this.currFrame,this.filters[d]);else for(d=0;d<e;d++)this.texture.drawFilter(a,b,c,this.filters[d])}else this.texture.isAnimated?this.texture.draw(a,
b,c,this.currFrame):this.texture.draw(a,b,c);this.isDrawBounds&&(a.strokeStyle="red",this.volume.drawTranslated(a));a.restore();this.isNeedDraw=!1},calcDrawOffset:null,_calcDrawOffset_TopDown:function(){},_calcDrawOffset_Isometric:function(){var a=Terrain.Cfg.grid;this.drawOffsetX=-(this.gridSizeX*a.halfWidth);this.drawOffsetY=-this.brush.height+a.halfHeight;this.brush.width<a.width&&(this.drawOffsetX+=a.halfWidth-this.brush.width/2);this.brush.height<a.height&&(this.drawOffsetY-=a.halfHeight-this.brush.height/
2)},updatePos:function(){var a=Terrain.Cfg,b,c;switch(a.type){case Terrain.Type.ISOMETRIC:b=-(this.gridX*a.halfTileWidth)+this.gridY*a.halfTileWidth+this.brush.drawOffsetX;c=this.gridY*a.halfTileHeight+this.gridX*a.halfTileHeight+this.brush.drawOffsetY;break;case Terrain.Type.TOP_DOWN:b=this.gridX*a.tileWidth+this.brush.drawOffsetX,c=this.gridY*a.tileHeight+this.brush.drawOffsetY}this.x=b;this.y=c},updateCenterOffset:function(){this.centerOffsetX=this.stage.width/2;this.centerOffsetY=this.stage.height/
2},updateAnim:function(a){if(this.texture&&(this.tAnim+=a,!(this.tAnim<this.texture.tAnimUpdate))){a=Math.floor(this.tAnim/this.texture.tAnimUpdate);this.tAnim-=this.texture.tAnimUpdate*a;if(this.isFlip){if(this.currFrame-=a,0>this.currFrame){this.currFrame=0;this.onAnimEnd();if(this.isAnimating){this.isNeedDraw=!0;return}this.currFrame=this.texture.numFrames-1}}else{this.currFrame+=a;if(this.currFrame>=this.texture.numFrames&&this.onAnimEnd&&(this.currFrame--,this.onAnimEnd(),this.isAnimating)){this.isNeedDraw=
!0;return}this.currFrame%=this.texture.numFrames}this.isNeedDraw=!0}},onAnimEnd:function(){},resetFrame:function(){this.currFrame=this.brush.isRandFrame?this.texture.getRandFrame():this.isFlip?this.texture.numFrames-1:0},setupVolume:function(){switch(this.volumeType){case Entity.VolumeType.AABB:this.generateVolumeFunc=this.generateAABB;this.updateVolumeFunc=this.updateAABB;break;case Entity.VolumeType.SPHERE:this.generateVolumeFunc=this.generateSphere,this.updateVolumeFunc=this.updateSphere}},updateDepth:null,
_updateDepth_TopDown:function(){this.depth=this.gridX+this.gridY*Terrain.Cfg.sizeX+this.depthIndex;this.updateNodes();this.prevDepth=this.depth},_updateDepth_Isometric:function(){this.depth=this.gridY+this.gridX*Terrain.Cfg.sizeY;this.updateNodes();this.prevDepth=this.depth},_updateDepth_Manual:function(){this.depth=this.depthIndex;this.updateNodes();this.prevDepth=this.depth},updateNodes:function(){this.node.depth=this.depth;this.animNode.depth=this.depth;this.patch&&this.patch.remove(this);if(this.patch=
this.parent.patchMgr.getPatchFromGridPos(this.gridX,this.gridY))this.patch.add(this),this.patch.isVisible?this.setVisibleBuffer(!0):this.setVisibleBuffer(!1);this.isVisibleBuffer&&(this.parent.visibleEntities.update(this.node),this.isAnimating&&this.parent.animEntities.update(this.animNode))},addAnimating:function(){this.isAnimating||(this.isAnimating=!0,this.parent.addAnimating(this))},removeAnimating:function(){this.isAnimating&&(this.parent.removeAnimating(this),this.isAnimating=!1)},setPause:function(a){this.isPaused=
a;this.texture&&this.texture.isAnimated&&(a?(this.removeAnimating(),this.isAnimated=!1):(this.addAnimating(),this.isAnimated=!0))},addToUpdate:function(){this.isUpdating||(this.parent.addUpdating(this),this.addAnimating(this),this.isUpdating=!0)},removeUpdating:function(){this.isUpdating&&(this.parent.removeUpdating(this),this.isUpdating=!1)},onInputClicked:function(){},onInputPressed:function(){},onInputDragged:function(){},onInputOver:function(){},onInputMoved:function(){},handleSignal_Brush:function(a){switch(a){case Brush.Event.LOADED:this.updateStage(),
this.load(),this._loadComponents(),this.isLoaded=!0}},move:function(a,b){this.x===a&&this.y===b||(this.x=a,this.y=b,this.drawX=a+this.drawOffsetX,this.drawY=b+this.drawOffsetY,this.parent.updateGridPos(this),this.updateVolume(),this.updateDepth(),this.isNeedStage=this.isNeedDraw=!0)},moveSilently:function(a,b){this.x===a&&this.y===b||(this.x=a,this.y=b,this.drawX=a+this.drawOffsetX,this.drawY=b+this.drawOffsetY,this.updateVolume(),this.isNeedDraw=!0)},forceMove:function(a,b){this.x=a;this.y=b;this.drawX=
a+this.drawOffsetX;this.drawY=b+this.drawOffsetY;this.parent.updateGridPos(this);this.updateVolume();this.updateDepth()},translate:function(a,b){this.move(this.x+a,this.y+b)},setGridPos:function(a,b){this.gridX=a;this.gridY=b;this.updatePos();this.updateVolumeFunc()},setDepth:function(a){this.depthIndex=a;this.updateDepth();this.isNeedDraw=!0},setVisible:function(a){this.isVisible!==a&&(this.isVisible=a,!a&&this.parent.grid&&this.parent.grid.remove(this),this.isNeedDraw=!0)},setVisibleBuffer:function(a){this.isVisibleBuffer!==
a&&(a?this.parent.visibleEntities.push(this.node):this.parent.visibleEntities.remove(this.node),this.isVisibleBuffer=a)},setDrawBounds:function(a){this.isDrawBounds=a;this.isNeedDraw=!0},setAngle:function(a){this.angle=ToRadians(a);this.draw=this._drawTransformed;this.isNeedDraw=!0},setAngleRad:function(a){this.angle=a;this.draw=this._drawTransformed;this.isNeedDraw=!0},setScale:function(a,b){this.scaleX=a;this.scaleY=b;this.draw=this._drawTransformed;this.isNeedDraw=!0},setMatrix:function(a){this.matrix=
a;this.draw=this._drawMatrix;this.isNeedDraw=!0},isInside:function(a,b){return this.volume.vsBorderPoint(a,b)},isInsidePerPx:function(a,b){if(this.texture){var c=a-this.drawX,d=b-this.drawY;return 50<=(this.texture.isAnimated?this.texture.getDataAt(c,d,this.currFrame):this.texture.getDataAt(c,d))[3]?!0:!1}},updateStage:function(){var a=this.getStage();this.isNeedStage=!1;this.stage!==a&&(this.setStage(a),this.isNeedDraw=!0)},setStage:function(a){a&&this.stage&&(a.width!==this.stage.width||a.height!==
this.stage.height)&&this.volume.resize(68,78);(this.stage=a)?(this.texture=this.stage.texture,this.stage.options&&(this.isFlip=this.stage.options.flip!==Resource.Flip.NONE)):this.texture=this.brush.texture;this.texture&&this.texture.isAnimated?(this.resetFrame(),this.isAnimated=!0,this.isPaused||this.addAnimating()):0!==this.effect?this.addAnimating():this.isAnimated=!1},getStage:function(){return this.brush.getStage(this)},getMinDistance:function(a){var b=Math.abs(this.gridX-a.gridX),a=Math.abs(this.gridY-
a.gridY);return Math.min(b,a)},getTopLeftX:function(){return this.x+this.drawOffsetX+this.brush.offsetX},getTopLeftY:function(){return this.y+this.drawOffsetY+this.brush.offsetY},getCenterX:function(){return this.x+this.centerOffsetX},getCenterY:function(){return this.y+this.centerOffsetY},getDistanceToEntity:function(a){return Length2(this.x-a.x,this.y-a.y)},generateAABB:function(){var a=this.drawX+this.brush.drawOffsetX,b=this.drawY+this.brush.drawOffsetY;this.volume=new DrawAABB(a,b,a+this.brush.width,
b+this.brush.height)},updateAABB:function(){this.volume.move(this.drawX+this.brush.drawOffsetX,this.drawY+this.brush.drawOffsetY)},generateSphere:function(){var a=this.brush.width/2,b=this.brush.height/2;this.volume=new Sphere(this.drawX+this.brush.width/2,this.drawY+this.brush.height/2,a>=b?a:b)},updateSphere:function(){this.volume.move(this.x,this.y)},updateVolume:function(){this.volume?this.updateVolumeFunc():this.generateVolumeFunc()},generateVolumeFunc:function(){},updateVolumeFunc:function(){},
collide:function(a,b){switch(b){case 1:return this.volume.vsBorderAABB(a);case 2:return this.volume.vsSphere(a)}return!1},lookAt:function(a,b){return-Math.atan2(a-this.getCenterX(),this.getCenterY()-b)},lookAtEntity:function(a){return this.lookAt(a.getCenterX(),a.getCenterY())},addFilter:function(a){null===this.filters?this.filters=[a]:this.filters.push(a);this.isNeedDraw=!0},removeFilter:function(a){for(var b=this.filters.length,c=0;c<b;c++)if(this.filters[c]===a){this.filters.splice(c,1);break}0===
b-1&&(this.filters=null);this.isNeedDraw=!0},removeAllFilters:function(){this.filters=null;this.isNeedDraw=!0},x:0,y:0,drawX:0,drawY:0,prevDepth:NaN,depth:0,depthIndex:0,gridX:-1,gridY:-1,prevGridX:-1,prevGridY:-1,drawOffsetX:0,drawOffsetY:0,centerOffsetX:0,centerOffsetY:0,angle:0,scaleX:1,scaleY:1,matrix:null,gridSizeX:1,gridSizeY:1,node:null,animNode:null,updateNodeID:0,volumeType:Entity.VolumeType.AABB,volume:null,patch:null,texture:null,brush:null,stage:null,isFlip:!1,template:null,isVisible:!0,
isVisibleBuffer:!1,isNeedUpdate:!1,isUpdating:!1,isUpdatePause:!1,isInterpolatePause:!1,isNeedDraw:!0,isNeedRedraw:!1,isNeedStage:!0,isNeedRemove:!1,isDrawBounds:!1,currFrame:1,tAnim:0,isAnimated:!1,isAnimating:!1,isPaused:!1,effect:0,ownerEntity:null,decalEntity:null,isInputOver:!1,isPickable:!1,filters:null});
Cursor.Manager=Plugin.extend({init:function(){this.name="Cursor";this.volume=new AABB(0,0,0,0);this.priority=Priority.LOW-1E4},initCfg:function(){this.cfg.halfStepSizeX=Math.round(this.cfg.stepSizeX/2);this.cfg.halfStepSizeY=Math.round(this.cfg.stepSizeY/2)},install:function(){this.patchMgr=this.scene.patchMgr;var a=this;SubscribeChannel(this,"Engine",function(b,c){a.handleSignal_Engine(b,c)});this.chn_input=SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,c)},Priority.HIGH);SubscribeChannel(this,
"Scene",function(b,c){a.handleSignal_Scene(b,c)})},load:function(){this.invalidFilter=new Material.Color;this.invalidFilter.setRGBA(255,100,100,210)},unload:function(){},update:function(){this.prevX=this.x;this.prevY=this.y},updatePos:function(a,b){var c=Terrain.Cfg,d=mighty.camera;this.screenX=a-d.x;this.screenY=b-d.y;var e=this.screenX/d.zoom,d=this.screenY/d.zoom;this.prevStepX=this.stepX;this.prevStepY=this.stepY;var f=1,g=1;this.isSnapping&&(f=this.cfg.stepSizeX,g=this.cfg.stepSizeY);switch(c.type){case Terrain.Type.TOP_DOWN:this.stepX=
Math.floor(e/f);this.stepY=Math.floor(d/g);break;case Terrain.Type.ISOMETRIC:this.isSnapping?(this.stepX=Math.round(d/g-e/f),this.stepY=Math.round(e/f+d/g)):(this.stepX=Math.floor(e/f),this.stepY=Math.floor(d/g))}this.prevGridX=this.gridX;this.prevGridY=this.gridY;switch(c.type){case Terrain.Type.TOP_DOWN:this.gridX=Math.floor(e/c.grid.width);this.gridY=Math.floor(d/c.grid.height);break;case Terrain.Type.ISOMETRIC:f=Math.floor(c.grid.width),g=Math.floor(c.grid.height),this.gridX=Math.round(d/g-e/
f),this.gridY=Math.round(e/f+d/g)}g=f=1;this.isSnapping&&(f=this.cfg.stepSizeX,g=this.cfg.stepSizeY);this.prevX=this.x;this.prevY=this.y;switch(c.type){case Terrain.Type.TOP_DOWN:this.x=this.stepX*f;this.y=this.stepY*g;break;case Terrain.Type.ISOMETRIC:this.isSnapping?(this.x=this.stepY*this.cfg.halfStepSizeX-this.stepX*this.cfg.halfStepSizeX,this.y=this.stepY*this.cfg.halfStepSizeY+this.stepX*this.cfg.halfStepSizeY):(this.x=this.stepX*f,this.y=this.stepY*g)}this.entity&&this.entity.move(this.x,this.y);
this.drawX=this.x+this.drawOffsetX;this.drawY=this.y+this.drawOffsetY;this.volume.move(this.drawX,this.drawY);this.isVisible=!1;this.patchMgr.level&&this.patchMgr.getPatchFromGridPos(this.gridX,this.gridY)&&(this.isVisible=!0)},handleSignal_Engine:function(a,b){switch(a){case Engine.Event.CAMERA:this.camera=b}},handleSignal_Input:function(a,b){if(mighty.camera)switch(a){case Input.Event.MOVED:this.handleInput_Move(b.x,b.y);break;case Input.Event.KEY_DOWN:b.keyCode===Input.Key.SHIFT&&(this.isSnapping=
!1);break;case Input.Event.KEY_UP:b.keyCode===Input.Key.SHIFT&&(this.isSnapping=!0)}},handleInput_Move:function(a,b){var c=mighty.camera,a=Math.floor(a*c.zoom),b=Math.floor(b*c.zoom);this.isDragActive&&(this.isDrag=!0,c.drag(a,b));this.updatePos(a,b)},handleMouseDown:function(a,b,c){var d=mighty.camera,b=Math.floor(b*d.zoom),c=Math.floor(c*d.zoom);a===Input.Key.BUTTON_LEFT&&(this.isDragActive=!0,this.clear(),d.drag(b,c))},handleMouseClick:function(a){a===Input.Key.BUTTON_LEFT&&(this.isDrag=this.isDragActive=
!1,mighty.camera.endDrag())},handleSignal_Scene:function(a){switch(a){case Scene.Event.PRE_SAVE:return this.doPreSave(),!0;case Scene.Event.POST_SAVE:return this.doPostSave(),!0}return!1},doPreSave:function(){this.usePreSave&&(this.entity&&this.prevIsSaved)&&(this.entity.depthIndex=this.prevDepthIndex,this.entity.isSaved=this.prevIsSaved,this.entity.move(this.entityPrevX,this.entityPrevY))},doPostSave:function(){this.usePreSave&&(this.entity&&this.prevIsSaved)&&(this.entity.depthIndex=6E3,this.entity.isSaved=
!1,this.entity.move(this.x,this.y))},setInvalid:function(a){this.isInvalid!==a&&((this.isInvalid=a)?this.entity.addFilter(this.invalidFilter):this.entity.removeFilter(this.invalidFilter))},setEntity:function(a){this.entity&&this.entity!==a&&(this.entity.setDepth(this.prevDepthIndex),this.entity.isSaved=this.prevIsSaved);null===a&&this.isInvalid&&this.entity.removeFilter(this.invalidFilter);(this.entity=a)?(this.prevIsSaved=this.entity.isSaved,this.prevDepthIndex=this.entity.depthIndex,this.entity.depthIndex=
6E3,this.entity.isSaved=!1,this.entityPrevX=this.entity.x,this.entityPrevY=this.entity.y,this.entity.move(this.x,this.y),this.isInvalid&&this.entity.addFilter(this.invalidFilter)):this.offsetY=this.offsetX=0},getCenterX:function(){return this.x-this.offsetX},getCenterY:function(){return this.y-this.offsetY},isChanged:function(){return this.x!==this.prevX||this.y!==this.prevY?!0:!1},cfg:null,camera:null,patchMgr:null,x:0,y:0,prevX:0,prevY:0,screenX:0,screenY:0,offsetX:0,offsetY:0,drawOffsetX:0,drawOffsetY:0,
gridX:0,gridY:0,prevGridX:0,prevGridY:0,stepX:0,stepY:0,prevStepX:0,prevStepY:0,drawX:0,drawY:0,entity:null,entityPrevX:0,entityPrevY:0,prevDepthIndex:0,prevIsSaved:0,usePreSave:!1,isShow:!1,isVisible:!1,isInvalid:!1,isDragActive:!1,isDrag:!1,isSnapping:!0,chn_input:null});
Terrain.Loader=new function(){this.convertToBinary=function(a){var b=new ByteBuffer(1648);b.writeInt(a.level.sizeX);b.writeInt(a.level.sizeY);b.writeShort(a.basicBrush.id);for(var c=a.data.length,d=0;d<c;++d){var e=a.data[d];b.writeByte(e.numLayers);for(var f=0;f<e.numLayers;++f){var g=e.layers[f];"undefined"===typeof g?b.writeShort(0):g.brush.id===a.basicBrush.id?b.writeShort(0):b.writeShort(g.brush.id)}}return b.getData()};this.convertToJSON=function(a){var b=Entity.plugin.instance;if(b){var c=
a.level,d=c.terrain.sizeX*c.terrain.sizeY,e={};e.sizeX=c.terrain.sizeX;e.sizeY=c.terrain.sizeY;e.basicBrushID=a.clearEntity.id;e.data=Array(d);for(a=0;a<d;++a)e.data[a]=b[a].template.id;return e}}};
Terrain.Selector=function(a,b,c,d){this.init=function(a,b,c,d){switch(Terrain.Cfg.type){case Terrain.Type.TOP_DOWN:this.update=this._updateTopDown;break;case Terrain.Type.ISOMETRIC:this.update=this._updateIsometric}void 0!==a&&this.setBounds(a,b,c,d)};this.next=function(){if(this.gridX>=this.endGridX)return!1;this.gridX++;if(this.gridX>=this.endGridX&&(this.gridX=this.startGridX,this.gridY++,this.gridY>=this.endGridY))return this.gridY=this.endGridY,!1;this.update();return!0};this.prev=function(){if(this.gridX<
this.startGridX)return!1;this.gridX--;if(this.gridX<this.startGridX&&(this.gridX=this.endGridX-1,this.gridY--,this.gridY<this.startGridY))return this.gridY=this.startGridY,!1;this.update();return!0};this.reset=function(){this.gridX=this.startGridX;this.gridY=this.startGridY;this.update()};this.reverse=function(){this.gridX=this.endGridX-1;this.gridY=this.endGridY-1;this.update()};this.setBounds=function(a,b,c,d){0>a&&(a=0);0>b&&(b=0);0>c&&(c=0);0>d&&(d=0);a>this.cfg.numTilesX&&(a=this.cfg.numTilesX);
b>this.cfg.numTilesY&&(b=this.cfg.numTilesY);c>this.cfg.numTilesX&&(c=this.cfg.numTilesX);d>this.cfg.numTilesY&&(d=this.cfg.numTilesY);this.startGridX=a;this.startGridY=b;this.endGridX=c;this.endGridY=d;this.gridX=a;this.gridY=b;this.update();this.numTiles=(c-a)*(d-b)};this.setGridPos=function(a,b){this.gridX=a;this.gridY=b;this.update()};this.update=null;this._updateTopDown=function(){this.x=this.gridX*this.cfg.tileWidth;this.y=this.gridY*this.cfg.tileHeight};this._updateIsometric=function(){};this.cfg=
Terrain.Cfg;this.numTiles=this.endGridY=this.endGridX=this.startGridY=this.startGridX=this.gridY=this.gridX=this.y=this.x=0;this.init(a,b,c,d)};
Terrain.Manager=Plugin.extend({init:function(){this.priority=Priority.VERY_HIGH+101;this.typeToUpdate=[]},initCfg:function(){this.cfg.halfTileWidth=this.cfg.tileWidth/2;this.cfg.halfTileHeight=this.cfg.tileHeight/2;var a=this.cfg.grid;a.halfWidth=a.width/2;a.halfHeight=a.height/2},install:function(){this.patchMgr=this.scene.patchMgr;this.entityMgr=this.scene.entityMgr;var a=this;this.chn_terrain=SubscribeChannel(this,"Terrain.IN",function(b,c){return a.handleSignal_Terrain(b,c)})},unload:function(){this.level=
null;this.typeToUpdate=[];this.numTypeUpdates=0},prepareTerrain:function(a){var b=Palettes.Entity;a?(this.level.terrain=a,this.level.numTilesX=a.sizeX,this.level.numTilesY=a.sizeY,this.clearEntity=b.getByID(a.basicBrushID)):(this.clearEntity=b.getByName("null"),0<this.level.defaultEntityID&&(this.clearEntity=b.getByID(this.level.defaultEntityID),this.clearEntity||(this.clearEntity=b.getByName("null"))));this.create()},create:function(){this.cfg.width=this.level.numTilesX*this.cfg.tileWidth;this.cfg.height=
this.level.numTilesY*this.cfg.tileHeight;var a=this.level.numTilesX,b=this.level.numTilesY;this.level.terrain&&(a=this.level.terrain.sizeX,b=this.level.terrain.sizeY);this.level.sizeX=a;this.level.sizeY=b;this.cfg.numTiles=a*b;this.cfg.numTilesX=a;this.cfg.numTilesY=b;this.cfg.sizeX=a;this.cfg.sizeY=b;var c=null;if(this.level.terrain)c=this.level.terrain.data;else var d=this.level.numTilesX*this.level.numTilesY,c=Array(d);var e=new Entity.InstanceGridBuffer;e.buffer=c;e.entityBuffer=[this.clearEntity];
var f=0;this.clearEntity&&(f=this.clearEntity.id);for(var g=0;g<d;g++)c[g]=f;null===this.level.terrain&&(this.level.terrain={},this.level.terrain.sizeX=a,this.level.terrain.sizeY=b);this.level.terrain.data=c;Patch.plugin.create(this.level);SendSignal("Entity.IN",Entity.Event.LOAD_GRID_INSTANCE,e)},resize:function(a){var b=this.level.terrain.data,c=null,c=a.gridX*a.gridY,d=a.gridX,e=a.gridY;if(this.level.terrain.sizeX*this.level.terrain.sizeY!==c){for(var c=Array(c),f=this.level.terrain.sizeX,g=this.level.terrain.sizeY,
i=0,h=0,j=Math.min(d,f),k=Math.min(e,g),h=0;h<k;h++)for(i=0;i<j;i++)c[i+h*d]=b[i+h*f];if(d>f){for(h=0;h<k;h++)for(i=j;i<d;i++)c[i+h*d]=b[0];if(e>g)for(h=k;h<e;h++)for(i=0;i<d;i++)c[i+h*d]=b[0]}else if(e>g)for(h=k;h<e;h++)for(i=0;i<j;i++)c[i+h*d]=b[0]}else c=b;a.bgEntity=Number(a.bgEntity);b=a.bgEntity;Palettes.Entity.getByID(b)||(b=Palettes.Entity.getByName("null").id,0===a.bgEntity&&(a.bgEntity=b));if(!this.clearEntity||this.clearEntity.id!==a.bgEntity)a=mighty.Macro.CreateEntityID(b),a.setVisible(!1),
a.isSaved=!1,this.changeBgEntity(a,c);this.level.terrain.data=c;this.level.sizeX=d;this.level.sizeY=e;this.level.terrain.sizeX=d;this.level.terrain.sizeY=e;Entity.plugin.instance=c;Patch.plugin.updateView()},changeBgEntity:function(a,b){if(!a||!b)mighty.Error.submit("Terrain.changeBgEntity","Invalid parameters.");else{var c=-1;this.clearEntity&&(c=this.clearEntity.id);for(var c=Entity.plugin.instanceEntities[c],d=b.length,e=0;e<d;e++)b[e]===c&&(b[e]=a);this.clearEntity=a.template;Entity.plugin.instanceEntities[this.clearEntity.id]=
a}},update:function(){this.updateTypes(!1)},updateTypes:function(a){if(this.needTypeUpdate||a){for(a=0;a<this.numTypeUpdates;a++)this.updateType(this.typeToUpdate[a]);this.needTypeUpdate=!1}},updateType:function(a){for(var b=this.level.numTilesX*this.level.numTilesY,c=0;c<b;++c){var d=this.data[c],e=d.getLayerByType(a);-1<e&&d.update(this,e)}},addTypeUpdate:function(a){for(var b=0;b<this.numTypeUpdates;b++)if(this.typeToUpdate[b]===a)return;this.typeToUpdate.push(a);this.numTypeUpdates++;this.needTypeUpdate=
!0},brushTileAt:function(a,b,c){var d;void 0===a.fillType&&(a.fillType=0);switch(a.fillType){case Terrain.FillType.DEFAULT:d=b+c*this.cfg.numTilesX;this.data[d].setBrush(a,!1);break;case Terrain.FillType.FLOOD:var e=b-1;d=c-1;var f=b+1,g=c+1;0>e&&(e=0);0>d&&(d=0);f>this.cfg.numTilesX&&(f=this.cfg.numTilesX);g>this.cfg.numTilesY&&(g=this.cfg.numTilesY);for(var i=d;i<=g;++i)for(var h=e;h<=f;++h)d=h+i*this.cfg.numTilesX,b!==h||c!==i?this.data[d].setBrush(a,!0):this.data[d].setBrush(a,!1)}this.updateTypes(!0)},
brushTiles:function(a,b,c,d,e){for(var f=!1;c<e;c++)for(var g=b;g<d;g++)this.data[g+c*this.cfg.numTilesX].setBrush(this,a)!==Terrain.StatusType.NO_CHANGES&&(f=!0);return f},clearTile:function(a,b){this.data[a+b*this.cfg.numTilesX].clearNextLayer()},handleMouseMove:function(){(this.currGridX!==Cursor.plugin.gridX||this.currGridY!==Cursor.plugin.gridY)&&this.updateMode(Cursor.plugin.gridX,Cursor.plugin.gridY);this.currGridX=Cursor.plugin.gridX;this.currGridY=Cursor.plugin.gridY},handleSignal_Terrain:function(a,
b){switch(a){case Terrain.Event.RESIZE:return this.resize(b),!0}return!1},isTileAvailable:function(a,b,c){return 0>=a||a>=this.cfg.numTilesX-1||0>=b||b>=this.cfg.numTilesY-1?null:this.data[a+b*this.cfg.numTilesX].isAvailable(c)},getTileAt:function(a,b){return 0>a||a>=this.level.numTilesX||0>b||b>=this.level.numTilesY?null:this.data[a+b*this.level.numTilesX]},getTileWithTypeAt:function(a,b,c){if(0>a||a>=this.level.numTilesX||0>b||b>=this.level.numTilesY)return null;a=this.data[a+b*this.level.numTilesX];
return a.isType(c)?a:null},getData:function(a){return a?Terrain.Loader.convertToBinary(this):Terrain.Loader.convertToJSON(this)},getPositionFromGrid:function(a,b){var c=new Vector2(0,0);switch(this.cfg.type){case Terrain.Type.TOP_DOWN:c.x=a*this.cfg.tileWidth,c.y=b*this.cfg.tileHeight}return c},camera:null,patchMgr:null,entityMgr:null,level:null,data:null,clearEntity:null,currGridX:-1,currGridY:-1,typeToUpdate:null,numTypeUpdates:0,needTypeUpdate:!1,chn_terrain:null});
Editor.Manager=Plugin.extend({install:function(){gParams.editor&&(this.cfg.useEditor=!0);var a=this;SubscribeChannel(this,"Editor",function(b,c){a.handleSignal(b,c)});this.prevStepSizeX=Cursor.Cfg.stepSizeX;this.prevStepSizeY=Cursor.Cfg.stepSizeY;this.useLayer(Entity.Layer.ENTITY)},handleSignal:function(a,b){switch(a){case Editor.Event.SET_LAYER:return this.useLayer(b),!0;case Editor.Event.USE_ITEM:return this.useItem(b),!0;case Editor.Event.USE_ITEM_ID:return this.useItemID(b),!0;case Editor.Event.SET_MODE:return this.setMode(b),
!0;case Editor.Event.GET_LAYER:return Entity.plugin.activeLayerID;case Editor.Event.GET_MODE:return this.currModule.mode}return!1},useModule:function(a){console.log("use layer",a);var b=mighty.GetModule("Entity","Editor-"+a);if(b!==this.currModule&&("TERRAIN"===a?(Cursor.Cfg.stepSizeX=Terrain.Cfg.tileWidth,Cursor.Cfg.stepSizeY=Terrain.Cfg.tileHeight):(Cursor.Cfg.stepSizeX=this.prevStepSizeX,Cursor.Cfg.stepSizeY=this.prevStepSizeY),this.cancelModule(),this.currModule=b))this.currModule.activate(),
this.currModule.userMgr=this},useLayer:function(a){if(this.cfg.useEditor){var b=mighty.Macro.GetEventString("Entity","Layer",a);void 0!==b&&(this.useModule(b),Entity.plugin.activeLayerID=a)}},cancelModule:function(){this.currModule&&this.currModule.deactivate();this.currModule=null},useItem:function(a){this.currModule&&this.currModule.useItem(a)},useItemID:function(a){this.currModule&&this.currModule.useItemID(a)},setMode:function(a){this.currModule&&this.currModule.setMode(a)},currModule:null,prevStepSizeX:0,
prevStepSizeY:0});
mighty.CreateModule("Entity","Editor-TERRAIN",{activate:function(){var a=this;SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,c)});SubscribeChannel(this,"EntityInteract",function(b,c){a.handleSignal_EntityInteract(b,c)})},deactivate:function(){UnsubscribeChannel(this,"Input");UnsubscribeChannel(this,"EntityInteract");this.setMode(Editor.Mode.SELECT);this._overEntity&&this._overEntity.setDrawBounds(!1)},setMode:function(a){if(this.mode!==a){switch(this.mode){case Editor.Mode.SELECT:this.clearMode_SELECT();break;
case Editor.Mode.ADD:this.clearMode_ADD();break;case Editor.Mode.MOVE:this.clearMode_MOVE();break;case Editor.Mode.REMOVE:this.clearMode_REMOVE()}this.mode=a;switch(this.mode){case Editor.Mode.ADD:this.setupMode_ADD();break;case Editor.Mode.MOVE:this.setupMode_MOVE();break;case Editor.Mode.REMOVE:this.setupMode_REMOVE()}}},clearMode_SELECT:function(){this.entity&&(this.entity.setDrawBounds(!1),this.entity=null)},clearMode_ADD:function(){this.entity&&this.entity.remove();this.entity=null;Cursor.plugin.setEntity(null)},
clearMode_MOVE:function(){this.entity&&(this.entity.move(this._tmpMoveX,this._tmpMoveY),this.entity=null,Cursor.plugin.setEntity(this.entity))},clearMode_REMOVE:function(){},setupMode_ADD:function(){this.entity&&(Cursor.plugin.setEntity(this.entity),this.updateMode_ADD())},setupMode_MOVE:function(){},setupMode_REMOVE:function(){},updateMode:function(){switch(this.mode){case Editor.Mode.ADD:this.updateMode_ADD();break;case Editor.Mode.MOVE:this.updateMode_MOVE();break;case Editor.Mode.REMOVE:this.updateMode_REMOVE()}},
updateMode_ADD:function(){this.checkIfAllowed()},updateMode_MOVE:function(){this.checkIfAllowed()},updateMode_REMOVE:function(){this.isAvailable=this.mgr.getFromPosPx(Cursor.plugin.screenX,Cursor.plugin.screenY)?!0:!1},checkIfAllowed:function(){if(this.entity&&this.userMgr.cfg.disallowDuplicates){Cursor.plugin.setInvalid(!1);var a=this.mgr.getFromPosEx(Cursor.plugin.screenX,Cursor.plugin.screenY,this.entity);a&&a.template===a.template&&(a.x===this.entity.x&&a.y===this.entity.y)&&Cursor.plugin.setInvalid(!0)}},
overMode:function(a){switch(this.mode){case Editor.Mode.SELECT:this.overMode_SELECT(a);break;case Editor.Mode.MOVE:this.overMode_SELECT(a);break;case Editor.Mode.REMOVE:this.overMode_SELECT(a)}},overMode_SELECT:function(a){a.setDrawBounds(!0);this.overEntity=a},doMode:function(){if(this.isAvailable)switch(this.mode){case Editor.Mode.SELECT:this.doMode_SELECT();break;case Editor.Mode.ADD:this.doMode_ADD();break;case Editor.Mode.MOVE:this.doMode_MOVE();break;case Editor.Mode.REMOVE:this.doMode_REMOVE()}},
doMode_SELECT:function(){!this.overEntity&&this.entity&&(this.entity.setDrawBounds(!1),this.entity=null)},doMode_ADD:function(){if(this.entity){var a=Cursor.plugin;if(!a.isInvalid){var b=Terrain.Cfg,c=Math.floor(a.x/b.tileWidth),a=Math.floor(a.y/b.tileHeight),b=c+a*b.numTilesX;console.log(b,c,a);Entity.plugin.setGridInstance(b,this.entity);this.updateMode_ADD()}}},doMode_MOVE:function(){this.entity?Cursor.plugin.isInvalid||(this.entity=null,Cursor.plugin.setEntity(null)):this.overEntity&&(this.entity=
this.overEntity,Cursor.plugin.setEntity(this.entity))},doMode_REMOVE:function(){this.overEntity&&(Entity.plugin.activeLayerID===Entity.Layer.TERRAIN?Entity.plugin.removeGridInstance():(this.overEntity.remove(),this.overEntity=null))},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:this.updateMode();break;case Input.Event.KEY_DOWN:this.handleKeyDown(b.keyCode);break;case Input.Event.CLICKED:this.doMode()}},handleSignal_EntityInteract:function(a,b){switch(a){case Entity.Event.OVER_ENTER:this.overMode(b);
break;case Entity.Event.OVER_EXIT:b&&this.overEntity!==b&&b.setDrawBounds(!1);this.overEntity=b;break;case Entity.Event.CLICKED:if(this.entity===b)break;if(this.mode!==Editor.Mode.SELECT)break;this.entity&&this.entity.setDrawBounds(!1);this.entity=b;this.entity.setDrawBounds(!0)}},handleKeyDown:function(a){if(this.entity)switch(this.mode){case Editor.Mode.SELECT:this.keyDownMode_SELECT(a)}},keyDownMode_SELECT:function(a){switch(a){case Input.Key.ARROW_DOWN:this.entity.move(this.entity.x,this.entity.y+
1);break;case Input.Key.ARROW_UP:this.entity.move(this.entity.x,this.entity.y-1);break;case Input.Key.ARROW_LEFT:this.entity.move(this.entity.x-1,this.entity.y);break;case Input.Key.ARROW_RIGHT:this.entity.move(this.entity.x+1,this.entity.y)}},useItem:function(a){this.entity&&this.entity.remove();this.entity=mighty.Macro.CreateEntity(a);this.mode===Editor.Mode.ADD&&this.setupMode_ADD()},useItemID:function(a){this.entity&&this.entity.remove();this.entity=mighty.Macro.CreateEntity(Palettes.Entity.getByID(a).name);
this.mode===Editor.Mode.ADD&&this.setupMode_ADD()},entity:null,overEntity:null,mode:Editor.Mode.NONE,layer:Entity.Layer.ENTITY,isAvailable:!0,_overEntity:null,_tmpMoveX:0,_tmpMoveY:0});
mighty.CreateModule("Entity","Editor-ENTITY",{activate:function(){var a=this;SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,c)});SubscribeChannel(this,"EntityInteract",function(b,c){a.handleSignal_EntityInteract(b,c)});this.mode=Editor.Mode.SELECT},deactivate:function(){UnsubscribeChannel(this,"Input");UnsubscribeChannel(this,"EntityInteract");this.setMode(Editor.Mode.SELECT);this.entity&&this.entity.setDrawBounds(!1);this._overEntity&&this._overEntity.setDrawBounds(!1)},setMode:function(a){if(this.mode!==
a){this.isAvailable=!0;switch(this.mode){case Editor.Mode.SELECT:this.clearMode_SELECT();break;case Editor.Mode.ADD:this.clearMode_ADD();break;case Editor.Mode.MOVE:this.clearMode_MOVE();break;case Editor.Mode.REMOVE:this.clearMode_REMOVE()}this.mode=a;switch(this.mode){case Editor.Mode.ADD:this.setupMode_ADD();break;case Editor.Mode.MOVE:this.setupMode_MOVE();break;case Editor.Mode.REMOVE:this.setupMode_REMOVE()}}},clearMode_SELECT:function(){this.entity&&(this.entity.setDrawBounds(!1),this.entity=
null)},clearMode_ADD:function(){this.entity&&this.entity.remove();this.entity=null;Cursor.plugin.setEntity(null)},clearMode_MOVE:function(){Cursor.plugin.usePreSave=!1;this.entity&&(this.entity.move(this._tmpMoveX,this._tmpMoveY),this.entity=null,Cursor.plugin.setEntity(this.entity))},clearMode_REMOVE:function(){},setupMode_ADD:function(){this.entity&&(Cursor.plugin.setEntity(this.entity),this.updateMode_ADD())},setupMode_MOVE:function(){Cursor.plugin.usePreSave=!0},setupMode_REMOVE:function(){},
updateMode:function(){switch(this.mode){case Editor.Mode.ADD:this.updateMode_ADD();break;case Editor.Mode.MOVE:this.updateMode_MOVE();break;case Editor.Mode.REMOVE:this.updateMode_REMOVE()}},updateMode_ADD:function(){this.checkIfAllowed()},updateMode_MOVE:function(){this.checkIfAllowed()},updateMode_REMOVE:function(){this.isAvailable=this.mgr.getFromPosPx(Cursor.plugin.screenX,Cursor.plugin.screenY)?!0:!1},checkIfAllowed:function(){if(this.entity&&this.userMgr.cfg.disallowDuplicates){Cursor.plugin.setInvalid(!1);
this.isAvailable=!0;var a=this.mgr.getFromPosEx(Cursor.plugin.screenX,Cursor.plugin.screenY,this.entity);a&&(a.template===a.template&&a.x===this.entity.x&&a.y===this.entity.y)&&(Cursor.plugin.setInvalid(!0),this.isAvailable=!1)}},overMode:function(a){switch(this.mode){case Editor.Mode.SELECT:this.overMode_SELECT(a);break;case Editor.Mode.MOVE:this.overMode_SELECT(a);break;case Editor.Mode.REMOVE:this.overMode_SELECT(a)}},overMode_SELECT:function(a){a.setDrawBounds(!0);this.overEntity=a},doMode:function(){if(this.isAvailable)switch(this.mode){case Editor.Mode.SELECT:this.doMode_SELECT();
break;case Editor.Mode.ADD:this.doMode_ADD();break;case Editor.Mode.MOVE:this.doMode_MOVE();break;case Editor.Mode.REMOVE:this.doMode_REMOVE()}},doMode_SELECT:function(){!this.overEntity&&this.entity&&(this.entity.setDrawBounds(!1),this.entity=null)},doMode_ADD:function(){this.entity&&!Cursor.plugin.isInvalid&&(Entity.plugin.activeLayerID===Entity.Layer.TERRAIN?Entity.plugin.setGridInstance():(this.entity=mighty.Macro.CreateEntity(this.entity.name),Cursor.plugin.setEntity(this.entity)),this.updateMode_ADD())},
doMode_MOVE:function(){this.entity?Cursor.plugin.isInvalid||(this.entity=null,Cursor.plugin.setEntity(null)):this.overEntity&&(this.entity=this.overEntity,Cursor.plugin.setEntity(this.entity))},doMode_REMOVE:function(){this.overEntity&&(Entity.plugin.activeLayerID===Entity.Layer.TERRAIN?Entity.plugin.removeGridInstance():(this.overEntity.remove(),this.overEntity=null))},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:this.updateMode();break;case Input.Event.KEY_DOWN:this.handleKeyDown(b.keyCode);
break;case Input.Event.CLICKED:this.doMode()}},handleSignal_EntityInteract:function(a,b){switch(a){case Entity.Event.OVER_ENTER:this.overMode(b);break;case Entity.Event.OVER_EXIT:this.entity!==b&&b.setDrawBounds(!1);this.overEntity=null;break;case Entity.Event.CLICKED:if(this.entity===b)break;if(this.mode!==Editor.Mode.SELECT)break;this.entity&&this.entity.setDrawBounds(!1);this.entity=b;this.entity.setDrawBounds(!0)}},handleKeyDown:function(a){if(this.entity)switch(this.mode){case Editor.Mode.SELECT:this.keyDownMode_SELECT(a)}},
keyDownMode_SELECT:function(a){switch(a){case Input.Key.ARROW_DOWN:this.entity.move(this.entity.x,this.entity.y+1);break;case Input.Key.ARROW_UP:this.entity.move(this.entity.x,this.entity.y-1);break;case Input.Key.ARROW_LEFT:this.entity.move(this.entity.x-1,this.entity.y);break;case Input.Key.ARROW_RIGHT:this.entity.move(this.entity.x+1,this.entity.y)}},useItem:function(a){this.entity&&this.entity.remove();this.entity=mighty.Macro.CreateEntity(a);this.mode===Editor.Mode.ADD&&this.setupMode_ADD()},
useItemID:function(a){this.entity&&this.entity.remove();var b=Palettes.Entity.getByID(a);null===b?mighty.Error.submit("EntityEditor.useItemID","No such item with id '"+a+"'"):(this.entity=mighty.Macro.CreateEntity(b.name),this.mode===Editor.Mode.ADD&&this.setupMode_ADD())},entity:null,overEntity:null,mode:-1,isAvailable:!0,_overEntity:null,_tmpMoveX:0,_tmpMoveY:0});
Entity.Camera=Entity.Basic.extend({init:function(a){this.cfg=Camera.Cfg;this.terrainCfg=Terrain.Cfg;this.id=a;this.name="Camera";this.viewFrustum=new AABB(0,0,0,0);var b=this;this.createUniqueChannel();SubscribeChannel(this,"Engine",function(a,d){return b.handleSignal_Engine(a,d)},Priority.HIGH);SubscribeChannel(this,"Input",function(a,d){return b.handleSignal_Input(a,d)},Priority.HIGH);void 0!==gParams.editor&&(this.isEditor=!0)},load:function(){this.resetView();this.chn_unique.signal(Camera.Event.MOVED,
null);var a=this.cfg.position;if(a.type===Camera.Position.FOLLOW)if(this.isEditor)this.cfg.position.type=Camera.Position.CENTER;else{a=Ask("Entity.IN",Entity.Event.GET_BY_TYPE,a.gameObject);if(!a)return;this.setFollowEntity(a);this.chn_unique.signal(Camera.Event.MOVED,null)}this.isEditor&&(this.cfg.position.isDrag=!0,this.cfg.position.ignoreBorder=!0)},update:function(){if(this.followEntity){var a=-(this.followEntity.getCenterX()-this.width/2),b=-(this.followEntity.getCenterY()-this.height/2);if(a!==
this.prevFollowX||b!==this.prevFollowY)this.x=a,this.y=b,this.cfg.isIgnoreBorder||(0<this.x?this.x=0:this.x-this.width<-this.terrainCfg.width&&(this.x=-(this.terrainCfg.width-this.width)),0<this.y?this.y=0:this.y-this.height<-this.terrainCfg.height&&(this.y=-(this.terrainCfg.height-this.height))),this.viewFrustum.move(-this.x,-this.y),this.chn_unique.signal(Camera.Event.MOVED,null),this.prevFollowX=a,this.prevFollowY=b}},updateViewFrustum:function(){this.viewFrustum.resize(this.width,this.height);
this.viewFrustum.move(-this.x,-this.y)},updateView:function(){if(this.cfg.zoom.useAutoZoom){var a=1/mighty.engine.width*Terrain.Cfg.width,b=1/mighty.engine.height*Terrain.Cfg.height,c=a;b>a&&(c=b);this.zoom=c;this.defaultZoom=this.zoomValue=1/c}this.width=Math.ceil(mighty.engine.width*this.zoom);this.height=Math.ceil(mighty.engine.height*this.zoom);this.updateOffset();this.updateViewFrustum();mighty.engine.setZoom(this.zoomValue)},updateOffset:function(){var a=this.offsetX,b=this.offsetY;switch(this.cfg.position.type){case Camera.Position.DEFAULT:this.offsetY=
this.offsetX=0;break;case Camera.Position.CENTER:this.offsetX=Math.max(0,Math.floor((this.width-Terrain.Cfg.width)/2));this.offsetY=Math.max(0,Math.floor((this.height-Terrain.Cfg.height)/2));break;case Camera.Position.H_CENTER:this.offsetX=Math.floor((this.width-Terrain.Cfg.width)/2);break;case Camera.Position.V_CENTER:this.offsetY=Math.max(0,Math.floor((this.height-Terrain.Cfg.height)/2));break;case Camera.Position.FOLLOW:this.followOffsetX=-(this.width/2),this.followOffsetY=-(this.height/2)}this.normalOffsetX=
Math.max(0,Math.floor((this.width-Terrain.Cfg.width)/2));this.normalOffsetY=Math.max(0,Math.floor((this.height-Terrain.Cfg.height)/2));a!==this.offsetX&&(this.x+=this.offsetX-a);b!==this.offsetY&&(this.y+=this.offsetY-b)},resetView:function(){var a=1;this.cfg.zoom.active&&(a=this.cfg.zoom.default,a<this.cfg.zoom.min&&(a=this.cfg.zoom.min),a>this.cfg.zoom.max&&(a=this.cfg.zoom.max));this.zoom=1/a;this.zoomValue=a;this.x=this.offsetX;this.y=this.offsetY;this.updateView()},drag:function(a,b){this.isPrepareDrag&&
(this.isPrepareDrag=!1,this.isDrag=!0);if(this.isDrag){var c=a-this.dragX,d=b-this.dragY;if(void 0===gParams.editor&&!this.cfg.position.ignoreBorder){var e=Terrain.Cfg;if(e.width>this.width){var f=-(this.x+c-this.offsetX),g=f+this.width;0>f?c=-this.x+this.offsetX:g>Terrain.Cfg.width&&0<-this.x+this.offsetX&&(c=-(this.x-this.width)-Terrain.Cfg.width)}else c=0;e.height>this.height?(e=-(this.y+d),f=e+this.height,0>e?d=-this.y-this.offsetY:f>Terrain.Cfg.height&&(d=-(this.y-this.height)-Terrain.Cfg.height)):
d=0}this.x+=c;this.y+=d;this.viewFrustum.translate(-c,-d);this.chn_unique.signal(Camera.Event.MOVED,null)}else this.isPrepareDrag=!0;this.dragX=a;this.dragY=b},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:if(this.cfg.position.isDrag&&(this.isPrepareDrag||this.isDrag))return this.drag(b.x,b.y),!0;break;case Input.Event.INPUT_DOWN:this.cfg.position.isDrag&&b.keyCode===Input.Key.BUTTON_LEFT&&this.drag(b.x,b.y);break;case Input.Event.CLICKED:if(this.isPrepareDrag=!1,this.isDrag)return this.isDrag=
!1,!0}return!1},handleSignal_Engine:function(a){switch(a){case Engine.Event.RESIZE:this.updateView()}},handleFollowEntity:function(a){a===Entity.Event.REMOVED&&(this.followEntity=null,this.chn_Entity=SubscribeChannel(this,"Entity.OUT",function(a,c){return self.handleSignal_Entity(a,c)}))},move:function(a,b){this.x=-a;this.y=-b;this.updateViewFrustum();this.chn_unique.signal(Camera.Event.MOVED,null)},moveToGridPos:function(a,b){var c=Terrain.Cfg;switch(c.type){case Terrain.Type.ISOMETRIC:this.x=a*
c.halfTileWidth-b*c.halfTileWidth;this.y=-(b*c.halfTileHeight)-a*c.halfTileHeight;this.update();break;case Terrain.Type.TOP_DOWN:this.x=-(a*c.tileWidth),this.y=-(b*c.tileHeight),this.update()}this.updateViewFrustum();this.chn_unique.signal(Camera.Event.MOVED,null)},resetZoom:function(){this.zoomValue=this.zoom=this.defaultZoom;mighty.engine.setZoom(this.zoomValue)},zoomIn:function(){this.zoomValue!==this.maxZoom&&(this.zoomValue+=this.zoomStep,this.zoomValue=parseFloat(this.zoomValue.toFixed(2)),
this.zoomValue>this.maxZoom&&(this.zoomValue=this.maxZoom),this.zoom=1/this.zoomValue,this.zoom=parseFloat(this.zoom.toFixed(2)),mighty.engine.setZoom(this.zoomValue,!0))},zoomOut:function(){this.zoomValue!=this.minZoom&&(this.zoomValue-=this.zoomStep,this.zoomValue=parseFloat(this.zoomValue.toFixed(2)),this.zoomValue<this.minZoom&&(this.zoomValue=this.minZoom),this.zoom=1/this.zoomValue,this.zoom=parseFloat(this.zoom.toFixed(2)),mighty.engine.setZoom(this.zoomValue))},setZoom:function(a){a!==this.zoomValue&&
(this.zoom=1/a,this.zoomValue=a,this.updateView())},setFollowEntity:function(a){this.followEntity&&this.followEntity.unsubscribe(this);this.followEntity=a;this.prevFollowY=this.prevFollowX=0;a.subscribe(this,function(a,c){self.handleFollowEntity(a,c)})},cfg:null,terrainCfg:null,x:0,y:0,offsetX:0,offsetY:0,normalOffsetX:0,normalOffsetY:0,width:0,height:0,viewFrustum:null,chn_Engine:null,chn_Entity:null,chn_Camera:null,isDrag:!1,isPrepareDrag:!1,zoom:1,zoomValue:1,minZoom:0.6,maxZoom:2,defaultZoom:1,
zoomStep:0.1,followEntity:null,prevFollowX:0,prevFollowY:0,followOffsetX:0,followOffsetY:0,isEditor:!1});Map.Manager=Plugin.extend({loadPalette:function(){this._super();for(var a,b=this.scope.palette,c=b.length,d=0;d<c;d++)a=b[d],this.palette.getByID(a.id).level=a},token:"505d6e6c485121616f2b7b5562"});
i18n.Manager=Plugin.extend({init:function(){this.chn_i18n=CreateChannel("i18n.OUT")},install:function(){var a=this;SubscribeChannel(this,"i18n.IN",function(b,c){return a.handleSignal_i18n(b,c)});this.setLang(this.cfg.defaultLang)},loadPaletteAsTemplate:function(){for(var a=0,b={},c=Object.keys(this.scope.Lang),d=c.length,a=0;a<d;a++)b[c[a]]={};for(var e=this.scope.palette,f=e.length,g=null,i="",a=0;a<f;a++)for(var g=e[a],h=0;h<d;h++)i=g[c[h]],i.length&&(b[c[h]][g.key]=i);this.palette=b;Palettes.I18n=
b;delete i18n.palette},processHTML:function(a){if(!(a instanceof HTMLElement)){var b=document.createElement("div");b.innerHTML=a;a=b}for(var b=[],c=null,d=a.querySelectorAll("*"),e=0;e<d.length;e++)c=d[e].childNodes[0],d[e].hasChildNodes()&&3==c.nodeType&&(b.push(c),c.nodeValue=this.processText(c.nodeValue));return a},processWithCacheHTML:function(a,b){if(!(a instanceof HTMLElement)){var c=document.createElement("div");c.innerHTML=a;a=c}for(var c=null,d=a.querySelectorAll("*"),e=0;e<d.length;e++)c=
d[e].childNodes[0],d[e].hasChildNodes()&&3==c.nodeType&&(c.prevValue=c.nodeValue,c.nodeValue=this.processText(c.nodeValue),b.push(c));return a},processText:function(a){var b="",a=(""+a).split(this.cfg.replaceStart),c=null,d=0,e="",e="",f=a.length;if(1>=f)return a[0];var g=0;for(""===a[0]&&g++;g<f;g++)c=a[g],""===c?b+=this.cfg.replaceStart:(d=c.indexOf(this.cfg.replaceEnd),-1===d?b+=c:(e=c.substr(0,d),e=this.activeHolder[e],b=void 0!==e&&e.length?b+(e+c.substring(d+this.cfg.replaceEnd.length)):b+(this.cfg.replaceStart+
c)));return b},handleSignal_i18n:function(a,b){switch(a){case i18n.Event.PROCESS_HTML:return this.processHTML(b);case i18n.Event.PROCESS_TEXT:return this.processText(b);case i18n.Event.SET_LANG:return this.setLang(b),!0;case i18n.Event.GET_LANG:return this.currLang}return!1},setLang:function(a){this.currLang=a;this.activeHolder=this.palette?this.palette[mighty.Macro.GetEventString("i18n","Lang",a)]:{};this.chn_i18n.signal(i18n.Event.LANG_CHANGED,this.currLang)},currLang:-1,activeHolder:null,chn_i18n:null});
mighty.Macro={CreateEntity:function(a,b,c){a=new Entity.Info(Palettes.Entity.getByName(a),b,c);return Ask("Entity.IN",Entity.Event.ADD_FROM_INFO,a)},CreateEntityID:function(a,b,c){a=new Entity.Info(Palettes.Entity.getByID(a),b,c);return Ask("Entity.IN",Entity.Event.ADD_FROM_INFO,a)},GetEventString:function(a,b,c){var d=window[a];if(void 0===d)mighty.Error.submit("Macro::GetEventString","No such scope - "+a);else{a=null;if(""!==b){if(a=d[b],void 0===a){mighty.Error.submit("Macro::GetEventString","No such type in the scope - "+
b);return}}else a=d;for(var e in a)if(a[e]===c)return e;return"Unknown"}},GetStringFromObj:function(a,b){for(var c in a)if(a[c]===b)return c;return"NULL"},GetTextureByID:function(a){return Resource.plugin.module.Texture.getByID(a)},GetTextureByName:function(a){return Resource.plugin.module.Texture.getByName(a)},GetSoundByID:function(a){return Resource.plugin.module.Sound.getByID(a)},GetSoundByName:function(a){return Resource.plugin.module.Sound.getByName(a)},DrawCircle:function(a,b,c){Entity.plugin.updateScreen();
var d=mighty.context;d.beginPath();d.arc(a,b,c,0,2*Math.PI);d.stroke()},DrawRect:function(a,b,c,d){Entity.plugin.updateScreen();mighty.context.rect(a,b,c-a,d-b)},DrawRectSize:function(a,b,c,d){Entity.plugin.updateScreen();mighty.context.rect(a,b,c,d)}};
