'use strict';(function(){function O(a,b){function c(){}c.prototype=a;var e=new c,d;for(d in b)e[d]=b[d];return e}function r(a,b){var c=function(){return c.method.apply(c.scope,arguments)};c.scope=a;c.method=b;return c}var y=function(){return q.Boot.__string_rec(this,"")},K=function(a,b,c,e){this.engineIncludesFile="engine/LoaderIncludes.js";this.releaseMode=!1;this.project=a;this.editor=e;this.cbx=c;d.debug("Deploy:: Deploy started!",b);this.project.isBroken()?this.cb():(this.report={errors:"",warnings:"",
info:"",closureReport:"",release:""},this.options=b,this.branchId=b.branch,this.projectPath=a.getPath(),this.path=this.projectPath+"/"+k.string(d.cfg.deployPath)+"/"+k.string(this.branchId),a=this.projectPath+"/"+k.string(d.cfg.releasePath)+"/"+b.name,null!=b.releasePath&&""!=b.releasePath&&(a=b.releasePath+"/"+b.name),this.releasePath=a,this.resourcePath=this.path+"/default",this.engineIncludesFile=this.projectPath+"/"+this.engineIncludesFile,d.fs.existsSync(this.projectPath+"/engine/MightyLoader.js")&&
(this.releaseMode=!0),d.fs.exists(this.path,r(this,this.checkDirs)))};K.__name__=!0;K.prototype={runScript:function(){var a=this;if(this.options.script&&""!=this.options.script){var b=this.options.script;"/"!=b.substring(0,1)&&(b=this.projectPath+"/"+k.string(d.cfg.deployScriptsPath)+"/"+k.string(this.options.script));var c;c={cwd:this.releasePath+"/",env:process.env};b=d.path.resolve(b);d.debug("executing script",b);b=d.child.spawn(b,[this.project.name,this.project.getBranchName(this.branchId)],
c);b.on("exit",function(b){d.debug("Deploy Script::Gameserver -> process exited with code "+b);null!=a.editor&&("0"!=b?a.editor.emit("error","Deploy done: "+k.string(a.options.script)+" exited with error code: "+b):a.editor.emit("error","Deploy done - no errors"))});b.stdout.on("data",function(b){d.debug("Deploy Script ->\r\n--------------------",b.toString().replace("\n","\n\t")+"\r\n--------------------------------------");null!=a.editor&&a.editor.emit("error",b.toString())});b.stderr.on("data",
function(b){d.debug("Deploy Script ERROR ->\r\n--------------------",b.toString().replace("\n","\n\t")+"\r\n--------------------------------------");null!=a.editor&&a.editor.emit("error",b.toString())})}},parseIndex:function(a,b,c){var e=this;if(null!=a)d.debug("Deploy::parseIndex -> error reading file",a);else{var a=m.getTime(),b=m.splitInLines(b),f="",g="fullSources";this.options.useClosureCompiler&&(g="full.min");for(var i=0;i<b.length;){var h=b[i];++i;f+=k.string(h.replace(".css",".css?"+a).replace("engine/init.js",
g+".js?"+a).replace("engine/MightyLoader.js",g+".js?"+a).replace("debug.js",""))+"\r\n"}d.fs.writeFile(this.releasePath+"/index.html",f,"utf-8",function(a){null!=a?d.debug("Deploy full -> index create failed!!!"):(d.debug("Deploy options",e.options),null!=c&&c())})}},copySources:function(a,b,c){null==b&&(b=0);var e=this;if(b>=a.length)d.debug("source copied..",a),null!=c&&c();else{var f=new n,g=this.projectPath+a[b],i=this.releasePath+a[b];d.debug("Deploy::copySources -> copying:",g,i);f.mkdir(i,
function(){f.copy(g,i,function(){e.copySources(a,++b,function(){c()})})})}},minimizeSources:function(a){var b=this,c=null,c=["/assets/ui","/engine/library","/server","/src/templates"],e=new n;d.debug("Deploy::full -> removing old sources",this.releasePath);e.rmA(this.releasePath,function(){var f=new z(3,function(){d.debug("Deploy::DONE - full");b.cb()});b.copySources(c,0,r(f,f.done));d.fs.readFile(b.projectPath+"/index.html","utf-8",function(a,c){b.parseIndex(a,c,r(f,f.done))});a=a.split('"use strict";').join("");
d.fs.writeFile(b.releasePath+"/fullSources.js","var global = {};window.gParams = {release: true, rel: true};\r\n"+k.string(a)+"\r\n","utf-8",function(){b.report.release=d.path.resolve(b.releasePath);b.options.useClosureCompiler&&(f.add(),d.child.exec("java -jar bin/compiler.jar  --language_in "+k.string(b.options.closureCompiler.language_in)+" --compilation_level "+k.string(b.options.closureCompiler.compilation_level)+" "+k.string(b.options.closureCompiler.compilerFlags)+" --js "+b.releasePath+"/fullSources.js  --js_output_file "+
b.releasePath+"/full.min.js ",function(a,c,e){d.debug("stdout: "+c);d.debug("stderr: "+e);null!=a&&(d.fs.writeFile("closureReport.txt",a),d.debug("compilation done with errors"));""!=e&&(b.report.closureReport+=""+e+"\r\n");""!=c&&(b.report.closureReport+="Info: "+e+"\r\n")}).on("close",function(){null!=b.editor&&b.editor.emit("deployCompleted",b.report);d.debug("compilation done");f.done()}))});e.copy(b.path,b.releasePath+"/assets/deploy",r(f,f.done))},!0)},prepareSources:function(a){var b=this;
d.debug(this.releasePath);d.fs.exists(this.releasePath,function(c){c?b.minimizeSources(a):(new n).mkdir(b.releasePath,function(){b.minimizeSources(a)})})},parseIncludes:function(a,b,c){null==b&&(b="");var e=this;d.debug("Parsing Includes...");if(this.releaseMode){for(var f=0;f<a.length;){var g=a[f];++f;b+="//"+this.projectPath+"/"+g+"\r\n"+k.string(d.fs.readFileSync(this.projectPath+"/"+g,"utf-8"))+"\r\n"}c(b)}else d.fs.readFile(this.engineIncludesFile,"utf-8",function(f,g){if(f)d.debug("Deploy: Failed to parse Includes",
f);else{for(var l=m.splitInLines(g),t="",P="",s="",j=0;j<l.length;)s=l[j],++j,s=s.trim(),0==s.indexOf('loader.rootPath = "')?t=s.substring(19,s.lastIndexOf('"')):0==s.indexOf('loader.path = "')?P=s.substring(15,s.lastIndexOf('"')):0==s.indexOf('loader.include("')&&(s=s.substring(16,s.lastIndexOf('");')),s=t+P+s,b+="//"+e.projectPath+"/"+s+"\r\n"+k.string(d.fs.readFileSync(e.projectPath+"/"+s,"utf-8"))+"\r\n");for(j=0;j<a.length;)l=a[j],++j,b+="//"+e.projectPath+"/"+l+"\r\n"+k.string(d.fs.readFileSync(e.projectPath+
"/"+l,"utf-8"))+"\r\n";c(b)}})},loadBaseIncludes:function(a,b,c){null==c&&(c="");null==b&&(b=0);var e=this,f=null;d.debug(this.projectPath+"/engine/MightyLoader.js");this.releaseMode?(d.debug("REALEASE"),f=[this.path+"/library.js",this.projectPath+"/engine/MightyEngine.js",this.projectPath+"/src/main.js"]):(d.debug("DEBUG"),f=[this.projectPath+"/engine/release.js",this.projectPath+"/engine/library/class.js",this.projectPath+"/engine/utilities/Error.js",this.projectPath+"/engine/utilities/Channel.js",
this.projectPath+"/engine/utilities/template/TemplateCSS.js",this.projectPath+"/engine/utilities/template/Templates.js",this.projectPath+"/engine/utilities/info/Browser.js",this.projectPath+"/engine/Loader.js",this.path+"/library.js",this.projectPath+"/engine/Engine.js",this.projectPath+"/src/main.js"]);b>f.length-1?(d.debug("DONE includes"),a(c)):d.fs.readFile(f[b],"utf-8",function(f,i){null!=f?d.debug("Cannot find include: ",f):(c+=i,e.loadBaseIncludes(a,++b,c))})},deployIncludes:function(a){for(var b=
this,c='(mighty.Loader.path = (window.gParams.gPath ? window.gParams.gPath : ""));\r\n(function(){\r\nvar loader = mighty.Loader;\r\n',e=0;e<a.length;){var f=a[e];++e;c+='loader.include("'+f+'");\r\n'}d.fs.writeFile(this.path+"/includes.js",c+"})();\r\n","utf-8");this.options.full?(d.debug("Deploy::fullSources"),this.loadBaseIncludes(function(c){b.parseIncludes(a,c,r(b,b.prepareSources))})):(d.debug("Deploy::DONE"),this.cb())},collectIncludes:function(a,b,c){var e=this,f=new B(".*\\.js$",""),g=new B(".*\\.editor\\.js$",
""),i=[],h=b.Deploy.palette,l=new n;l.filterFn=function(a,b,c){if(c.isDirectory()){if(b==e.project.getPath()+"/"+k.string(d.cfg.pluginsPath)+"/"+a||b==e.project.getPath()+"/"+k.string(d.cfg.addonsPath)+"/"+a)for(c=0;c<h.length;){var l=h[c];++c;if(l.name==a)return l.disabled?(d.debug("Disabled plugin/addon",l),!1):!0}d.debug("Deploy: -> collect.. Skipping",a,b);return!1}if(g.match(a))return!0;f.match(a)&&(a=b.substring(b.indexOf("/src/")+1),i.push(a));return!0};l.scanDirFilterDirs(this.project.getPath()+
"/"+k.string(d.cfg.pluginsPath),function(){l.scanDirFilterDirs(e.project.getPath()+"/"+k.string(d.cfg.addonsPath),function(){c(i,a)})})},deployResource:function(a,b,c,e){var f=this,c=this.project.getPrivatePath();switch(b){case "Texture":null!=a.img&&null==a.image&&(a.image=a.img);b=c+"/upload/"+a.image;c=d.fs.statSync(b);a.ext=d.getExt(a.image);a.date=c.mtime.getTime();n.cp(b,this.resourcePath+"/img/"+a.id+"."+a.ext,e);delete a.image;break;case "Sound":null!=a.snd&&null==a.sound&&(a.sound=a.snd);
var g=c+"/upload/"+a.sound,i=d.fs.statSync(g);a.ext=d.getExt(a.sound);var h=this.resourcePath+"/snd/"+a.id;n.cp(g,h+"."+a.ext,function(){var b=[];"ogg"!=a.ext&&b.push(" -acodec libvorbis "+m.shellEscape(h+".ogg"));"mp3"!=a.ext&&b.push(m.shellEscape(h+".mp3"));d.child.exec("sh bin/audio -y -i "+m.shellEscape(g)+" "+b.join(" "),function(a){null!=a&&(d.debug("Deploy::Sound -> exec error: "+a),f.report.errors+="sound "+g+" failed with error: "+a+"\r\n");e()});"m4a"!=a.ext&&d.child.exec("sh bin/audio -y -i "+
m.shellEscape(g)+" -strict -2 -vn "+m.shellEscape(h+".m4a"));a.date=i.mtime.getTime();delete a.sound});break;default:b=c+"/upload/"+a.file,c=d.fs.statSync(b),a.ext=d.getExt(a.file),a.date=c.mtime.getTime(),n.cp(b,this.resourcePath+"/img/"+a.id+"."+a.ext,e),delete a.file}},addTemplates:function(a,b){if(this.options.full){null==a.Resource.Templates&&(a.Resource.Templates={});var c=new n;c.filterFn=function(b,c,e){if(e.isDirectory()){d.debug("Deploy -> templates");e="";d.fs.existsSync(c+"/"+b+".js")&&
(e=d.fs.readFileSync(c+"/"+b+".js","utf-8"));var h="";d.fs.existsSync(c+"/"+b+".html")&&(h=d.fs.readFileSync(c+"/"+b+".html","utf-8"));a.Resource.Templates[b]={js:e,html:h}}return!1};try{c.scanDirFilterDirs(this.projectPath+"/src/templates",b)}catch(e){this.report.errors+="template: "+this.projectPath+"/src/templates failed with error: "+k.string(e)+"\r\n"}}else b()},deployItems:function(a,b){var c=this,e=Object.keys(a),f,g=this.project.getPluginsType(),i=this.project.getAddonsType(),h=m.clone(b);
null==h.Resource?h.Resource={Templates:{}}:h.Resource.Templates={};var l,t,j=new z(1,function(){for(var a=Object.keys(h),b="",e=0;e<a.length;){var f=a[e];++e;"string"!=m.getType(f)?d.debug("Deploy->library: error",f):"[object Object]"==f?d.debug("Deploy->library: error",h):"Addon"!=f&&(b+="var "+k.string(f)+" = window."+k.string(f)+" = "+JSON.stringify(h[f],null,"\t")+";\r\n")}d.fs.writeFile(c.path+"/library.js",b,"utf-8",function(){c.collectIncludes(c.branchId,h,r(c,c.deployIncludes))})});h.Plugin||
(h.Plugin={});h.Resource||(h.Resource={});h.Plugin.palette||(h.Plugin.palette=[]);h.Deploy||(h.Deploy={});h.Deploy.palette||(h.Deploy.palette=[]);for(var s=0;s<e.length;)if(f=e[s],++s,t=this.project.resolveEnums(a[f],b),f=t.editor,delete t.editor,l=f.plugin||f.type)if(l==g)t.disabled||(h[t.name]||(h[t.name]={}),h[t.name].Cfg=t,"Core"!=f.origin&&(h.Plugin.palette.push(t.name),h.Deploy.palette.push(t)));else if(l==i)"Core"!=f.origin&&h.Deploy.palette.push(t);else if("Deploy"!=l){if("Resource"==l){j.add();
try{this.deployResource(t,f.type,this.resourcePath,r(j,j.done))}catch(p){d.debug("DEPLOY -> ERROR deployResource",t);this.report.errors+="resource: "+k.string(t.name)+" failed\r\n";continue}}t.skip||(h[l]?h[l].palette||(h[l].palette=[]):h[l]={palette:[]},h[l].palette.push(t))}j.add();this.addTemplates(h,r(j,j.done));j.done()},getIncludes:function(){var a=this;this.project.getImport(function(b,c,e){a.project.getAllItems(a.branchId,function(b){a.deployItems(b,e)})})},mkdirs:function(){var a=this;d.fs.exists(this.resourcePath,
function(b){b?a.getIncludes():a.cb()})},checkDirs:function(a){var b=this,c=new z(0,r(this,this.mkdirs)),e=new n;a?e.rmA(this.path,function(){d.fs.exists(b.resourcePath,function(a){a&&d.debug("Deploy:mkdirs","removing old dirs --- failed")});c.add(2);e.mkdir(b.resourcePath+"/img",function(){d.fs.mkdir(b.resourcePath+"/snd",r(c,c.done));d.fs.mkdir(b.resourcePath+"/res",r(c,c.done))})},!0):(c.add(2),e.mkdir(this.resourcePath+"/img",function(){d.fs.mkdir(b.resourcePath+"/snd",r(c,c.done));d.fs.mkdir(b.resourcePath+
"/res",r(c,c.done))}))},cb:function(){this.project.emitAll("deployDone",null);d.debug("Deploy:: Deploy DONE!",this.options);this.cbx(this.report);null!=this.options&&this.options.full&&this.runScript()},__class__:K};var F=function(a,b,c){null==c&&(c=!1);this.isStopping=!1;this.cbx=b;d.debug("custom watcher - started");this.dir=a;this.oldFiles={};this.collectFiles(a);this.forceUpdate=c};F.__name__=!0;F.prototype={stop:function(){console.log("DirWatcher stopped");this.isStopping=!0;if(null!=this.watchers)for(var a=
0,b=this.watchers;a<b.length;){var c=b[a];++a;c&&c.close()}},cb:function(a,b,c){this.isStopping||this.cbx(a,b,c)},pollingTimeout:function(){var a=this;this.isStopping||u.Timer.delay(function(){a.collectFiles(a.dir);a.forceUpdate&&a.cb(null,null,null)},d.cfg.watcherPollingTime)},compareFiles:function(a){var b=Object.keys(a),c=Object.keys(this.oldFiles);if(b.length!=c.length)d.debug("Watcher::FS changed:","file count not match"),this.cb(null,null,null);else for(var e=c=null,f=0;f<b.length;){var g=b[f];
++f;c=a[g];e=this.oldFiles[g];if(null==c||null==e){d.debug("Watcher::FS changed: no stats for file - deleted?:",g);delete a[g];delete oldFiles[g];this.cb(null,null,null);this.pollingTimeout();return}if(c.mtime.getTime()!=e.mtime.getTime()){d.debug("Watcher::FS changed: ",g);this.cb(null,c,null);this.oldFiles=a;this.pollingTimeout();return}}this.oldFiles=a;this.pollingTimeout()},collectFiles:function(a){var b=this,c={},e=new n;e.filterFn=function(a,b,d){return e.filterJs(a,b,d)||d.isDirectory()?(c[b]=
d,!0):!1};e.scanDirR(a,function(){b.compareFiles(c)})},__class__:F};var G=function(a,b){b.writeHead(404);b.end()};G.__name__=!0;G.prototype={__class__:G};var B=function(a,b){b=b.split("u").join("");this.r=RegExp(a,b)};B.__name__=!0;B.prototype={match:function(a){this.r.global&&(this.r.lastIndex=0);this.r.m=this.r.exec(a);this.r.s=a;return null!=this.r.m},__class__:B};var C=function(a){var b=this;this.socket=a;this.emitData={action:null,data:null};this.rooms=[];this.socket.on("action",function(a,e){var d=
b.action(a.action,a.data,e);null!=d&&null!=e&&e(d)})};C.__name__=!0;C.emitAllStatic=function(a,b,c){a={action:a,data:b};d.io.sockets["in"](c).emit("action",a)};C.prototype={emitAll:function(a,b){for(var c=0,e=this.rooms;c<e.length;){var f=e[c];++c;this.emitData.action=a;this.emitData.data=b;d.io.sockets["in"](f).emit("action",this.emitData)}},emit:function(a,b){this.emitData.action=a;this.emitData.data=b;this.socket.emit("action",this.emitData)},leaveAllRooms:function(){for(var a=0,b=this.rooms;a<
b.length;){var c=b[a];++a;this.leaveRoom(c)}},leaveRoom:function(a){v.remove(this.rooms,a);this.socket.leave(a)},joinRoom:function(a){for(var b=0,c=this.rooms;b<c.length;){var e=c[b];++b;if(e==a)return}this.rooms.push(a);this.emitAll("room joined","new participiant");this.socket.join(a)},action:function(a,b,c){var e=A.field(this,"a_"+a);if(A.isFunction(e))return e.apply(this,[b,c]);this.emit("FIXME",[a,b]);d.debug("Not an action function",a);return null},__class__:C};var H=function(a){C.call(this,
a);this.emit("setDemo",d.cfg.demoMode)};H.__name__=!0;H.__super__=C;H.prototype=O(C.prototype,{a_scripts:function(a,b){b()},a_export:function(a,b){d.debug("EXPORT called");this.project["export"](function(a){b(a)})},a_deploy:function(a,b){(null==a||null==a.branchId)&&d.debug("Editor: Error -> options not SET",a);null!=this.project&&this.project.deploy(a,b,this)},a_delBranch:function(a,b){this.project.deleteBranch(a.id,b)},a_setBranch:function(a,b){this.project.setBranch(a,b)},a_getBranchesTree:function(a,
b){this.project.getBranchesTree(a.branch,b)},a_del:function(a){a.id?this.project.delItem(a,function(){}):d.debug("Editor::a_del -> Delete unknown item",a)},a_set:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.setItem(a,function(a){b(a)});return null},a_get:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.getItems(a,b);return null},a_del_project:function(a){var b=this;p.rmProject(a.name,function(){(new n).rmA(k.string(d.cfg.projectPath)+
"/"+k.string(a.name),function(){b.a_get_projects(null,function(a){0<a.length?b.emitAll("setProject",a[0]):b.createNewProject("demo",function(){b.emitAll("setProject","demo")})})})})},createProjectDone:function(a,b,c){null!=a?d.debug("Editor::NewProject engine sources failed",a):this.emit("setProject",b);null!=c&&c()},createProjectCopy:function(a,b,c){var e=this;a.copy(d.cfg.engineSrcPath,k.string(d.cfg.projectPath)+"/"+b+"/engine",function(a){e.createProjectDone(a,b,c)})},createProjectSymlink:function(a,
b,c){var e=this;d.fs.symlink(d.cfg.engineSrcPath,k.string(d.cfg.projectPath)+"/"+b+"/engine","junction",function(f){null!=f?(d.debug("Warning: symlink failed, proceeding with copy"),e.createProjectCopy(a,b,c)):e.createProjectDone(null,b,c)})},createNewProject:function(a,b){var c=this,e=new n,f=d.cfg.defaultProjectTemplate;e.copy(k.string(d.cfg.newProjectTemplates)+"/"+f,k.string(d.cfg.projectPath)+"/"+a,function(){d.cfg.useSymlinks?c.createProjectSymlink(e,a,b):c.createProjectCopy(e,a,b)})},a_new_project:function(a,
b){var c=this;""==a.name?(this.emit("error","badName "+k.string(a.name)),b({error:1})):this.a_get_projects(null,function(e){for(var f=0;f<e.length;){var g=e[f];++f;if(g==a.name){c.emit("error","project exists "+k.string(a.name));b({error:1});return}}d.debug("NewProject::creating","about to copy");c.createNewProject(a.name,b)})},a_get_projects:function(a,b){var c=[],e=new n;e.filterFn=function(a,b,e){e.isDirectory()&&c.push(a);return!0};e.scanDirShallow(d.cfg.projectPath,function(){b(c)})},a_testItems:function(a,
b){this.project.checkAllItems(b)},a_getAllItems:function(a,b){null==a&&(a={branch:1});this.project.getAllItems(a.branch,function(a){b(a)})},a_setProject:function(a){var b=this;this.projectName=a;this.leaveAllRooms();this.joinRoom(a);p.newProject(a,function(a){b.project=a;b.project.getImport(function(a,c){b.emit("updateImport",{Import:a,ImportDef:c});b.emit("updateGamePort",b.project.getPort())})})},__class__:H});var d=function(){var a=d.http.createServer(r(this,this.response));a.listen(d.cfg.port,
d.cfg.host);a.on("error",function(a){d.debug("Server::Error",a)});try{this.initSocket(a,r(this,this.onSocketReady))}catch(b){d.debug("Server::SOCKET error",b)}};d.__name__=!0;d.main=function(a){d.http=q.Node.require("http");d.fs=q.Node.require("fs");d.sio=q.Node.require("socket.io");d.path=q.Node.require("path");d.sys=q.Node.require("util");d.child=q.Node.require("child_process");d.os=q.Node.require("os");var b;try{b=q.Node.require("./config.js").config}catch(c){d.debug("reading config failed, continue with default config",
c),b=q.Node.require("./configDefault.js").config}a&&(b=m.mergeObjects(a,b));d.cfg=b;d.fs.exists||(d.fs.exists=d.path.exists);d.fs.exists(d.path.resolve(d.cfg.tmpPath),function(a){a||(new n).mkdir(d.path.resolve(d.cfg.tmpPath),d.emptyFn)})};d.emptyFn=function(){};d.mkzip=function(a,b,c){var e=new (q.Node.require("node-native-zip")),f=new n;f.filterFn=r(f,f.filterDirs);f.collectSources(b,function(f){for(var i=Object.keys(f),h=0;h<i.length;){var l=i[h];++h;e.add(l.substring(b.length+1),f[l])}d.fs.writeFile(a,
e.toBuffer(),function(){c("ZIP DONE")})})};d.unzip=function(a,b,c){d.debug("unzip to:",b);var e=q.Node.require("zip"),f=new n;d.fs.readFile(a,function(a,i){var h=e.Reader(i);h.toObject();var l=new z(0,function(){null!=c&&c()});h.forEach(function(a){var c=a.getName(),e=c.split("/");e.pop();e=b+"/"+e.join("/");l.add();f.mkdir(e,function(){var e=a.getData();d.fs.writeFile(b+"/"+k.string(c),e,r(l,l.done))})});var t;t=h instanceof Array?function(){return v.iter(h)}:"function"==typeof h.iterator?r(h,h.iterator):
h.iterator;t()})};d.handleError=function(a,b,c){c.setHeader("Content-Type","text/plain");c.writeHead(404);c.write("Error");c.write(a+"\r\n<br />");c.write(u.Json.stringify(b));c.write("\r\n");c.end("Not found\n")};d.getMime=function(a){return d.cfg.mimes[a]};d.getExt=function(a){return a.substring(a.lastIndexOf(".")+1)};d.getUrlParams=function(a){for(var a=a.substring(a.lastIndexOf("?")+1).split("&"),b={},c=0;c<a.length;){var e=a[c];++c;var d=e.indexOf("=");b[e.substring(0,d)]=e.substring(d+1)}return b};
d.debug=function(a,b,c){console.log("\n");console.log(a);null!=b&&console.log(b);null!=c&&console.log(c)};d.checkAndSave=function(a,b,c){null==c&&(c=1);a=d.path.normalize(a);d.fs.exists(a,function(e){if(e){var e=d.path.normalize(a).split(d.path.sep),f=e.pop(),g=f.split("."),i="";1<g.length&&(i="."+g.pop(),f=g.join("."));var g=c+"",h=f.substring(f.length-g.length,f.length),h=parseInt(h);d.debug("New i = ",h+1);isNaN(h)||(c=h+1);1<c&&(g=c+"",f=f.substring(0,f.length-g.length));d.debug("Checking fileName",
f,g);e=k.string(e.join(d.path.sep)+d.path.sep)+f+c+i;d.checkAndSave(e,b,++c)}else b(a)})};d.mkTempName=function(a){a=a.split(".");a.splice(a.length-1,0,m.getTime());return a.join(".")};d.prototype={onDirectoryRequest:function(){},onFileNotFound:function(){},onHttpRequest:function(){return!1},onSocketReady:function(){},initSocket:function(a,b){d.io=d.sio.listen(a);d.io.set("log level",d.cfg.logLevel);d.io.set("transports",["websocket","jsonp-polling","htmlfile","xhr-polling"]);d.io.set("close timeout",
9E3);d.io.sockets.on("connection",b)},streamFile:function(a,b,c){var e=d.fs.createReadStream(a);try{e.on("open",function(){c.setHeader("Content-Type",d.getMime(b));c.setHeader("Connection","keep-alive");c.writeHead(200);e.pipe(c)}),e.on("error",function(){c.writeHead(404);c.end("ERROR")})}catch(f){d.debug("Server::Error get filename",a)}},stat:function(a,b,c,e,f,g){var i=this;d.fs.stat(a,function(c,l){null!=c?f(l):l.isDirectory()?g(l):1E5>l.size?d.fs.readFile(a,function(c,f){null!=c?d.handleError(a,
c,e):(e.setHeader("Content-Type",d.cfg.mimes[b]),e.setHeader("Connection","keep-alive"),e.writeHead(200),e.end(f))}):i.streamFile(a,b,e)})},getFile:function(a,b,c,e,f){null==f&&(f=0);var g=this;d.cfg.webRoot.length==f?(d.debug("File not found",d.path.resolve(a,d.cfg.webRoot[f-1]+a)),this.onFileNotFound(b,c,a,d.cfg.webRoot[f-1])):this.stat(d.cfg.webRoot[f]+a,e,b,c,function(){d.cfg.webRoot.length>f-1&&g.getFile(a,b,c,e,++f)},function(){g.onDirectoryRequest(b,c,a)})},response:function(a,b){var c=a.url.indexOf("?"),
e=a.url,d="";-1<c&&(e=a.url.substring(0,c));this.onHttpRequest(a,b,e)||("/"==e?(e="/index.html",d="html"):d=e.substring(e.lastIndexOf(".")+1),b.setHeader("Access-Control-Allow-Origin","*"),this.getFile(e,a,b,d))},__class__:d};var Q=function(){};Q.__name__=!0;var w=function(){var a=this;d.call(this);(new n).rmA(d.cfg.tmpPath,function(){a.openBrowser()},!0)};w.__name__=!0;w.__interfaces__=[Q];w.main=function(){d.main();d.ImportSrc=d.fs.readFileSync("Import.js","utf-8");p.exTools=q.Node.require("../client/js/tools/tools.js").Tools;
p.exOtito=q.Node.require("../client/js/tools/otito.js").Otito;global.Tools=m;new w;d.fs.writeFile(".pidfile",process.pid);x.addAction("itemImage",{start:function(a){return k.string(d.cfg.projectPath)+"/"+a.project+"/.editor/upload/"},finish:function(a,b){var c={success:!0,file:a.substring(a.lastIndexOf(d.path.sep)+1)};b.write(u.Json.stringify(c));b.end()}});x.addAction("importProject",{start:function(){return k.string(d.cfg.tmpPath)+"/"},finish:function(a,b){p.importProject(a,function(a){b.write(u.Json.stringify(a));
b.end()})}});process.on("exit",function(){console.log("About to exit.");w.exit()});process.on("SIGINT",function(){w.exit();process.exit(0)})};w.exit=function(){p.stopAll()};w.__super__=d;w.prototype=O(d.prototype,{openBrowser:function(){if(d.cfg.openBrowser){var a=d.os.platform(),b="http://"+(d.cfg.host?d.cfg.host:"localhost")+":"+k.string(d.cfg.port);d.debug("opening browser",a,b);switch(a){case "linux":d.child.exec("xdg-open "+b);break;case "win":case "win32":case "win64":d.child.exec("cmd /c start "+
b);break;default:d.child.exec("open "+b)}}},onSocketReady:function(a){new H(a)},onDirectoryRequest:function(a,b,c){this.getFile(c+"index.html",a,b,"html")},onFileNotFound:function(a,b,c){new G(a,b,c)},onHttpRequest:function(a,b,c){return"/upload"==c?(new x(a,b),!0):-1<c.indexOf("level.php")?(new G(a,b,c),!0):!1},__class__:w});var L=function(a,b,c){this.isFailed=!1;var e=k.string(d.cfg.editorPath)+"/Import.json";this.project=c;this.path=a;this.fileName=a+"/"+e;this.isLoading=!1;this.stack=new I("Import");
this.read(b)};L.__name__=!0;L.prototype={eval:function(a){this.isFailed=!1;var b=q.Node.require("vm"),c=null,c={Import:this.Import,ImportOrig:{},ImportDef:{},ImportDefRaw:{},RawImport:{},console:console},e=b.createContext(c);b.runInContext(d.ImportSrc,e,"");for(var f=Object.keys(a),g,i,h,l=[],t=0;t<f.length;){var k=f[t];++t;try{b.runInContext(a[k],e,k)}catch(j){h=j.stack,h.replace("\r\n","\n"),i=h.split("\n"),g=i[1].substring(i[1].indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+1),-1==h.indexOf(k)&&
(g=k.substring(k.indexOf(d.cfg.projectPath)+d.cfg.projectPath.length+1)),l.push({error:i[0],file:g})}}b.runInContext("try{this.FixImport();}catch(e){console.log('error',e);}",e,"");0<l.length&&this.project.emitAll("importError",l);this.Import=c.ImportOrig;this.ClientImport=m.enumsToStrings(this.Import,"Import");this.ImportDef=c.ImportDef;this.ImportDefRaw=c.ImportDefRaw;this.isLoading=!1;this.stack.run().release()},update:function(a){var b=this;d.debug("Import update...");if(this.isLoading)this.stack.add(a);
else{this.isLoading=!0;var c=new n;c.filterFn=r(c,c.filterEditorJs);c.collectSources(this.path,function(c){b.eval(c);null!=a&&a()})}},get:function(a){var b=this;this.isLoading?this.stack.add(function(){b.get(a)}):this.isFailed||a(this.ClientImport,this.ImportDef,this.Import,this.ImportDefRaw)},read:function(a){this.isLoading||(this.Import={},this.update(a))},__class__:L};var n=function(a){null==a&&(a=!1);this.jobs=0;this.fs=d.fs;this.isDebug=a};n.__name__=!0;n.cp=function(a,b,c){var e=!1,f=function(a){e||
(null!=c&&c(a),e=!0)},g=d.fs.createReadStream(a);g.on("error",function(c){d.debug("FS::cp -> src error",c,a);d.debug("FS::cp",a,b);f(c)});var i=d.fs.createWriteStream(b);i.on("error",function(c){d.debug("FS::cp -> dst error",c);d.debug("FS::cp",a,b);f(c)});i.on("close",function(){f(null)});g.pipe(i)};n.prototype={rmDirs:function(a,b,c){null==c&&(c=1);var e=this;a.length<c?b():this.fs.rmdir(a[a.length-c],function(){e.rmDirs(a,b,++c)})},rmFiles:function(a,b,c){null==c&&(c=1);var e=this;if(c>a.length)b();
else try{this.fs.unlink(a[a.length-c],function(){e.rmFiles(a,b,++c)})}catch(f){d.debug("FS->rmFiles: Error:",f)}},rmA:function(a,b,c){null==c&&(c=!1);var e=this;this.fs.lstat(a,function(f,g){if(null!=f)d.debug("FS::rm -> error:",f),b();else if(g.isDirectory()){var i=[],h=[];e.filterFn=function(a,b,c){c.isDirectory()?h.push(b):i.push(b);return!0};e.scanDir(a,function(){e.rmFiles(i,function(){e.rmDirs(h,function(){c?b():e.fs.rmdir(a,function(c){null!=c&&(d.debug("WARNING!! FS::rm->rmdir -> failed to remove dir",
a),d.debug(c));b()})})})})}else e.fs.unlink(a,b)})},mkdir:function(a,b){var c=a.split("/"),e="",f=new z(1,b),g=function(a){if(a>=c.length)f.done();else{var b=e+=c[a]+"/";d.fs.exists(b,function(c){c?g(++a):d.fs.mkdir(b,function(c){null!=c&&d.debug("FS::mkdir FAILED to create dir:",b,c);g(++a)})})}};g(0)},copyFiles:function(a,b,c,e,d){null==d&&(d=0);var g=this;if(d>=c.length)e();else{var i=c[d];"."==i||".."==i?this.copyFiles(a,b,c,e,++d):this.copy(a+"/"+i,b+"/"+i,function(){g.copyFiles(a,b,c,e,++d)})}},
copy:function(a,b,c){var e=this,f=new z(1,function(){null!=c&&c()});this.fs.lstat(a,function(c,i){null!=c?(d.debug("FS::copy::stat failed",c),f.done()):i.isDirectory()?e.fs.mkdir(b,function(c){null!=c?(d.debug("copy::mkdir failed",b),e.mkdir(b,function(){e.fs.readdir(a,function(c,g){null!=c?(d.debug("FS::copy::readdir",c),f.done()):e.copyFiles(a,b,g,function(){f.done()})})})):e.fs.readdir(a,function(c,g){null!=c?(d.debug("FS::copy::readdir",c),f.done()):e.copyFiles(a,b,g,function(){f.done()})})}):
n.cp(a,b,function(a){null!=a&&d.debug("FS::cp -> ERROR",a);f.done()})})},collectFiles:function(a,b){var c={},e=a.length;if(0==e)b(c);else for(var d=0;d<a.length;){var g=[a[d]];++d;this.fs.readFile(g[0],function(a){return function(d,f){c[a[0]]=f;e--;0==e&&b(c)}}(g))}},scanDirShallow:function(a,b,c){var e=this;null==c&&(c=[]);this.jobs++;this.fs.readdir(a,function(f,g){if(null!=f)d.debug("failed to read dir",a);else{for(var i=0;i<g.length;){var h=[g[i]];++i;if(!("."==h[0]||".."==h[0])){var l=[a+"/"+
h[0]];e.jobs++;e.fs.lstat(l[0],function(a,f){return function(g,h){null!=g?d.debug("failed to stat file",a[0]):(!0!=e.filterFn(f[0],a[0],h)&&c.push(a[0]),e.jobs--,e.isDebug&&d.debug("FS:Jobs:",e.jobs),0==e.jobs?(e.isDebug&&d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&(d.debug("Jobs < 0",e.jobs),null!=b&&b(c)))}}(l,h))}}e.jobs--;e.isDebug&&d.debug("FS:Jobs:",e.jobs);0==e.jobs?(e.isDebug&&d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&(d.debug("Jobs < 0",e.jobs),null!=b&&b(c))}})},
scanDirFilterDirs:function(a,b,c){var e=this;null==c&&(c=[]);this.jobs++;this.fs.readdir(a,function(f,g){if(null!=f)d.debug("failed to read dir",a);else{for(var i=0;i<g.length;){var h=[g[i]];++i;if(!("."==h[0]||".."==h[0])){var l=[a+"/"+h[0]];e.jobs++;e.fs.lstat(l[0],function(a,f){return function(g,h){null!=g?d.debug("FS::scanDir","failed to stat file",a[0]):!1!=e.filterFn(f[0],a[0],h)&&(h.isDirectory()&&e.scanDir(a[0],b,c),c.push(a[0]));e.jobs--;e.isDebug&&d.debug("FS:Jobs:",e.jobs);0==e.jobs?(e.isDebug&&
d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&(d.debug("Jobs < 0",e.jobs),null!=b&&b(c))}}(l,h))}}e.jobs--;e.isDebug&&d.debug("FS:Jobs:",e.jobs);0==e.jobs?(e.isDebug&&d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&(d.debug("Jobs < 0",e.jobs),null!=b&&b(c))}})},scanDirR:function(a,b,c){var e=this;null==c&&(c=[]);this.jobs++;this.fs.readdir(a,function(f,g){if(null!=f)d.debug("failed to read dir",a);else{for(var i=0;i<g.length;){var h=[g[i]];++i;if(!("."==h[0]||".."==h[0])){var l=
[a+"/"+h[0]];e.jobs++;e.fs.stat(l[0],function(a,f){return function(g,h){null!=g?d.debug("failed to stat file",a[0]):(h.isDirectory()&&e.scanDir(a[0],b,c),!0!=e.filterFn(f[0],a[0],h)&&c.push(a[0]),e.jobs--,e.isDebug&&d.debug("FS:Jobs:",e.jobs),0==e.jobs?(e.isDebug&&d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&(d.debug("Jobs < 0",e.jobs),null!=b&&b(c)))}}(l,h))}}e.jobs--;e.isDebug&&d.debug("FS:Jobs:",e.jobs);0==e.jobs?(e.isDebug&&d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&
(d.debug("Jobs < 0",e.jobs),null!=b&&b(c))}})},scanDir:function(a,b,c){var e=this;null==c&&(c=[]);this.jobs++;this.fs.readdir(a,function(f,g){if(null!=f)d.debug("failed to read dir",a);else{for(var i=0;i<g.length;){var h=[g[i]];++i;if(!("."==h[0]||".."==h[0])){var l=[a+"/"+h[0]];e.jobs++;e.fs.lstat(l[0],function(a,f){return function(g,h){null!=g?d.debug("FS::scanDir","failed to stat file",a[0]):(h.isDirectory()&&e.scanDir(a[0],b,c),!0!=e.filterFn(f[0],a[0],h)&&c.push(a[0]));e.jobs--;e.isDebug&&d.debug("FS:Jobs:",
e.jobs);0==e.jobs?(e.isDebug&&d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&(d.debug("Jobs < 0",e.jobs),null!=b&&b(c))}}(l,h))}}e.jobs--;e.isDebug&&d.debug("FS:Jobs:",e.jobs);0==e.jobs?(e.isDebug&&d.debug("FS:Jobs:",b.toString()),null!=b&&b(c)):0>e.jobs&&(d.debug("Jobs < 0",e.jobs),null!=b&&b(c))}})},filterDirs:function(a,b,c){return c.isDirectory()},filterJs:function(a){return(new B(".*\\.js$","")).match(a)},filterEditorJs:function(a){return!(new B(".*\\.editor\\.js$","")).match(a)},
collectSources:function(a,b){var c=this;this.scanDirR(a,function(a){c.isDebug&&d.debug("Collected sources List",a);c.collectFiles(a,b)})},filterFn:function(){return!1},__class__:n};var M=function(){};M.__name__=!0;M.prototype={keys:function(){var a=[],b;for(b in this.h)this.h.hasOwnProperty(b)&&a.push(b.substr(1));return v.iter(a)},get:function(a){return this.h["$"+a]},__class__:M};var v=function(){};v.__name__=!0;v.cca=function(a,b){var c=a.charCodeAt(b);return c!=c?void 0:c};v.substr=function(a,
b,c){if(null!=b&&0!=b&&null!=c&&0>c)return"";null==c&&(c=a.length);0>b?(b=a.length+b,0>b&&(b=0)):0>c&&(c=a.length+c-b);return a.substr(b,c)};v.remove=function(a,b){for(var c=0,e=a.length;c<e;){if(a[c]==b)return a.splice(c,1),!0;c++}return!1};v.iter=function(a){return{cur:0,arr:a,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var z=function(a,b,c){null==c&&(c=!1);this.count=a;this.cb=b;this.debug=c};z.__name__=!0;z.prototype={add:function(a){null==
a&&(a=1);this.debug&&d.debug("Jobs::add",a);this.count+=a},done:function(){this.count--;this.debug&&d.debug("Jobs::done",this.count);0==this.count&&this.cb()},__class__:z};var N=function(a){this.hasChanged=!1;this.pollingTime=1E3;var b=this;this.path=a;this.isReady=!1;this.fs=d.fs;this.log=d.debug;this.stack=new I("DB");this.fs.exists(a,function(c){c?b.fs.readFile(a,"utf-8",function(a,c){if(a)b.log("DB corrupted",c),b.newDB();else try{b.data=u.Json.parse(c)}catch(d){b.newDB()}b.setReady()}):(b.newDB(),
b.setReady())});this.startPolling()};N.__name__=!0;N.prototype={poll:function(){this.stack.run().release();this.hasChanged&&this.save();u.Timer.delay(r(this,this.poll),this.pollingTime)},startPolling:function(){this.poll()},save:function(){this.hasChanged=!1;this.fs.writeFile(this.path,JSON.stringify(this.data,null,"\t"),"utf-8")},setReady:function(){this.isReady=!0;this.startPolling()},newDB:function(){this.log("DB:: Warning!","initializing new DB");this.data={1:{items:{},sub:[],name:"root",parent:0,
id:1},__auto_inc:1,__branch_id:1}},forceSave:function(){this.hasChanged=!0},getBranchName:function(a){this.data[a]||d.debug("JSON DB -> Bad branchId:",a);return this.data[a].name},getData:function(a){var b=this;this.isReady?a(this.data):this.stack.add(function(){b.getData(a)})},delItem:function(a,b,c){var e=this;if(this.isReady){var d=this.data[b].items[a];delete this.data[b].items[a];this.hasChanged=!0;c(d,this.getItem(a,b))}else this.stack.add(function(){e.delItem(a,b,c)})},newItem:function(a){var b=
this.data[a.branch].items;a.id=this.data.__auto_inc;this.data.__auto_inc++;this.log(this.data);b[a.id]=a;this.hasChanged=!0;return b},set:function(a,b,c){var e=this;if(this.isReady){var d;b.branch||(b.branch=1);null!=a?(b.id||(b.id=a),d=this.data[b.branch].items,d[a]=b):d=this.newItem(b);c([d[b.id]]);this.hasChanged=!0}else this.stack.add(function(){e.set(a,b,c)})},getItem:function(a,b){if(!b)return[];var c=this.data[b],e=c.items[a];return e?[e]:this.getItem(a,c.parent)},getItemsFilter:function(a,
b,c,e){null==c&&(c=[]);null==e&&(e={});if(!b)return c;for(var b=this.data[b],d=b.items,g=Object.keys(a),i=Object.keys(d),h,l,k=0;k<i.length;){var j=i[k];++k;h=d[j];l=!0;if(!e[j]){for(var m=0;m<g.length;){var p=g[m];++m;if(h[p]!=a[p]){l=!1;break}}l&&(e[j]=h,c.push(h))}}this.getItemsFilter(a,b.parent,c,e);return c},get:function(a,b,c){var e=this;if(this.isReady){var d;d=null!=b.branch?b.branch:1;var g=[];null!=a?c(this.getItem(a,d)):(delete b.branch,this.getItemsFilter(b,d,g),c(g))}else this.stack.add(function(){e.get(a,
b,c)})},getAllItems:function(a,b){var c=this;if(this.isReady)if(this.data[a]){var e=this.data[a].items;this.data[a].parent?this.collectBranchBuffer(a,b,{}):b(e)}else this.log("DB::AllItems -> failed to get branch",a,this.data);else this.stack.add(function(){c.getAllItems(a,b)})},collectBranchBuffer:function(a,b,c){for(var e=this.data[a].parent,a=this.data[a].items,d=Object.keys(a),g=0;g<d.length;){var i=d[g];++g;c[i]||(c[i]=a[i])}e?this.collectBranchBuffer(e,b,c):b(c)},collectBranches:function(a,
b){if(!this.data[a])return b;var c=this.data[a];null==c.name&&(c.name="Unnamed");for(var e={id:a,name:c.name,sub:[],parent:c.parent},c=c.sub,d=0;d<c.length;){var g=c[d];++d;e.sub.push(this.collectBranches(g))}return null!=b?(b.push(e),b):e},deleteBranch:function(a){var b=this.data[a],c=b.sub,e=this.data[b.parent].sub;v.remove(e,a);for(var d=0;d<c.length;){var g=c[d];++d;this.data[g].parent=b.parent;e.push(g)}delete this.data[a]},updateBranch:function(a){var b=this.data[a.id];b.id=a.id;b.name=a.name;
var c=this.data[b.parent],e=this.data[a.parent];null!=c&&(e=e.sub,v.remove(c.sub,a.id),e.push(a.id),b.parent=a.parent)},newBranch:function(a){this.data.__branch_id++;this.data[this.data.__branch_id]={items:{},name:a.name,sub:[],parent:a.parent,id:this.data.__branch_id};this.data[a.parent].sub.push(this.data.__branch_id);return this.data.__branch_id},setBranch:function(a,b){var c=this;this.isReady||this.stack.add(function(){c.setBranch(a,b)});var e=a.id;null==a.id?e=this.newBranch(a):this.updateBranch(a);
this.hasChanged=!0;b(e)},getBranchesTree:function(a,b){var c=this;if(this.isReady){null==a&&(a=1);var e=this.collectBranches(a,[]);b(e)}else this.stack.add(function(){c.getBranchesTree(a,b)})},__class__:N};var D=function(a,b,c,e,d){this.inProgress=!1;this.itemType=b;this.cfg=c;this.project=a;this.path=e;this.origin=d;this.nameBuffer={};this.newPlugins=[];this.update()};D.__name__=!0;D.prototype={"delete":function(a){var b=this.nameBuffer[a];null==b?d.debug("Plugins::Delete -> Item not found",a):(b.editor.color=
"#ff0000",b.editor.type=this.itemType,b.disabled=1,this.project.setItem({data:b,id:b.id,branch:b.editor.branch,type:this.itemType},function(a){d.debug("Plugins::Delete -> Item updated",a)}))},updateFS:function(a){var b=this,c=this;d.fs.readdir(d.path.resolve(this.path),function(e,f){if(e)d.debug("Plugins::updateFS Failed to read dir",b.path,e);else{for(var g=0;g<f.length;){var i=f[g];++g;D.nameReg.match(i)&&(c.nameBuffer[i]||b.genNew(i,b.origin))}for(var h=Object.keys(c.nameBuffer),k=!1,g=0;g<h.length;){var j=
h[g];++g;k=!1;if(!0!=k){for(var m=0;m<f.length;)i=f[m],++m,j==i?k=!0:c.nameBuffer[j].editor.origin!=b.origin&&(k=!0);!0!=k&&(d.debug("Cannot find:",j,"deleteing...."),b["delete"](j))}}null!=a&&a()}})},update:function(a){var b=this;this.inProgress?d.debug("Plugins.. in progress"):(this.inProgress=!0,this.nameBuffer={},this.project.getItems({where:{type:this.itemType,branch:1}},function(c){for(var e=0;e<c.length;){var d=c[e];++e;b.nameBuffer[d.name]=d}b.updateFS(function(){null!=a&&a();b.inProgress=
!1})}))},genNew:function(a,b){null==b&&(b="Core");var c=this;d.debug("NEW ITEM",a,b);this.project.getImport(function(e,d){var g,i={id:null,name:a};g="Addon"==c.itemType?p.exTools.createAddonMeta(i,e,d):p.exTools.createPluginMeta(i,e,d);g=p.genOtito(i,g).object;i={data:null,id:null,type:c.itemType,branch:1};i.data=g;i.data.name=a;i.data.editor={group:b,type:c.itemType,origin:b};c.project.setItem(i,function(a){c.nameBuffer[a.name]=a[0]})})},__class__:D};var p=function(a,b){null==b&&(b=!1);this.respawnServer=
!0;this.deployInProgress=!1;this.startServerRetries=0;this.removing=this.broken=!1;p.loaded.push(this);0==p.nextPort&&(p.nextPort=d.cfg.port);this.name=a;this.path=d.path.normalize(k.string(d.cfg.projectPath)+"/"+this.name).split("\\").join("/");this.privatePath=this.path+"/"+k.string(d.cfg.editorPath);this.enginePath=this.path+"/"+k.string(d.cfg.enginePath);this.pluginsPath=this.path+"/"+k.string(d.cfg.pluginsPath);this.enginePluginsPath=this.enginePath+"/"+k.string(d.cfg.enginePluginsPath);this.addonsPath=
this.path+"/"+k.string(d.cfg.addonsPath);this.Import=new L(this.path,r(this,this.checkItems),this);this.db=new N(this.privatePath+"/DB.json");this.plugins=new D(this,d.cfg.pluginType,"Cfg",this.getPluginsPath(),this.name);this.addons=new D(this,d.cfg.addonType,"Addon",this.getAddonsPath(),this.name);this.enginePlugins=new D(this,d.cfg.pluginType,"Cfg",this.enginePluginsPath,"Core");this.watchFiles();!b&&!d.cfg.demoMode&&this.startServer();this.broken=b;this.onStopServer=d.emptyFn};p.__name__=!0;p.genOtito=
function(a,b){return new p.exOtito(a,b)};p.importProject=function(a,b){var c=a.split(d.path.sep).pop().split(".").shift();d.checkAndSave(k.string(d.cfg.projectPath)+"/"+c,function(c){var f=c.split(d.path.sep).pop();d.unzip(a,c,function(){b({success:!0,file:f})})})};p.newProject=function(a,b){var c=p.getProject(a);null!=c?b(c):d.fs.exists(k.string(d.cfg.projectPath)+"/"+a,function(c){c?b(new p(a)):(b(new p(a,!0)),d.debug("Trying to load non existent project!!!"))})};p.getProject=function(a){for(var b=
0,c=p.loaded;b<c.length;){var d=c[b];++b;if(d.name==a)return d}return null};p.rmProject=function(a,b){var c=p.getProject(a);null!=c&&c.stop(b)};p.stopAll=function(){d.debug("Project::stopAll - stopping childs");for(var a=0,b=p.loaded;a<b.length;){var c=b[a];++a;c.stop(function(){d.debug("Project node stopped")})}};p.prototype={getPort:function(){return this.port},getAddonsType:function(){return this.addons.itemType},getPluginsType:function(){return this.plugins.itemType},getPrivatePath:function(){return this.privatePath},
getAddonsPath:function(){return this.addonsPath},getPluginsPath:function(){return this.pluginsPath},getPath:function(){return this.path},getBranchName:function(a){return this.db.getBranchName(a)},stopServer:function(a){this.respawnServer=!1;this.onStopServer=a?a:d.emptyFn;if(null!=this.gameServer)this.gameServer.kill();else this.onStopServer()},startServerReal:function(a){var b=this,a={cwd:a,env:process.env};try{this.gameServer=d.child.spawn("node",["server.js",""+p.nextPort],a),this.gameServer.on("exit",
function(a){b.onStopServer();d.debug("Project::Gameserver -> process exited with code "+a);b.respawnServer&&(d.debug("respawning server"),b.startServer())}),this.gameServer.stdout.on("data",function(a){"setNextPort"==a.toString().trim()&&b.startServer()}),this.gameServer.stderr.on("data",function(a){d.debug("Project::Gameserver ERROR ->\r\n--------------------",a.toString().replace("\n","\n\t")+"\r\n--------------------------------------")})}catch(c){this.respawnServer=!1,d.debug("Project::startServer -> Error spawning child",
c),this.emitAll("Error","Failed to spwn child!")}u.Timer.delay(function(){b.emitAll("updateGamePort",b.port)},1E3)},startServer:function(){var a=this;p.nextPort++;this.startServerRetries++;if(5<this.startServerRetries)this.emitAll("error","error_spawn_game_server::not_starting");else{this.port=p.nextPort;var b=d.path.resolve(this.path+"/server");d.debug("Project::StartServer -> starting","server.js:"+p.nextPort);d.fs.exists(b+"/server.js",function(c){c?a.startServerReal(b):(d.debug("Project::Gameserver -> server.js not found"),
a.emitAll("error","error_spawn_game_server::not_found"))})}},stop:function(a){v.remove(p.loaded,this);this.removing=!0;this.watcher&&this.watcher.stop();this.stopServer(a)},updatePlugins:function(a){var b=this;this.enginePlugins.update(function(){b.plugins.update(function(){b.addons.update(a)})})},onSourceChanged:function(a,b,c){var e=this;d.debug("Watcher event...",c);this.removing||this.Import.update(function(){e.updatePlugins(r(e,e.checkItems))})},watchFiles:function(){var a=this;d.fs.stat(this.path,
function(b){if(null!=b)d.debug("Project::watchFiles::Stat -> FATAL ERROR",b);else try{d.debug("Watching files"),a.watcher=d.cfg.engineDevMode?new F(a.path,r(a,a.onSourceChanged)):new F(a.path+"/src",r(a,a.onSourceChanged))}catch(c){d.debug("Project::watcher -> failed",c)}})},emitAll:function(a,b){C.emitAllStatic(a,b,this.name)},"export":function(a){var b=d.path.resolve(k.string(d.cfg.projectPath)+"/"+this.name),c=b+"/.editor/"+this.name+"."+k.string(d.cfg.projectExtension);d.fs.exists(c,function(e){e?
d.fs.unlink(c,function(){d.mkzip(c,b,a)}):d.mkzip(c,b,a)})},deploy:function(a,b,c){var e=this;d.debug("Project -> Deploy started",a);this.deployInProgress?(d.debug("Project -> Deploy in progress..."),null!=b&&b()):(this.deployInProgress=!0,new K(this,a,function(a){e.deployInProgress=!1;null!=b&&b(a)},c))},checkAllItems:function(a){var b=this,c=[];this.Import.get(function(e,f){p.exOtito.setImport(e);p.exOtito.setImportDef(f);b.db.getData(function(a){var b=Object.keys(a);v.remove(b,"__auto_inc");v.remove(b,
"__branch_id");for(var h={},k=0;k<b.length;){var j=b[k];++k;for(var j=a[j].items,q=Object.keys(j),s=0;s<q.length;){var r=q[s];++s;var n=j[r].data;if(!n){d.debug("BROKEN DB!!!!!!!!!!!!!!!!!!!!!!!!",r);return}!n.editor||!n.editor.type?d.debug("Project -> check -> List: skipping item",n):(h[n.editor.type]||(h[n.editor.type]=m.inArray(d.cfg.noEmptyValue,n.editor.type)?{}:{"0":""}),h[n.editor.type][r]=n)}p.exOtito.setLists(h);for(s=0;s<q.length;){r=q[s];++s;var n=j[r].data,u=null;if(n.editor){if("Plugin"==
n.editor.type)u=p.exTools.createPluginMeta(n,e,f);else if("Addon"==n.editor.type)u=p.exTools.createAddonMeta(n,e,f);else{if(!n.editor.plugin)continue;u=p.exTools.createMeta(n,null,null,e,f)}n=p.genOtito(n,u);n.isChanged&&(c.push(n.object),j[r].data=n.object)}}}});0<c.length&&b.db.forceSave();b.emitAll("itemsChanged",c);null!=a&&a(c)})},checkItems:function(){d.debug("checking Items...");this.checkAllItems();d.debug("checking Items... DONE")},resolveEnums:function(a,b){var c=Object.keys(a),e;e=m.isArray(a)?
[]:{};for(var f=0;f<c.length;){var g=c[f];++f;var i=a[g],h=typeof i;"object"==h&&i?e[g]=this.resolveEnums(i,b):"string"!=h?e[g]=i:0!=i.indexOf(m.enumStr)?e[g]=m.isNumber(i)?parseFloat(i):i:(h=m.resolveEnums(i,b),null==h?d.debug("Project::resolve enums -> Cannot resolve enum!!!",i):e[g]=h)}return e},fixAllItems:function(a){for(var b=[],c=Object.keys(a),d,f=0;f<c.length;)d=c[f],++f,d=a[d],b.push(this.fixItem(d));return b},fixItems:function(a){for(var b=[],c=0;c<a.length;){var d=a[c];++c;b.push(this.fixItem(d))}return b},
fixItem:function(a){if(!a)return null;a.data.id=a.id;a.data.editor.branch=a.branch;a.data.editor.type=a.type;return a.data},deleteBranch:function(a,b){this.db.deleteBranch(a);b()},setBranch:function(a,b){var c=this;this.db.setBranch(a,function(a){c.deploy({branch:a},function(){c.getBranchesTree(1,b)})})},getBranchesTree:function(a,b){this.db.getBranchesTree(a,b)},delItemReal:function(a,b){var c=this;this.db.delItem(a.id,a.branch,function(d,f){c.checkItems();var g=c.fixItem(d),i=c.fixItems(f);b(g,
i);(null==f||0==f.length)&&c.emitAll("itemDeleted",g);c.emitAll("itemsChanged",i);c.updatePlugins(function(){c.deploy({branch:a.branch},null)})})},delItem:function(a,b){this.delItemReal(a,b)},setItem:function(a,b){var c=this;this.db.set(a.id,a,function(d){var f=c.fixItems(d);c.deploy({branch:a.branch},function(){b(f);c.emitAll("itemsChanged",f)})})},getAllItems:function(a,b){var c=this;this.db.getAllItems(a,function(a){b(c.fixAllItems(a))})},getItems:function(a,b){var c=this;this.db.get(a.id,a.where,
function(a){b(c.fixItems(a))})},getImport:function(a){this.Import.get(a)},isBroken:function(){return this.broken},__class__:p};var A=function(){};A.__name__=!0;A.field=function(a,b){var c=null;try{c=a[b]}catch(d){}return c};A.fields=function(a){var b=[];if(null!=a){var c=Object.prototype.hasOwnProperty,d;for(d in a)c.call(a,d)&&b.push(d)}return b};A.isFunction=function(a){return"function"==typeof a&&!(a.__name__||a.__ename__)};var I=function(a,b){null==b&&(b=!1);this.name=a;this.buffer=[];this.tmpBuffer=
[];this.isRunning=!1;this.debug=b};I.__name__=!0;I.prototype={release:function(){this.buffer.length=0;this.debug&&d.debug("Stack::Release",this.name);return this},runTmp:function(){this.debug&&d.debug("Stack::RunTMP",this.name,this.tmpBuffer.length);if(0==this.tmpBuffer.length)this.isRunning=!1;else{for(var a=0,b=this.tmpBuffer;a<b.length;){var c=b[a];++a;this.buffer.push(c)}this.tmpBuffer.length=0;this.isRunning=!1;this.run()}},run:function(){if(this.isRunning)return this;this.debug&&d.debug("Stack::Run",
this.name,this.buffer.length);this.isRunning=!0;for(var a=0,b=this.buffer;a<b.length;){var c=b[a];++a;c()}this.runTmp();return this},add:function(a){this.debug&&d.debug("Stack::Add",this.name,this.buffer.length);if(this.isRunning)return this.tmpBuffer.push(a),this;this.buffer.push(a);return this},__class__:I};var k=function(){};k.__name__=!0;k.string=function(a){return q.Boot.__string_rec(a,"")};k.parseInt=function(a){var b=parseInt(a,10);if(0==b&&(120==v.cca(a,1)||88==v.cca(a,1)))b=parseInt(a);return isNaN(b)?
null:b};k.parseFloat=function(a){return parseFloat(a)};var J=function(){this.b=""};J.__name__=!0;J.prototype={__class__:J};var m=function(){};m.__name__=!0;m.enumsToStrings=function(a,b){for(var c=Object.keys(a),d={},f=0;f<c.length;){var g=c[f];++f;d[g]="object"==typeof a[g]&&null!=a[g]?m.enumsToStrings(a[g],b+"."+k.string(g)):m.enumStr+b+"."+k.string(g)}return d};m.clone=function(a){var b;if(!a||"object"!=typeof a)return a;if(m.isArray(a)){b=[];for(var c=0;c<a.length;){var d=a[c];++c;"object"===
typeof d&&null!=d?b.push(m.clone(d)):b.push(d)}return b}b={};d=Object.keys(a);for(c=0;c<d.length;){var f=d[c];++c;var g=a[f];b[f]="object"===typeof g&&null!=g?m.clone(g):g}return b};m.mergeObjects=function(a,b){if(null==a)return m.clone(b);if(null==b)return m.clone(a);var c=m.clone(a);if("object"!=typeof b)return c;for(var d=Object.keys(b),f=0;f<d.length;){var g=d[f];++f;var i=E["typeof"](a[g]),h=E["typeof"](b[g]);null!=i?"undefined"!=h&&(c[g]=m.mergeObjects(c[g],m.clone(b[g]))):"undefined"==i&&(c[g]=
b[g])}return c};m.getType=function(a){return typeof a};m.resolveEnums=function(a,b){var c=a.substring(m.enumStr.length);return m.resolveObject(c,b)};m.resolveObject=function(a,b){var c=a.split(".");c.shift();for(var e=b,f=0;f<c.length;){var g=c[f];++f;e=e[g];if(null==e){d.debug("Tools::resolveObject Cannot resolve",a);break}}return e};m.inArray=function(a,b){for(var c=0;c<a.length;){var d=a[c];++c;if(d==b)return!0}return!1};m.splitInLines=function(a){return a.split("\r\n").join("\n").split("\r").join("\n").split("\n")};
m.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};m.isArray=function(a){return Array.isArray(a)};m.getTime=function(){return Date.now()};m.shellEscape=function(a){return a};var j={__ename__:!0,__constructs__:"TNull TInt TFloat TBool TObject TFunction TClass TEnum TUnknown".split(" "),TNull:["TNull",0]};j.TNull.toString=y;j.TNull.__enum__=j;j.TInt=["TInt",1];j.TInt.toString=y;j.TInt.__enum__=j;j.TFloat=["TFloat",2];j.TFloat.toString=y;j.TFloat.__enum__=j;j.TBool=["TBool",3];j.TBool.toString=
y;j.TBool.__enum__=j;j.TObject=["TObject",4];j.TObject.toString=y;j.TObject.__enum__=j;j.TFunction=["TFunction",5];j.TFunction.toString=y;j.TFunction.__enum__=j;j.TClass=function(a){a=["TClass",6,a];a.__enum__=j;a.toString=y;return a};j.TEnum=function(a){a=["TEnum",7,a];a.__enum__=j;a.toString=y;return a};j.TUnknown=["TUnknown",8];j.TUnknown.toString=y;j.TUnknown.__enum__=j;var E=function(){};E.__name__=!0;E["typeof"]=function(a){switch(typeof a){case "boolean":return j.TBool;case "string":return j.TClass(String);
case "number":return Math.ceil(a)==a%2147483648?j.TInt:j.TFloat;case "object":if(null==a)return j.TNull;var b=a.__enum__;if(null!=b)return j.TEnum(b);a=a.__class__;return null!=a?j.TClass(a):j.TObject;case "function":return a.__name__||a.__ename__?j.TObject:j.TFunction;case "undefined":return j.TNull;default:return j.TUnknown}};E.enumIndex=function(a){return a[1]};var x=function(a,b){var c=d.getUrlParams(a.url);if(null==c.action)b.end(),d.debug("upload without an action",c);else{var e=x.actions[c.action];
if(null==e)b.end(),d.debug("unknown action",c);else{var f=e.start(c)+c.qqfile,g=k.string(d.cfg.tmpPath)+"/"+d.mkTempName(c.qqfile),i=d.fs.createWriteStream(d.path.resolve(g));i.on("error",function(){d.debug("Uploader::WS - could not open writestream.",d.path.resolve(g))});i.on("close",function(){d.checkAndSave(f,function(a){d.debug("UPLOAD",a);(new n).copy(g,a,function(){b.writeHead(200,"OK",{"Content-Type":"text/html"});e.finish(a,b)})})});a.on("data",function(a){i.write(a)});a.on("end",function(){i.end()})}}};
x.__name__=!0;x.addAction=function(a,b){x.actions[a]=b};x.prototype={__class__:x};var u={Json:function(){}};u.Json.__name__=!0;u.Json.parse=function(a){return(new u.Json).doParse(a)};u.Json.stringify=function(a){return(new u.Json).toString(a)};u.Json.prototype={parseNumber:function(a){for(var b=this.pos-1,c=45==a,d=!c,f=48==a,g=!1,i=!1,h=!1,j=!1;;){a=this.str.charCodeAt(this.pos++);switch(a){case 48:f&&!g&&this.invalidNumber(b);c&&(c=!1,f=!0);d=!0;break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:f&&
!g&&this.invalidNumber(b);c&&(c=!1);d=!0;f=!1;break;case 46:(c||g)&&this.invalidNumber(b);d=!1;g=!0;break;case 101:case 69:(c||f||i)&&this.invalidNumber(b);d=!1;i=!0;break;case 43:case 45:(!i||h)&&this.invalidNumber(b);d=!1;h=!0;break;default:d||this.invalidNumber(b),this.pos--,j=!0}if(j)break}a=k.parseFloat(v.substr(this.str,b,this.pos-b));b=a|0;return b==a?b:a},invalidNumber:function(a){throw"Invalid number at position "+a+": "+v.substr(this.str,a,this.pos-a);},parseString:function(){for(var a=
this.pos,b=new J;;){var c=this.str.charCodeAt(this.pos++);if(34==c)break;if(92==c){b.b+=v.substr(this.str,a,this.pos-a-1);c=this.str.charCodeAt(this.pos++);switch(c){case 114:b.b+="\r";break;case 110:b.b+="\n";break;case 116:b.b+="\t";break;case 98:b.b+="\b";break;case 102:b.b+="\f";break;case 47:case 92:case 34:b.b+=String.fromCharCode(c);break;case 117:a=k.parseInt("0x"+v.substr(this.str,this.pos,4));this.pos+=4;b.b+=String.fromCharCode(a);break;default:throw"Invalid escape sequence \\"+String.fromCharCode(c)+
" at position "+(this.pos-1);}a=this.pos}else if(c!=c)throw"Unclosed string";}b.b+=v.substr(this.str,a,this.pos-a-1);return b.b},parseRec:function(){for(;;){var a=this.str.charCodeAt(this.pos++);switch(a){case 32:case 13:case 10:case 9:break;case 123:for(var b={},c=null,a=null;;){var d=this.str.charCodeAt(this.pos++);switch(d){case 32:case 13:case 10:case 9:break;case 125:return(null!=c||!1==a)&&this.invalidChar(),b;case 58:null==c&&this.invalidChar();b[c]=this.parseRec();c=null;a=!0;break;case 44:a?
a=!1:this.invalidChar();break;case 34:a&&this.invalidChar();c=this.parseString();break;default:this.invalidChar()}}break;case 91:b=[];for(a=null;;)switch(d=this.str.charCodeAt(this.pos++),d){case 32:case 13:case 10:case 9:break;case 93:return!1==a&&this.invalidChar(),b;case 44:a?a=!1:this.invalidChar();break;default:a&&this.invalidChar(),this.pos--,b.push(this.parseRec()),a=!0}break;case 116:a=this.pos;if(114!=this.str.charCodeAt(this.pos++)||117!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=
a,this.invalidChar();return!0;case 102:a=this.pos;if(97!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||115!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return!1;case 110:a=this.pos;if(117!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return null;case 34:return this.parseString();case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 45:return this.parseNumber(a);
default:this.invalidChar()}}},invalidChar:function(){this.pos--;throw"Invalid char "+this.str.charCodeAt(this.pos)+" at position "+this.pos;},doParse:function(a){this.str=a;this.pos=0;return this.parseRec()},quote:function(a){this.buf.b+='"';for(var b=0;;){var c=a.charCodeAt(b++);if(c!=c)break;switch(c){case 34:this.buf.b+='\\"';break;case 92:this.buf.b+="\\\\";break;case 10:this.buf.b+="\\n";break;case 13:this.buf.b+="\\r";break;case 9:this.buf.b+="\\t";break;case 8:this.buf.b+="\\b";break;case 12:this.buf.b+=
"\\f";break;default:this.buf.b+=String.fromCharCode(c)}}this.buf.b+='"'},toStringRec:function(a){var b=E["typeof"](a);switch(b[1]){case 8:this.buf.b+='"???"';break;case 4:this.objString(a);break;case 1:this.buf.b+=k.string(a);break;case 2:this.buf.b+=k.string(a+1==a?null:a);break;case 5:this.buf.b+='"<fun>"';break;case 6:b=b[2];if(b==String)this.quote(a);else if(b==Array){this.buf.b+="[";b=a.length;if(0<b){this.toStringRec(a[0]);for(var c=1;c<b;)this.buf.b+=",",this.toStringRec(a[c++])}this.buf.b+=
"]"}else if(b==M){b={};for(c=a.keys();c.hasNext();){var d=c.next();b[d]=a.get(d)}this.objString(b)}else this.objString(a);break;case 7:c=E.enumIndex(a);this.buf.b+=k.string(c);break;case 3:this.buf.b+=k.string(a);break;case 0:this.buf.b+="null"}},objString:function(a){this.fieldsString(a,A.fields(a))},fieldsString:function(a,b){var c=!0;this.buf.b+="{";for(var d=0;d<b.length;){var f=b[d];++d;var g=A.field(a,f);A.isFunction(g)||(c?c=!1:this.buf.b+=",",this.quote(f),this.buf.b+=":",this.toStringRec(g))}this.buf.b+=
"}"},toString:function(a){this.buf=new J;this.toStringRec(a);return this.buf.b},__class__:u.Json};u.Timer=function(a){var b=this;this.id=setInterval(function(){b.run()},a)};u.Timer.__name__=!0;u.Timer.delay=function(a,b){var c=new u.Timer(b);c.run=function(){c.stop();a()};return c};u.Timer.prototype={run:function(){},stop:function(){null!=this.id&&(clearInterval(this.id),this.id=null)},__class__:u.Timer};var q={Boot:function(){}};q.Boot.__name__=!0;q.Boot.__string_rec=function(a,b){if(null==a)return"null";
if(5<=b.length)return"<...>";var c=typeof a;if("function"==c&&(a.__name__||a.__ename__))c="object";switch(c){case "object":if(a instanceof Array){if(a.__enum__){if(2==a.length)return a[0];for(var c=a[0]+"(",b=b+"\t",d=2,f=a.length;d<f;)var g=d++,c=2!=g?c+(","+q.Boot.__string_rec(a[g],b)):c+q.Boot.__string_rec(a[g],b);return c+")"}d=a.length;c="[";b+="\t";for(f=0;f<d;)g=f++,c+=(0<g?",":"")+q.Boot.__string_rec(a[g],b);return c+"]"}try{f=a.toString}catch(i){return"???"}if(null!=f&&f!=Object.toString&&
(c=a.toString(),"[object Object]"!=c))return c;f=null;c="{\n";b+="\t";d=null!=a.hasOwnProperty;for(f in a)if(!d||a.hasOwnProperty(f))"prototype"==f||("__class__"==f||"__super__"==f||"__interfaces__"==f||"__properties__"==f)||(2!=c.length&&(c+=", \n"),c+=b+f+" : "+q.Boot.__string_rec(a[f],b));b=b.substring(1);return c+="\n"+b+"}";case "function":return"<function>";case "string":return a;default:return String(a)}};q.Node=function(){};q.Node.__name__=!0;Array.prototype.indexOf?v.remove=function(a,b){var c=
a.indexOf(b);if(-1==c)return!1;a.splice(c,1);return!0}:null;Math.__name__=["Math"];Math.NaN=Number.NaN;Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY;Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY;Math.isFinite=function(a){return isFinite(a)};Math.isNaN=function(a){return isNaN(a)};String.prototype.__class__=String;String.__name__=!0;Array.prototype.__class__=Array;Array.__name__=!0;"undefined"!=typeof JSON&&(u.Json=JSON);q.Node.__filename=__filename;q.Node.__dirname=__dirname;q.Node.setTimeout=
setTimeout;q.Node.clearTimeout=clearTimeout;q.Node.setInterval=setInterval;q.Node.clearInterval=clearInterval;q.Node.global=global;q.Node.process=process;q.Node.require=require;q.Node.console=console;q.Node.module=module;q.Node.stringify=JSON.stringify;q.Node.parse=JSON.parse;D.nameReg=new B("^[a-zA-Z]+[a-zA-Z0-9]*$","");p.nextPort=0;p.loaded=[];m.enumStr="__enum__.";x.actions={};w.main()})();
